-- ============================================================
-- CRM SUITE DATABASE SCHEMA
-- Complete customer relationship management for construction
-- ============================================================

-- ============================================================
-- 1. CRM CONTACTS (Clients, Prospects, Vendors, Subcontractors)
-- ============================================================
CREATE TABLE IF NOT EXISTS public.crm_contacts (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,

  -- CONTACT INFO
  first_name VARCHAR(100) NOT NULL,
  last_name VARCHAR(100) NOT NULL,
  full_name VARCHAR(255) GENERATED ALWAYS AS (first_name || ' ' || last_name) STORED,
  email VARCHAR(255),
  phone VARCHAR(50),
  mobile VARCHAR(50),

  -- COMPANY INFO
  company VARCHAR(255),
  job_title VARCHAR(100),
  website VARCHAR(255),

  -- ADDRESS
  street_address TEXT,
  city VARCHAR(100),
  state VARCHAR(50),
  zip_code VARCHAR(20),
  country VARCHAR(100) DEFAULT 'United States',

  -- CATEGORIZATION
  category VARCHAR(50) DEFAULT 'prospect', -- client, prospect, vendor, subcontractor, partner
  contact_type VARCHAR(50), -- homeowner, property_manager, developer, architect, gc
  lead_source VARCHAR(100), -- referral, website, trade_show, cold_call, advertisement
  tags TEXT[],

  -- CONSTRUCTION-SPECIFIC
  project_types_interested TEXT[], -- residential, commercial, renovation, new_construction
  preferred_contract_method VARCHAR(50), -- fixed_price, time_materials, cost_plus
  trade_specialties TEXT[], -- For subcontractors
  annual_volume DECIMAL(12,2), -- Estimated annual project volume
  territory VARCHAR(100),

  -- RELATIONSHIPS
  referred_by UUID REFERENCES public.crm_contacts(id),
  account_manager UUID REFERENCES auth.users(id),

  -- STATUS
  status VARCHAR(20) DEFAULT 'active', -- active, inactive, do_not_contact
  is_favorite BOOLEAN DEFAULT false,
  quality_score INTEGER CHECK (quality_score BETWEEN 1 AND 5), -- Lead quality rating

  -- COMMUNICATION PREFERENCES
  preferred_contact_method VARCHAR(20), -- email, phone, text, in_person
  best_time_to_contact VARCHAR(50),
  email_opt_in BOOLEAN DEFAULT true,
  sms_opt_in BOOLEAN DEFAULT false,

  -- FINANCIAL
  credit_limit DECIMAL(12,2),
  payment_terms VARCHAR(50), -- Net 30, Net 15, COD, etc.
  tax_id VARCHAR(50), -- EIN for businesses

  -- INTEGRATION
  integration_id UUID, -- Reference to user_integrations if synced from external system
  external_id VARCHAR(255), -- ID from QuickBooks, etc.
  sync_status VARCHAR(20), -- synced, pending, error
  last_sync_at TIMESTAMPTZ,

  -- METADATA
  notes TEXT,
  profile_image_url TEXT,
  social_media JSONB, -- {linkedin, facebook, instagram}
  custom_fields JSONB, -- Extensible for user-specific data

  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),

  -- CONSTRAINTS
  UNIQUE(user_id, email)
);

CREATE INDEX IF NOT EXISTS idx_crm_contacts_user ON public.crm_contacts(user_id);
CREATE INDEX IF NOT EXISTS idx_crm_contacts_email ON public.crm_contacts(email);
CREATE INDEX IF NOT EXISTS idx_crm_contacts_category ON public.crm_contacts(category);
CREATE INDEX IF NOT EXISTS idx_crm_contacts_status ON public.crm_contacts(status);
CREATE INDEX IF NOT EXISTS idx_crm_contacts_company ON public.crm_contacts(company);

-- ============================================================
-- 2. CRM LEADS PIPELINE
-- ============================================================
CREATE TABLE IF NOT EXISTS public.crm_leads (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
  contact_id UUID REFERENCES public.crm_contacts(id) ON DELETE CASCADE,

  -- LEAD INFO
  title VARCHAR(255) NOT NULL, -- "Kitchen Remodel - Smith Residence"
  description TEXT,

  -- PIPELINE STAGE
  stage VARCHAR(50) DEFAULT 'new', -- new, contacted, qualified, proposal_sent, negotiation, won, lost
  stage_order INTEGER, -- For custom stage ordering
  stage_changed_at TIMESTAMPTZ DEFAULT NOW(),

  -- VALUE & PROBABILITY
  estimated_value DECIMAL(12,2),
  probability INTEGER DEFAULT 50 CHECK (probability BETWEEN 0 AND 100),
  weighted_value DECIMAL(12,2) GENERATED ALWAYS AS (estimated_value * probability / 100) STORED,

  -- CONSTRUCTION-SPECIFIC
  project_type VARCHAR(100), -- residential_remodel, commercial_build, new_construction
  project_size VARCHAR(50), -- small (<50k), medium (50k-250k), large (250k+)
  square_footage INTEGER,
  estimated_duration_days INTEGER,
  preferred_start_date DATE,

  -- TRACKING
  lead_source VARCHAR(100),
  source_campaign VARCHAR(100), -- For marketing attribution
  assigned_to UUID REFERENCES auth.users(id),

  -- TIMELINE
  first_contact_date DATE,
  last_contact_date DATE,
  expected_close_date DATE,
  actual_close_date DATE,

  -- OUTCOME
  won_reason TEXT, -- Why we won
  lost_reason TEXT, -- Why we lost
  lost_to_competitor VARCHAR(255), -- Which competitor

  -- LINKED RECORDS
  quote_id UUID REFERENCES public.quotes(id), -- From QuoteHub
  project_id UUID REFERENCES public.projects(id), -- If converted to project

  -- STATUS
  is_active BOOLEAN DEFAULT true,
  priority VARCHAR(20) DEFAULT 'medium', -- low, medium, high, urgent
  confidence_level VARCHAR(20), -- low, medium, high

  -- FOLLOW-UP
  next_action VARCHAR(255),
  next_action_date DATE,
  reminder_set BOOLEAN DEFAULT false,

  -- METADATA
  notes TEXT,
  tags TEXT[],
  custom_fields JSONB,

  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_crm_leads_user ON public.crm_leads(user_id);
CREATE INDEX IF NOT EXISTS idx_crm_leads_contact ON public.crm_leads(contact_id);
CREATE INDEX IF NOT EXISTS idx_crm_leads_stage ON public.crm_leads(stage);
CREATE INDEX IF NOT EXISTS idx_crm_leads_assigned ON public.crm_leads(assigned_to);
CREATE INDEX IF NOT EXISTS idx_crm_leads_status ON public.crm_leads(is_active);

-- ============================================================
-- 3. CRM ACTIVITIES (Calls, Emails, Meetings, Site Visits)
-- ============================================================
CREATE TABLE IF NOT EXISTS public.crm_activities (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,

  -- ASSOCIATIONS
  contact_id UUID REFERENCES public.crm_contacts(id) ON DELETE CASCADE,
  lead_id UUID REFERENCES public.crm_leads(id) ON DELETE SET NULL,
  project_id UUID REFERENCES public.projects(id) ON DELETE SET NULL,

  -- ACTIVITY TYPE
  activity_type VARCHAR(50) NOT NULL, -- call, email, meeting, site_visit, quote_sent, proposal_sent, contract_signed
  activity_subtype VARCHAR(50), -- inbound_call, outbound_call, cold_call, follow_up

  -- DETAILS
  subject VARCHAR(255),
  description TEXT,

  -- SCHEDULING
  scheduled_date TIMESTAMPTZ,
  scheduled_duration_minutes INTEGER,
  actual_start_time TIMESTAMPTZ,
  actual_end_time TIMESTAMPTZ,
  actual_duration_minutes INTEGER,

  -- STATUS
  status VARCHAR(20) DEFAULT 'scheduled', -- scheduled, completed, cancelled, no_show
  is_completed BOOLEAN DEFAULT false,
  completed_at TIMESTAMPTZ,

  -- OUTCOME
  outcome VARCHAR(100), -- successful, unsuccessful, needs_follow_up, meeting_scheduled
  outcome_notes TEXT,
  sentiment VARCHAR(20), -- positive, neutral, negative

  -- FOLLOW-UP
  follow_up_required BOOLEAN DEFAULT false,
  follow_up_date DATE,
  follow_up_assigned_to UUID REFERENCES auth.users(id),

  -- LOCATION (for site visits, meetings)
  location VARCHAR(255),
  location_coordinates POINT, -- GPS coordinates

  -- PARTICIPANTS
  participants JSONB, -- [{user_id, name, role}]
  attendees_count INTEGER,

  -- COMMUNICATION TRACKING
  email_message_id TEXT, -- If synced from email integration
  email_thread_id TEXT,
  call_recording_url TEXT,
  call_duration_seconds INTEGER,

  -- METADATA
  priority VARCHAR(20) DEFAULT 'normal', -- low, normal, high
  is_billable BOOLEAN DEFAULT false,
  billable_amount DECIMAL(10,2),
  tags TEXT[],

  created_by UUID REFERENCES auth.users(id),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_crm_activities_user ON public.crm_activities(user_id);
CREATE INDEX IF NOT EXISTS idx_crm_activities_contact ON public.crm_activities(contact_id);
CREATE INDEX IF NOT EXISTS idx_crm_activities_lead ON public.crm_activities(lead_id);
CREATE INDEX IF NOT EXISTS idx_crm_activities_type ON public.crm_activities(activity_type);
CREATE INDEX IF NOT EXISTS idx_crm_activities_date ON public.crm_activities(scheduled_date);
CREATE INDEX IF NOT EXISTS idx_crm_activities_status ON public.crm_activities(status);

-- ============================================================
-- 4. CRM OPPORTUNITIES (Converted Leads / Active Deals)
-- ============================================================
CREATE TABLE IF NOT EXISTS public.crm_opportunities (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,

  -- SOURCE
  lead_id UUID REFERENCES public.crm_leads(id),
  contact_id UUID REFERENCES public.crm_contacts(id) NOT NULL,
  quote_id UUID REFERENCES public.quotes(id),

  -- OPPORTUNITY INFO
  opportunity_name VARCHAR(255) NOT NULL,
  description TEXT,

  -- PROJECT DETAILS
  project_id UUID REFERENCES public.projects(id), -- When opportunity converts to active project
  project_type VARCHAR(100),
  scope_of_work TEXT,

  -- FINANCIAL
  contract_value DECIMAL(12,2) NOT NULL,
  estimated_costs DECIMAL(12,2),
  estimated_profit DECIMAL(12,2) GENERATED ALWAYS AS (contract_value - COALESCE(estimated_costs, 0)) STORED,
  profit_margin DECIMAL(5,4) GENERATED ALWAYS AS (
    CASE WHEN contract_value > 0
    THEN (contract_value - COALESCE(estimated_costs, 0)) / contract_value
    ELSE 0 END
  ) STORED,

  -- TIMELINE
  start_date DATE,
  expected_completion_date DATE,
  actual_completion_date DATE,

  -- STATUS
  status VARCHAR(50) DEFAULT 'active', -- active, won, completed, on_hold, cancelled, lost
  stage VARCHAR(50), -- planning, permitting, construction, closeout
  completion_percentage INTEGER DEFAULT 0 CHECK (completion_percentage BETWEEN 0 AND 100),

  -- TEAM
  account_owner UUID REFERENCES auth.users(id),
  project_manager UUID REFERENCES auth.users(id),
  team_members UUID[],

  -- TRACKING
  win_date DATE,
  win_probability INTEGER CHECK (win_probability BETWEEN 0 AND 100),

  -- RISK FACTORS
  risk_level VARCHAR(20), -- low, medium, high
  risk_notes TEXT,

  -- METADATA
  notes TEXT,
  tags TEXT[],
  custom_fields JSONB,

  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_crm_opportunities_user ON public.crm_opportunities(user_id);
CREATE INDEX IF NOT EXISTS idx_crm_opportunities_contact ON public.crm_opportunities(contact_id);
CREATE INDEX IF NOT EXISTS idx_crm_opportunities_lead ON public.crm_opportunities(lead_id);
CREATE INDEX IF NOT EXISTS idx_crm_opportunities_status ON public.crm_opportunities(status);
CREATE INDEX IF NOT EXISTS idx_crm_opportunities_project ON public.crm_opportunities(project_id);

-- ============================================================
-- 5. CRM EMAIL TEMPLATES
-- ============================================================
CREATE TABLE IF NOT EXISTS public.crm_email_templates (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,

  -- TEMPLATE INFO
  template_name VARCHAR(255) NOT NULL,
  subject_line VARCHAR(500),
  body_html TEXT,
  body_plain TEXT,

  -- CATEGORIZATION
  category VARCHAR(50), -- follow_up, quote, proposal, thank_you, status_update
  is_system_template BOOLEAN DEFAULT false,
  is_active BOOLEAN DEFAULT true,

  -- USAGE
  use_count INTEGER DEFAULT 0,
  last_used_at TIMESTAMPTZ,

  -- VARIABLES (for personalization)
  available_variables JSONB, -- {contact_name, project_name, quote_total, etc.}

  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_crm_email_templates_user ON public.crm_email_templates(user_id);
CREATE INDEX IF NOT EXISTS idx_crm_email_templates_category ON public.crm_email_templates(category);

-- ============================================================
-- 6. CRM NOTES
-- ============================================================
CREATE TABLE IF NOT EXISTS public.crm_notes (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,

  -- ASSOCIATIONS
  contact_id UUID REFERENCES public.crm_contacts(id) ON DELETE CASCADE,
  lead_id UUID REFERENCES public.crm_leads(id) ON DELETE CASCADE,
  opportunity_id UUID REFERENCES public.crm_opportunities(id) ON DELETE CASCADE,
  activity_id UUID REFERENCES public.crm_activities(id) ON DELETE CASCADE,

  -- NOTE CONTENT
  note_type VARCHAR(50) DEFAULT 'general', -- general, follow_up, meeting_notes, phone_call
  content TEXT NOT NULL,

  -- METADATA
  is_pinned BOOLEAN DEFAULT false,
  is_private BOOLEAN DEFAULT false, -- Only visible to creator
  tags TEXT[],

  -- ATTACHMENTS
  attachments JSONB, -- [{filename, url, size, type}]

  created_by UUID REFERENCES auth.users(id),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_crm_notes_contact ON public.crm_notes(contact_id);
CREATE INDEX IF NOT EXISTS idx_crm_notes_lead ON public.crm_notes(lead_id);
CREATE INDEX IF NOT EXISTS idx_crm_notes_created_by ON public.crm_notes(created_by);

-- ============================================================
-- 7. CRM PIPELINE STAGES (Customizable)
-- ============================================================
CREATE TABLE IF NOT EXISTS public.crm_pipeline_stages (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,

  -- STAGE INFO
  stage_name VARCHAR(100) NOT NULL,
  stage_key VARCHAR(50) NOT NULL, -- Unique identifier for queries
  description TEXT,

  -- CONFIGURATION
  stage_order INTEGER NOT NULL,
  probability_default INTEGER DEFAULT 50,

  -- VISUAL
  color VARCHAR(7), -- Hex color code
  icon VARCHAR(50),

  -- AUTOMATION
  auto_actions JSONB, -- Actions to take when lead enters this stage
  required_fields TEXT[], -- Fields that must be filled before moving to next stage

  -- STATUS
  is_active BOOLEAN DEFAULT true,
  is_system_stage BOOLEAN DEFAULT false, -- Can't be deleted

  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),

  UNIQUE(user_id, stage_key)
);

CREATE INDEX IF NOT EXISTS idx_crm_pipeline_stages_user ON public.crm_pipeline_stages(user_id);
CREATE INDEX IF NOT EXISTS idx_crm_pipeline_stages_order ON public.crm_pipeline_stages(stage_order);

-- ============================================================
-- 8. CRM INTEGRATIONS LOG
-- ============================================================
CREATE TABLE IF NOT EXISTS public.crm_integration_sync_log (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,

  -- SYNC INFO
  integration_type VARCHAR(50), -- quickbooks, google_contacts, outlook, excel
  sync_direction VARCHAR(20), -- import, export, bidirectional

  -- RESULTS
  records_processed INTEGER DEFAULT 0,
  records_created INTEGER DEFAULT 0,
  records_updated INTEGER DEFAULT 0,
  records_failed INTEGER DEFAULT 0,

  -- STATUS
  status VARCHAR(20), -- running, completed, failed, partial
  error_message TEXT,
  error_details JSONB,

  -- TIMING
  started_at TIMESTAMPTZ DEFAULT NOW(),
  completed_at TIMESTAMPTZ,
  duration_seconds INTEGER,

  -- METADATA
  sync_config JSONB, -- Configuration used for this sync

  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_crm_sync_log_user ON public.crm_integration_sync_log(user_id);
CREATE INDEX IF NOT EXISTS idx_crm_sync_log_type ON public.crm_integration_sync_log(integration_type);
CREATE INDEX IF NOT EXISTS idx_crm_sync_log_date ON public.crm_integration_sync_log(created_at DESC);

-- ============================================================
-- 9. ENABLE ROW LEVEL SECURITY
-- ============================================================
ALTER TABLE public.crm_contacts ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.crm_leads ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.crm_activities ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.crm_opportunities ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.crm_email_templates ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.crm_notes ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.crm_pipeline_stages ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.crm_integration_sync_log ENABLE ROW LEVEL SECURITY;

-- ============================================================
-- 10. RLS POLICIES
-- ============================================================

-- CONTACTS
DROP POLICY IF EXISTS "Users manage their contacts" ON public.crm_contacts;
CREATE POLICY "Users manage their contacts"
  ON public.crm_contacts FOR ALL
  USING (user_id = auth.uid());

-- LEADS
DROP POLICY IF EXISTS "Users manage their leads" ON public.crm_leads;
CREATE POLICY "Users manage their leads"
  ON public.crm_leads FOR ALL
  USING (user_id = auth.uid());

-- ACTIVITIES
DROP POLICY IF EXISTS "Users manage their activities" ON public.crm_activities;
CREATE POLICY "Users manage their activities"
  ON public.crm_activities FOR ALL
  USING (user_id = auth.uid());

-- OPPORTUNITIES
DROP POLICY IF EXISTS "Users manage their opportunities" ON public.crm_opportunities;
CREATE POLICY "Users manage their opportunities"
  ON public.crm_opportunities FOR ALL
  USING (user_id = auth.uid());

-- EMAIL TEMPLATES
DROP POLICY IF EXISTS "Users manage their templates" ON public.crm_email_templates;
CREATE POLICY "Users manage their templates"
  ON public.crm_email_templates FOR ALL
  USING (user_id = auth.uid() OR is_system_template = true);

-- NOTES
DROP POLICY IF EXISTS "Users view their notes" ON public.crm_notes;
CREATE POLICY "Users view their notes"
  ON public.crm_notes FOR SELECT
  USING (user_id = auth.uid() OR (created_by = auth.uid() AND is_private = false));

DROP POLICY IF EXISTS "Users create notes" ON public.crm_notes;
CREATE POLICY "Users create notes"
  ON public.crm_notes FOR INSERT
  WITH CHECK (user_id = auth.uid());

-- PIPELINE STAGES
DROP POLICY IF EXISTS "Users manage their stages" ON public.crm_pipeline_stages;
CREATE POLICY "Users manage their stages"
  ON public.crm_pipeline_stages FOR ALL
  USING (user_id = auth.uid());

-- INTEGRATION LOG
DROP POLICY IF EXISTS "Users view sync log" ON public.crm_integration_sync_log;
CREATE POLICY "Users view sync log"
  ON public.crm_integration_sync_log FOR SELECT
  USING (user_id = auth.uid());

-- ============================================================
-- 11. GRANT PERMISSIONS
-- ============================================================
GRANT ALL ON public.crm_contacts TO authenticated;
GRANT ALL ON public.crm_leads TO authenticated;
GRANT ALL ON public.crm_activities TO authenticated;
GRANT ALL ON public.crm_opportunities TO authenticated;
GRANT ALL ON public.crm_email_templates TO authenticated;
GRANT ALL ON public.crm_notes TO authenticated;
GRANT ALL ON public.crm_pipeline_stages TO authenticated;
GRANT ALL ON public.crm_integration_sync_log TO authenticated;

-- ============================================================
-- 12. HELPER FUNCTIONS
-- ============================================================

-- Convert lead to opportunity
CREATE OR REPLACE FUNCTION convert_lead_to_opportunity(
  lead_id_param UUID,
  contract_value_param DECIMAL
)
RETURNS UUID AS $$
DECLARE
  opportunity_id UUID;
  lead_record RECORD;
BEGIN
  -- Get lead data
  SELECT * INTO lead_record
  FROM public.crm_leads
  WHERE id = lead_id_param;

  -- Create opportunity
  INSERT INTO public.crm_opportunities (
    user_id,
    lead_id,
    contact_id,
    quote_id,
    opportunity_name,
    description,
    project_type,
    contract_value,
    account_owner,
    win_date,
    status
  ) VALUES (
    lead_record.user_id,
    lead_record.id,
    lead_record.contact_id,
    lead_record.quote_id,
    lead_record.title,
    lead_record.description,
    lead_record.project_type,
    contract_value_param,
    lead_record.assigned_to,
    CURRENT_DATE,
    'won'
  ) RETURNING id INTO opportunity_id;

  -- Update lead
  UPDATE public.crm_leads
  SET
    stage = 'won',
    actual_close_date = CURRENT_DATE,
    is_active = false
  WHERE id = lead_id_param;

  RETURN opportunity_id;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Calculate pipeline metrics
CREATE OR REPLACE FUNCTION get_pipeline_metrics(user_id_param UUID)
RETURNS TABLE(
  total_leads INTEGER,
  total_value DECIMAL,
  weighted_value DECIMAL,
  avg_deal_size DECIMAL,
  win_rate DECIMAL
) AS $$
BEGIN
  RETURN QUERY
  SELECT
    COUNT(*)::INTEGER as total_leads,
    COALESCE(SUM(estimated_value), 0) as total_value,
    COALESCE(SUM(weighted_value), 0) as weighted_value,
    COALESCE(AVG(estimated_value), 0) as avg_deal_size,
    CASE
      WHEN COUNT(*) FILTER (WHERE stage IN ('won', 'lost')) > 0
      THEN COUNT(*) FILTER (WHERE stage = 'won')::DECIMAL / COUNT(*) FILTER (WHERE stage IN ('won', 'lost'))
      ELSE 0
    END as win_rate
  FROM public.crm_leads
  WHERE user_id = user_id_param
  AND is_active = true;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- ============================================================
-- 13. INSERT DEFAULT PIPELINE STAGES
-- ============================================================

-- These are inserted per user on account creation
-- For now, create a function to initialize stages

CREATE OR REPLACE FUNCTION initialize_crm_pipeline_stages(user_id_param UUID)
RETURNS VOID AS $$
BEGIN
  INSERT INTO public.crm_pipeline_stages (user_id, stage_name, stage_key, stage_order, probability_default, color, is_system_stage)
  VALUES
    (user_id_param, 'New Lead', 'new', 1, 10, '#6B7280', true),
    (user_id_param, 'Contacted', 'contacted', 2, 20, '#3B82F6', true),
    (user_id_param, 'Qualified', 'qualified', 3, 40, '#8B5CF6', true),
    (user_id_param, 'Proposal Sent', 'proposal_sent', 4, 60, '#F59E0B', true),
    (user_id_param, 'Negotiation', 'negotiation', 5, 80, '#F97316', true),
    (user_id_param, 'Won', 'won', 6, 100, '#10B981', true),
    (user_id_param, 'Lost', 'lost', 7, 0, '#EF4444', true)
  ON CONFLICT DO NOTHING;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- ============================================================
-- SETUP COMPLETE!
-- ============================================================

SELECT 'CRM Suite Database Schema Created Successfully!' as status,
       '8 tables created with construction-focused CRM capabilities' as details;




#end of sql 1

#start  of sql 2

-- ============================================================
-- REPORTCENTER ENTERPRISE FEATURES - PHASE 3
-- Automation, Client Portal, Compliance, and Security
-- ============================================================

-- ============================================================
-- 1. REPORT AUTOMATION WORKFLOWS
-- ============================================================
CREATE TABLE IF NOT EXISTS public.report_workflows (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,

  -- WORKFLOW INFO
  name VARCHAR(255) NOT NULL,
  description TEXT,
  category VARCHAR(50), -- reporting, compliance, client_updates, internal

  -- TRIGGER CONFIGURATION
  trigger_type VARCHAR(50) NOT NULL, -- schedule, event, threshold, manual
  trigger_config JSONB NOT NULL,
  -- Structure for schedule: {
  --   frequency: 'daily' | 'weekly' | 'monthly',
  --   time: '17:00',
  --   days: [1,2,3,4,5] (for weekly)
  -- }
  -- Structure for event: {
  --   event: 'project_milestone' | 'task_complete' | 'budget_threshold',
  --   conditions: {...}
  -- }
  -- Structure for threshold: {
  --   metric: 'budget_variance' | 'schedule_delay',
  --   operator: 'greater_than' | 'less_than',
  --   value: 0.15
  -- }

  -- ACTIONS TO EXECUTE
  actions JSONB NOT NULL DEFAULT '[]'::jsonb,
  -- Array of actions:
  -- [
  --   {type: 'generate_report', template_id: 'uuid', project_id: 'uuid'},
  --   {type: 'send_email', recipients: ['email'], subject: '...'},
  --   {type: 'create_task', task_details: {...}},
  --   {type: 'update_project', project_id: 'uuid', updates: {...}}
  -- ]

  -- CONDITIONS (When to run)
  conditions JSONB DEFAULT '{}'::jsonb,
  -- {
  --   project_status: ['active', 'in_progress'],
  --   client_types: ['premium', 'vip'],
  --   date_ranges: {...}
  -- }

  -- EXECUTION TRACKING
  last_run_at TIMESTAMPTZ,
  last_run_status VARCHAR(20), -- success, failed, partial, skipped
  last_run_log TEXT,
  next_run_at TIMESTAMPTZ,
  last_error TEXT,

  -- ERROR HANDLING
  retry_on_failure BOOLEAN DEFAULT true,
  max_retries INTEGER DEFAULT 3,
  retry_count INTEGER DEFAULT 0,
  notify_on_failure BOOLEAN DEFAULT true,
  notification_emails TEXT[],

  -- STATUS
  is_active BOOLEAN DEFAULT true,
  is_paused BOOLEAN DEFAULT false,
  run_count INTEGER DEFAULT 0,
  success_count INTEGER DEFAULT 0,
  failure_count INTEGER DEFAULT 0,

  -- METADATA
  created_by UUID REFERENCES auth.users(id),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_workflows_user ON public.report_workflows(user_id);
CREATE INDEX IF NOT EXISTS idx_workflows_active ON public.report_workflows(is_active, next_run_at);
CREATE INDEX IF NOT EXISTS idx_workflows_trigger ON public.report_workflows(trigger_type);

-- ============================================================
-- 2. WORKFLOW EXECUTION HISTORY
-- ============================================================
CREATE TABLE IF NOT EXISTS public.workflow_executions (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  workflow_id UUID REFERENCES public.report_workflows(id) ON DELETE CASCADE NOT NULL,

  -- EXECUTION DETAILS
  started_at TIMESTAMPTZ DEFAULT NOW(),
  completed_at TIMESTAMPTZ,
  duration_ms INTEGER,
  status VARCHAR(20), -- running, success, failed, cancelled

  -- TRIGGER INFO
  triggered_by VARCHAR(50), -- schedule, manual, event, threshold
  triggered_by_user UUID REFERENCES auth.users(id),

  -- EXECUTION CONTEXT
  execution_context JSONB DEFAULT '{}'::jsonb,
  -- {project_id, client_id, trigger_value, etc.}

  -- RESULTS
  actions_executed JSONB DEFAULT '[]'::jsonb,
  -- [{action: 'generate_report', status: 'success', report_id: 'uuid'}]

  reports_generated UUID[], -- Array of report IDs created
  emails_sent INTEGER DEFAULT 0,
  tasks_created INTEGER DEFAULT 0,

  -- ERROR TRACKING
  error_message TEXT,
  error_stack TEXT,
  retry_attempt INTEGER DEFAULT 0,

  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_workflow_executions_workflow ON public.workflow_executions(workflow_id);
CREATE INDEX IF NOT EXISTS idx_workflow_executions_status ON public.workflow_executions(status);
CREATE INDEX IF NOT EXISTS idx_workflow_executions_date ON public.workflow_executions(started_at DESC);

-- ============================================================
-- 3. CLIENT PORTAL ACCESS
-- ============================================================
CREATE TABLE IF NOT EXISTS public.client_portal_access (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,

  -- CLIENT INFO
  client_email VARCHAR(255) UNIQUE NOT NULL,
  client_name VARCHAR(255) NOT NULL,
  client_company VARCHAR(255),
  client_phone VARCHAR(50),

  -- ACCESS CREDENTIALS
  portal_username VARCHAR(255) UNIQUE,
  portal_password_hash TEXT,
  temporary_password BOOLEAN DEFAULT true,
  password_reset_token TEXT,
  password_reset_expires TIMESTAMPTZ,
  two_factor_enabled BOOLEAN DEFAULT false,
  two_factor_secret TEXT,

  -- PERMISSIONS
  allowed_report_types TEXT[], -- Which report types can see
  allowed_projects UUID[], -- Which projects can access
  view_only BOOLEAN DEFAULT true,
  can_download BOOLEAN DEFAULT true,
  can_comment BOOLEAN DEFAULT true,
  can_approve BOOLEAN DEFAULT false,
  can_request_changes BOOLEAN DEFAULT true,

  -- ACTIVITY TRACKING
  first_login_at TIMESTAMPTZ,
  last_login_at TIMESTAMPTZ,
  login_count INTEGER DEFAULT 0,
  last_activity_at TIMESTAMPTZ,
  failed_login_attempts INTEGER DEFAULT 0,
  locked_until TIMESTAMPTZ,

  -- SETTINGS
  email_notifications BOOLEAN DEFAULT true,
  notification_frequency VARCHAR(20) DEFAULT 'immediate', -- immediate, daily, weekly
  preferred_language VARCHAR(10) DEFAULT 'en',
  timezone VARCHAR(50) DEFAULT 'America/New_York',

  -- STATUS
  is_active BOOLEAN DEFAULT true,
  is_verified BOOLEAN DEFAULT false,
  verification_token TEXT,
  verification_sent_at TIMESTAMPTZ,

  created_by UUID REFERENCES auth.users(id),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_client_portal_email ON public.client_portal_access(client_email);
CREATE INDEX IF NOT EXISTS idx_client_portal_username ON public.client_portal_access(portal_username);
CREATE INDEX IF NOT EXISTS idx_client_portal_user ON public.client_portal_access(user_id);

-- ============================================================
-- 4. CLIENT PORTAL ACTIVITY LOG
-- ============================================================
CREATE TABLE IF NOT EXISTS public.client_portal_activity (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  portal_access_id UUID REFERENCES public.client_portal_access(id) ON DELETE CASCADE NOT NULL,

  -- ACTIVITY INFO
  activity_type VARCHAR(50), -- login, logout, view_report, download, comment, approve
  activity_details TEXT,

  -- CONTEXT
  report_id UUID REFERENCES public.reports(id),
  project_id UUID REFERENCES public.projects(id),

  -- METADATA
  ip_address INET,
  user_agent TEXT,
  device_type VARCHAR(50), -- desktop, mobile, tablet
  location JSONB, -- {country, city, lat, lon}

  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_portal_activity_access ON public.client_portal_activity(portal_access_id);
CREATE INDEX IF NOT EXISTS idx_portal_activity_type ON public.client_portal_activity(activity_type);
CREATE INDEX IF NOT EXISTS idx_portal_activity_date ON public.client_portal_activity(created_at DESC);

-- ============================================================
-- 5. COMPLIANCE & AUDIT TRAIL
-- ============================================================
CREATE TABLE IF NOT EXISTS public.compliance_audit_trail (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id) ON DELETE SET NULL,

  -- WHAT WAS CHANGED
  entity_type VARCHAR(50) NOT NULL, -- report, template, workflow, portal_access
  entity_id UUID NOT NULL,
  action VARCHAR(50) NOT NULL, -- created, updated, deleted, viewed, exported, approved

  -- WHO MADE THE CHANGE
  actor_type VARCHAR(20), -- user, system, client, workflow
  actor_id UUID,
  actor_name VARCHAR(255),
  actor_email VARCHAR(255),

  -- WHEN
  action_timestamp TIMESTAMPTZ DEFAULT NOW(),

  -- NETWORK CONTEXT
  ip_address INET,
  user_agent TEXT,
  session_id TEXT,

  -- CHANGE DETAILS
  previous_values JSONB,
  new_values JSONB,
  changes_summary TEXT,

  -- BUSINESS CONTEXT
  project_id UUID REFERENCES public.projects(id),
  client_id UUID,
  reason TEXT, -- Why the change was made

  -- DATA INTEGRITY
  checksum TEXT, -- Hash of the data for integrity verification
  previous_checksum TEXT,

  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_audit_trail_entity ON public.compliance_audit_trail(entity_type, entity_id);
CREATE INDEX IF NOT EXISTS idx_audit_trail_actor ON public.compliance_audit_trail(actor_id);
CREATE INDEX IF NOT EXISTS idx_audit_trail_date ON public.compliance_audit_trail(action_timestamp DESC);
CREATE INDEX IF NOT EXISTS idx_audit_trail_project ON public.compliance_audit_trail(project_id);

-- ============================================================
-- 6. REPORT EXPORT HISTORY (For tracking downloads)
-- ============================================================
CREATE TABLE IF NOT EXISTS public.report_exports (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  report_id UUID REFERENCES public.reports(id) ON DELETE CASCADE NOT NULL,
  user_id UUID REFERENCES auth.users(id) ON DELETE SET NULL,

  -- EXPORT DETAILS
  export_type VARCHAR(20) NOT NULL, -- pdf, excel, csv, json, powerbi
  export_format VARCHAR(50), -- A4, letter, landscape, portrait
  file_size_bytes INTEGER,
  file_hash TEXT, -- SHA256 hash for integrity

  -- WHO EXPORTED
  exported_by_type VARCHAR(20), -- user, client, system
  exported_by_id UUID,
  exported_by_name VARCHAR(255),
  exported_by_email VARCHAR(255),

  -- WHEN & WHERE
  exported_at TIMESTAMPTZ DEFAULT NOW(),
  ip_address INET,
  user_agent TEXT,

  -- CLIENT EXPORTS
  client_portal_access_id UUID REFERENCES public.client_portal_access(id),

  -- WATERMARKING
  watermarked BOOLEAN DEFAULT false,
  watermark_text TEXT,
  watermark_config JSONB,

  -- FILE STORAGE
  file_url TEXT,
  storage_path TEXT,
  expires_at TIMESTAMPTZ, -- For temporary download links

  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_report_exports_report ON public.report_exports(report_id);
CREATE INDEX IF NOT EXISTS idx_report_exports_user ON public.report_exports(user_id);
CREATE INDEX IF NOT EXISTS idx_report_exports_date ON public.report_exports(exported_at DESC);

-- ============================================================
-- 7. REPORT APPROVAL WORKFLOWS
-- ============================================================
CREATE TABLE IF NOT EXISTS public.report_approvals (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  report_id UUID REFERENCES public.reports(id) ON DELETE CASCADE NOT NULL,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,

  -- WORKFLOW CONFIGURATION
  workflow_type VARCHAR(50) DEFAULT 'single', -- single, sequential, parallel
  required_approvers JSONB NOT NULL,
  -- [
  --   {user_id: 'uuid', role: 'project_manager', order: 1},
  --   {user_id: 'uuid', role: 'client', order: 2}
  -- ]

  current_step INTEGER DEFAULT 1,
  total_steps INTEGER,

  -- APPROVALS RECEIVED
  approvals JSONB DEFAULT '[]'::jsonb,
  -- [
  --   {user_id: 'uuid', approved: true, approved_at: '...', comments: '...', signature: '...'}
  -- ]

  rejections JSONB DEFAULT '[]'::jsonb,

  -- STATUS
  status VARCHAR(20) DEFAULT 'pending', -- pending, approved, rejected, expired
  final_decision_at TIMESTAMPTZ,
  final_decision_by UUID REFERENCES auth.users(id),
  final_comments TEXT,

  -- NOTIFICATIONS
  next_reminder_at TIMESTAMPTZ,
  reminder_count INTEGER DEFAULT 0,
  escalation_level INTEGER DEFAULT 0,

  -- DEADLINES
  due_date TIMESTAMPTZ,
  expires_at TIMESTAMPTZ,

  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_report_approvals_report ON public.report_approvals(report_id);
CREATE INDEX IF NOT EXISTS idx_report_approvals_status ON public.report_approvals(status);
CREATE INDEX IF NOT EXISTS idx_report_approvals_due ON public.report_approvals(due_date);

-- ============================================================
-- 8. COMPLIANCE CERTIFICATIONS TRACKER
-- ============================================================
CREATE TABLE IF NOT EXISTS public.compliance_certifications (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,

  -- CERTIFICATION INFO
  certification_name VARCHAR(255) NOT NULL,
  certification_type VARCHAR(100), -- OSHA, LEED, EPA, ISO, etc.
  certification_number VARCHAR(100),
  issuing_authority VARCHAR(255),

  -- RESPONSIBLE PARTY
  responsible_person_id UUID REFERENCES auth.users(id),
  responsible_person_name VARCHAR(255),
  responsible_person_email VARCHAR(255),

  -- DATES
  issue_date DATE,
  expiry_date DATE,
  renewal_date DATE,
  last_verified_date DATE,

  -- STATUS
  status VARCHAR(20), -- valid, expiring_soon, expired, pending_renewal
  is_active BOOLEAN DEFAULT true,

  -- DOCUMENTATION
  certificate_url TEXT,
  document_path TEXT,
  verification_url TEXT,

  -- RENEWAL TRACKING
  renewal_notification_sent BOOLEAN DEFAULT false,
  renewal_notification_sent_at TIMESTAMPTZ,
  auto_renew BOOLEAN DEFAULT false,

  -- PROJECTS REQUIRING THIS CERTIFICATION
  required_for_projects UUID[],

  -- METADATA
  notes TEXT,
  tags TEXT[],

  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_certifications_user ON public.compliance_certifications(user_id);
CREATE INDEX IF NOT EXISTS idx_certifications_expiry ON public.compliance_certifications(expiry_date);
CREATE INDEX IF NOT EXISTS idx_certifications_status ON public.compliance_certifications(status);

-- ============================================================
-- 9. ENABLE ROW LEVEL SECURITY
-- ============================================================
ALTER TABLE public.report_workflows ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.workflow_executions ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.client_portal_access ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.client_portal_activity ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.compliance_audit_trail ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.report_exports ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.report_approvals ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.compliance_certifications ENABLE ROW LEVEL SECURITY;

-- ============================================================
-- 10. RLS POLICIES
-- ============================================================

-- WORKFLOWS
DROP POLICY IF EXISTS "Users manage their workflows" ON public.report_workflows;
CREATE POLICY "Users manage their workflows"
  ON public.report_workflows FOR ALL
  USING (user_id = auth.uid());

-- WORKFLOW EXECUTIONS
DROP POLICY IF EXISTS "Users view their executions" ON public.workflow_executions;
CREATE POLICY "Users view their executions"
  ON public.workflow_executions FOR SELECT
  USING (
    workflow_id IN (
      SELECT id FROM public.report_workflows WHERE user_id = auth.uid()
    )
  );

-- CLIENT PORTAL ACCESS
DROP POLICY IF EXISTS "Users manage client portal" ON public.client_portal_access;
CREATE POLICY "Users manage client portal"
  ON public.client_portal_access FOR ALL
  USING (user_id = auth.uid());

-- CLIENT PORTAL ACTIVITY
DROP POLICY IF EXISTS "Users view portal activity" ON public.client_portal_activity;
CREATE POLICY "Users view portal activity"
  ON public.client_portal_activity FOR SELECT
  USING (
    portal_access_id IN (
      SELECT id FROM public.client_portal_access WHERE user_id = auth.uid()
    )
  );

-- AUDIT TRAIL
DROP POLICY IF EXISTS "Users view audit trail" ON public.compliance_audit_trail;
CREATE POLICY "Users view audit trail"
  ON public.compliance_audit_trail FOR SELECT
  USING (user_id = auth.uid());

-- EXPORTS
DROP POLICY IF EXISTS "Users view exports" ON public.report_exports;
CREATE POLICY "Users view exports"
  ON public.report_exports FOR SELECT
  USING (user_id = auth.uid());

-- APPROVALS
DROP POLICY IF EXISTS "Users manage approvals" ON public.report_approvals;
CREATE POLICY "Users manage approvals"
  ON public.report_approvals FOR ALL
  USING (user_id = auth.uid());

-- CERTIFICATIONS
DROP POLICY IF EXISTS "Users manage certifications" ON public.compliance_certifications;
CREATE POLICY "Users manage certifications"
  ON public.compliance_certifications FOR ALL
  USING (user_id = auth.uid());

-- ============================================================
-- 11. GRANT PERMISSIONS
-- ============================================================
GRANT ALL ON public.report_workflows TO authenticated;
GRANT ALL ON public.workflow_executions TO authenticated;
GRANT ALL ON public.client_portal_access TO authenticated;
GRANT ALL ON public.client_portal_activity TO authenticated;
GRANT ALL ON public.compliance_audit_trail TO authenticated;
GRANT ALL ON public.report_exports TO authenticated;
GRANT ALL ON public.report_approvals TO authenticated;
GRANT ALL ON public.compliance_certifications TO authenticated;

-- ============================================================
-- 12. ENTERPRISE FUNCTIONS
-- ============================================================

-- Execute workflow
CREATE OR REPLACE FUNCTION execute_workflow(workflow_id_param UUID)
RETURNS UUID AS $$
DECLARE
  execution_id UUID;
  workflow_record RECORD;
  action JSONB;
  report_id UUID;
BEGIN
  -- Get workflow
  SELECT * INTO workflow_record
  FROM public.report_workflows
  WHERE id = workflow_id_param
  AND is_active = true;

  IF NOT FOUND THEN
    RAISE EXCEPTION 'Workflow not found or inactive';
  END IF;

  -- Create execution record
  INSERT INTO public.workflow_executions (
    workflow_id,
    triggered_by,
    status
  ) VALUES (
    workflow_id_param,
    'manual',
    'running'
  ) RETURNING id INTO execution_id;

  -- Execute each action
  FOR action IN SELECT * FROM jsonb_array_elements(workflow_record.actions)
  LOOP
    -- Handle different action types
    IF action->>'type' = 'generate_report' THEN
      -- Generate report logic would go here
      -- For now, just log the action
      UPDATE public.workflow_executions
      SET actions_executed = actions_executed || jsonb_build_object(
        'action', 'generate_report',
        'status', 'success',
        'timestamp', NOW()
      )
      WHERE id = execution_id;
    END IF;
  END LOOP;

  -- Mark execution as complete
  UPDATE public.workflow_executions
  SET
    status = 'success',
    completed_at = NOW(),
    duration_ms = EXTRACT(EPOCH FROM (NOW() - started_at)) * 1000
  WHERE id = execution_id;

  -- Update workflow stats
  UPDATE public.report_workflows
  SET
    last_run_at = NOW(),
    last_run_status = 'success',
    run_count = run_count + 1,
    success_count = success_count + 1
  WHERE id = workflow_id_param;

  RETURN execution_id;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Log audit trail
CREATE OR REPLACE FUNCTION log_audit_trail(
  entity_type_param VARCHAR,
  entity_id_param UUID,
  action_param VARCHAR,
  previous_values_param JSONB DEFAULT NULL,
  new_values_param JSONB DEFAULT NULL
)
RETURNS UUID AS $$
DECLARE
  audit_id UUID;
BEGIN
  INSERT INTO public.compliance_audit_trail (
    user_id,
    entity_type,
    entity_id,
    action,
    actor_type,
    actor_id,
    previous_values,
    new_values
  ) VALUES (
    auth.uid(),
    entity_type_param,
    entity_id_param,
    action_param,
    'user',
    auth.uid(),
    previous_values_param,
    new_values_param
  ) RETURNING id INTO audit_id;

  RETURN audit_id;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Check certification expiry
CREATE OR REPLACE FUNCTION check_certification_expiry()
RETURNS TABLE(
  certification_id UUID,
  certification_name VARCHAR,
  expiry_date DATE,
  days_until_expiry INTEGER,
  status VARCHAR
) AS $$
BEGIN
  RETURN QUERY
  SELECT
    id,
    certification_name,
    expiry_date,
    (expiry_date - CURRENT_DATE)::INTEGER as days_until_expiry,
    CASE
      WHEN expiry_date < CURRENT_DATE THEN 'expired'
      WHEN expiry_date <= CURRENT_DATE + INTERVAL '30 days' THEN 'expiring_soon'
      ELSE 'valid'
    END::VARCHAR as status
  FROM public.compliance_certifications
  WHERE is_active = true
  AND user_id = auth.uid()
  ORDER BY expiry_date ASC;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- ============================================================
-- SETUP COMPLETE!
-- ============================================================

SELECT 'ReportCenter Enterprise Schema Created Successfully!' as status,
       'Phase 3: Automation, Client Portal, Compliance, and Security' as phase;


#end of sql 2


#start of sql 3


-- ============================================================
-- REPORTCENTER ADVANCED ANALYTICS - PHASE 2
-- Business intelligence, custom reporting, and automation
-- ============================================================

-- ============================================================
-- 1. REPORT ANALYTICS (Track usage and value)
-- ============================================================
CREATE TABLE IF NOT EXISTS public.report_analytics (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  report_id UUID REFERENCES public.reports(id) ON DELETE CASCADE NOT NULL,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,

  -- GENERATION METRICS
  generation_time_ms INTEGER,
  file_size_bytes INTEGER,
  data_points_count INTEGER,

  -- CLIENT INTERACTION
  client_opened BOOLEAN DEFAULT false,
  client_opened_at TIMESTAMPTZ,
  client_open_count INTEGER DEFAULT 0,
  client_downloaded BOOLEAN DEFAULT false,
  client_downloaded_at TIMESTAMPTZ,
  client_time_spent_seconds INTEGER,

  -- BUSINESS IMPACT
  led_to_action BOOLEAN DEFAULT false,
  action_type VARCHAR(50), -- approval, payment, change_order, contract_signed
  action_value DECIMAL(12,2), -- Estimated value of action taken

  -- FEEDBACK
  rating INTEGER CHECK (rating BETWEEN 1 AND 5),
  feedback TEXT,
  was_useful BOOLEAN,

  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_report_analytics_report ON public.report_analytics(report_id);
CREATE INDEX IF NOT EXISTS idx_report_analytics_user ON public.report_analytics(user_id);

-- ============================================================
-- 2. CUSTOM REPORT BUILDER SAVES
-- ============================================================
CREATE TABLE IF NOT EXISTS public.custom_report_saves (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,

  -- REPORT INFO
  name VARCHAR(255) NOT NULL,
  description TEXT,
  category VARCHAR(50), -- financial, operational, client, custom

  -- REPORT CONFIGURATION (Full JSON config)
  config JSONB NOT NULL DEFAULT '{}'::jsonb,
  -- Structure: {
  --   sections: [{ id, type, title, dataSource, fields, visualization }],
  --   filters: { dateRange, projects, clients },
  --   styling: { colors, fonts, layout }
  -- }

  data_sources JSONB DEFAULT '[]'::jsonb,
  -- Which data to include: ['projects', 'tasks', 'financial', 'crew']

  filters JSONB DEFAULT '{}'::jsonb,
  -- Saved filter state

  visualizations JSONB DEFAULT '[]'::jsonb,
  -- Chart configurations

  -- USAGE TRACKING
  use_count INTEGER DEFAULT 0,
  last_used_at TIMESTAMPTZ,
  avg_generation_time_ms INTEGER,

  -- SHARING
  is_favorite BOOLEAN DEFAULT false,
  shared_with_team BOOLEAN DEFAULT false,
  shared_with_users UUID[],
  is_public BOOLEAN DEFAULT false,

  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_custom_reports_user ON public.custom_report_saves(user_id);
CREATE INDEX IF NOT EXISTS idx_custom_reports_favorite ON public.custom_report_saves(is_favorite);

-- ============================================================
-- 3. REPORT ALERTS & NOTIFICATIONS
-- ============================================================
CREATE TABLE IF NOT EXISTS public.report_alerts (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,

  -- ALERT CONFIG
  name VARCHAR(255) NOT NULL,
  description TEXT,
  alert_type VARCHAR(50) NOT NULL, -- budget, schedule, safety, quality, financial

  -- CONDITION (JSONB for flexibility)
  condition JSONB NOT NULL,
  -- Structure: {
  --   metric: 'budget_variance',
  --   operator: 'greater_than',
  --   threshold: 0.15,
  --   scope: 'project' | 'company' | 'client'
  -- }

  -- ACTION CONFIGURATION
  action VARCHAR(50) NOT NULL, -- email, notification, generate_report, create_task
  action_config JSONB DEFAULT '{}'::jsonb,
  -- Structure: {
  --   recipients: ['user_id', 'email'],
  --   template_id: 'uuid',
  --   priority: 'high' | 'medium' | 'low'
  -- }

  -- SCHEDULING
  check_frequency VARCHAR(20) DEFAULT 'daily', -- hourly, daily, weekly, realtime
  last_checked_at TIMESTAMPTZ,
  last_triggered_at TIMESTAMPTZ,
  next_check_at TIMESTAMPTZ,

  -- STATUS
  is_active BOOLEAN DEFAULT true,
  trigger_count INTEGER DEFAULT 0,
  false_positive_count INTEGER DEFAULT 0,

  -- METADATA
  created_by UUID REFERENCES auth.users(id),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_report_alerts_user ON public.report_alerts(user_id);
CREATE INDEX IF NOT EXISTS idx_report_alerts_active ON public.report_alerts(is_active, next_check_at);

-- ============================================================
-- 4. ALERT TRIGGERS LOG
-- ============================================================
CREATE TABLE IF NOT EXISTS public.alert_triggers (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  alert_id UUID REFERENCES public.report_alerts(id) ON DELETE CASCADE NOT NULL,

  -- TRIGGER DETAILS
  triggered_at TIMESTAMPTZ DEFAULT NOW(),
  actual_value DECIMAL(12,2),
  threshold_value DECIMAL(12,2),
  variance DECIMAL(12,2),

  -- CONTEXT
  related_project_id UUID REFERENCES public.projects(id),
  related_quote_id UUID REFERENCES public.quotes(id),
  context JSONB DEFAULT '{}'::jsonb,

  -- ACTION TAKEN
  action_taken VARCHAR(50),
  action_status VARCHAR(20), -- sent, failed, acknowledged, resolved
  action_result JSONB,

  -- RESOLUTION
  acknowledged BOOLEAN DEFAULT false,
  acknowledged_by UUID REFERENCES auth.users(id),
  acknowledged_at TIMESTAMPTZ,
  resolution_notes TEXT,

  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_alert_triggers_alert ON public.alert_triggers(alert_id);
CREATE INDEX IF NOT EXISTS idx_alert_triggers_project ON public.alert_triggers(related_project_id);

-- ============================================================
-- 5. FINANCIAL METRICS CACHE (For fast dashboard loading)
-- ============================================================
CREATE TABLE IF NOT EXISTS public.financial_metrics_cache (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,

  -- PERIOD
  period_type VARCHAR(20) NOT NULL, -- daily, weekly, monthly, quarterly, yearly
  period_start DATE NOT NULL,
  period_end DATE NOT NULL,

  -- PROJECT SCOPE (null = all projects)
  project_id UUID REFERENCES public.projects(id),

  -- REVENUE METRICS
  total_revenue DECIMAL(12,2) DEFAULT 0,
  completed_revenue DECIMAL(12,2) DEFAULT 0,
  pending_revenue DECIMAL(12,2) DEFAULT 0,
  change_order_revenue DECIMAL(12,2) DEFAULT 0,

  -- COST METRICS
  total_costs DECIMAL(12,2) DEFAULT 0,
  labor_costs DECIMAL(12,2) DEFAULT 0,
  material_costs DECIMAL(12,2) DEFAULT 0,
  equipment_costs DECIMAL(12,2) DEFAULT 0,
  subcontractor_costs DECIMAL(12,2) DEFAULT 0,
  overhead_costs DECIMAL(12,2) DEFAULT 0,

  -- PROFIT METRICS
  gross_profit DECIMAL(12,2) GENERATED ALWAYS AS (total_revenue - total_costs) STORED,
  gross_margin DECIMAL(5,4) GENERATED ALWAYS AS (
    CASE WHEN total_revenue > 0
    THEN (total_revenue - total_costs) / total_revenue
    ELSE 0 END
  ) STORED,

  -- PROJECT METRICS
  active_projects_count INTEGER DEFAULT 0,
  completed_projects_count INTEGER DEFAULT 0,
  avg_project_value DECIMAL(12,2),
  avg_project_margin DECIMAL(5,4),

  -- CREW METRICS
  total_hours_worked DECIMAL(10,2) DEFAULT 0,
  regular_hours DECIMAL(10,2) DEFAULT 0,
  overtime_hours DECIMAL(10,2) DEFAULT 0,
  avg_hourly_cost DECIMAL(10,2),

  -- CACHE METADATA
  calculated_at TIMESTAMPTZ DEFAULT NOW(),
  is_stale BOOLEAN DEFAULT false,

  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),

  UNIQUE(user_id, period_type, period_start, period_end, project_id)
);

CREATE INDEX IF NOT EXISTS idx_financial_cache_user_period ON public.financial_metrics_cache(user_id, period_type, period_start);
CREATE INDEX IF NOT EXISTS idx_financial_cache_project ON public.financial_metrics_cache(project_id);

-- ============================================================
-- 6. ENABLE ROW LEVEL SECURITY
-- ============================================================
ALTER TABLE public.report_analytics ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.custom_report_saves ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.report_alerts ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.alert_triggers ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.financial_metrics_cache ENABLE ROW LEVEL SECURITY;

-- ============================================================
-- 7. RLS POLICIES
-- ============================================================

-- REPORT ANALYTICS
DROP POLICY IF EXISTS "Users manage their analytics" ON public.report_analytics;
CREATE POLICY "Users manage their analytics"
  ON public.report_analytics FOR ALL
  USING (user_id = auth.uid());

-- CUSTOM REPORT SAVES
DROP POLICY IF EXISTS "Users manage their custom reports" ON public.custom_report_saves;
CREATE POLICY "Users manage their custom reports"
  ON public.custom_report_saves FOR ALL
  USING (user_id = auth.uid());

-- REPORT ALERTS
DROP POLICY IF EXISTS "Users manage their alerts" ON public.report_alerts;
CREATE POLICY "Users manage their alerts"
  ON public.report_alerts FOR ALL
  USING (user_id = auth.uid());

-- ALERT TRIGGERS
DROP POLICY IF EXISTS "Users view their alert triggers" ON public.alert_triggers;
CREATE POLICY "Users view their alert triggers"
  ON public.alert_triggers FOR SELECT
  USING (
    alert_id IN (
      SELECT id FROM public.report_alerts WHERE user_id = auth.uid()
    )
  );

-- FINANCIAL METRICS CACHE
DROP POLICY IF EXISTS "Users access their financial cache" ON public.financial_metrics_cache;
CREATE POLICY "Users access their financial cache"
  ON public.financial_metrics_cache FOR ALL
  USING (user_id = auth.uid());

-- ============================================================
-- 8. GRANT PERMISSIONS
-- ============================================================
GRANT ALL ON public.report_analytics TO authenticated;
GRANT ALL ON public.custom_report_saves TO authenticated;
GRANT ALL ON public.report_alerts TO authenticated;
GRANT ALL ON public.alert_triggers TO authenticated;
GRANT ALL ON public.financial_metrics_cache TO authenticated;

-- ============================================================
-- 9. ADVANCED FUNCTIONS
-- ============================================================

-- Calculate financial metrics for a period
CREATE OR REPLACE FUNCTION calculate_financial_metrics(
  user_id_param UUID,
  period_start_param DATE,
  period_end_param DATE,
  project_id_param UUID DEFAULT NULL
)
RETURNS TABLE(
  total_revenue DECIMAL(12,2),
  total_costs DECIMAL(12,2),
  gross_profit DECIMAL(12,2),
  gross_margin DECIMAL(5,4),
  project_count INTEGER
) AS $$
BEGIN
  RETURN QUERY
  SELECT
    COALESCE(SUM(p.budget), 0) as total_revenue,
    COALESCE(SUM(
      (SELECT SUM(te.total_cost)
       FROM public.timesheet_entries te
       WHERE te.project_id = p.id
       AND te.work_date BETWEEN period_start_param AND period_end_param)
    ), 0) as total_costs,
    COALESCE(SUM(p.budget), 0) - COALESCE(SUM(
      (SELECT SUM(te.total_cost)
       FROM public.timesheet_entries te
       WHERE te.project_id = p.id
       AND te.work_date BETWEEN period_start_param AND period_end_param)
    ), 0) as gross_profit,
    CASE
      WHEN COALESCE(SUM(p.budget), 0) > 0
      THEN (COALESCE(SUM(p.budget), 0) - COALESCE(SUM(
        (SELECT SUM(te.total_cost)
         FROM public.timesheet_entries te
         WHERE te.project_id = p.id
         AND te.work_date BETWEEN period_start_param AND period_end_param)
      ), 0)) / COALESCE(SUM(p.budget), 0)
      ELSE 0
    END as gross_margin,
    COUNT(*)::INTEGER as project_count
  FROM public.projects p
  WHERE p.created_by = user_id_param
    AND p.created_at BETWEEN period_start_param AND period_end_param
    AND (project_id_param IS NULL OR p.id = project_id_param);
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Refresh financial metrics cache
CREATE OR REPLACE FUNCTION refresh_financial_cache(
  user_id_param UUID,
  period_type_param VARCHAR(20),
  period_start_param DATE,
  period_end_param DATE
)
RETURNS VOID AS $$
DECLARE
  metrics RECORD;
BEGIN
  -- Calculate metrics
  SELECT * INTO metrics
  FROM calculate_financial_metrics(
    user_id_param,
    period_start_param,
    period_end_param,
    NULL
  );

  -- Upsert into cache
  INSERT INTO public.financial_metrics_cache (
    user_id,
    period_type,
    period_start,
    period_end,
    total_revenue,
    total_costs,
    calculated_at,
    is_stale
  ) VALUES (
    user_id_param,
    period_type_param,
    period_start_param,
    period_end_param,
    metrics.total_revenue,
    metrics.total_costs,
    NOW(),
    false
  )
  ON CONFLICT (user_id, period_type, period_start, period_end, project_id)
  DO UPDATE SET
    total_revenue = EXCLUDED.total_revenue,
    total_costs = EXCLUDED.total_costs,
    calculated_at = NOW(),
    is_stale = false;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Check alert conditions
CREATE OR REPLACE FUNCTION check_alert_conditions()
RETURNS VOID AS $$
DECLARE
  alert_record RECORD;
  should_trigger BOOLEAN;
  metric_value DECIMAL(12,2);
BEGIN
  -- Loop through active alerts that need checking
  FOR alert_record IN
    SELECT * FROM public.report_alerts
    WHERE is_active = true
    AND (next_check_at IS NULL OR next_check_at <= NOW())
  LOOP
    -- Evaluate condition (simplified - expand based on condition type)
    should_trigger := false;

    -- Example: Budget variance check
    IF alert_record.alert_type = 'budget' THEN
      -- Get actual budget variance for user's projects
      SELECT AVG(
        CASE
          WHEN p.budget > 0
          THEN ABS(p.budget - COALESCE(p.actual_cost, 0)) / p.budget
          ELSE 0
        END
      ) INTO metric_value
      FROM public.projects p
      WHERE p.created_by = alert_record.user_id
      AND p.status = 'active';

      -- Check if exceeds threshold
      IF metric_value > (alert_record.condition->>'threshold')::DECIMAL THEN
        should_trigger := true;
      END IF;
    END IF;

    -- If should trigger, log it
    IF should_trigger THEN
      INSERT INTO public.alert_triggers (
        alert_id,
        actual_value,
        threshold_value,
        variance,
        action_status
      ) VALUES (
        alert_record.id,
        metric_value,
        (alert_record.condition->>'threshold')::DECIMAL,
        metric_value - (alert_record.condition->>'threshold')::DECIMAL,
        'sent'
      );

      -- Update alert stats
      UPDATE public.report_alerts
      SET
        last_triggered_at = NOW(),
        trigger_count = trigger_count + 1
      WHERE id = alert_record.id;
    END IF;

    -- Update next check time
    UPDATE public.report_alerts
    SET
      last_checked_at = NOW(),
      next_check_at = NOW() + CASE check_frequency
        WHEN 'hourly' THEN INTERVAL '1 hour'
        WHEN 'daily' THEN INTERVAL '1 day'
        WHEN 'weekly' THEN INTERVAL '1 week'
        ELSE INTERVAL '1 day'
      END
    WHERE id = alert_record.id;
  END LOOP;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- ============================================================
-- 10. INSERT ADVANCED TEMPLATES
-- ============================================================

-- PROFIT & LOSS TEMPLATE
INSERT INTO public.report_templates (
  name,
  description,
  template_type,
  category,
  sections,
  is_system_template,
  is_default,
  is_public
) VALUES (
  'Profit & Loss Statement',
  'Comprehensive P&L with project allocation and trend analysis',
  'budget',
  'financial',
  '[
    {
      "id": "executive_summary",
      "type": "summary",
      "title": "Executive Summary",
      "fields": ["period", "total_revenue", "total_costs", "gross_profit", "net_profit", "margin"]
    },
    {
      "id": "revenue_breakdown",
      "type": "table",
      "title": "Revenue by Project",
      "fields": ["project", "client", "contract_value", "change_orders", "total_revenue", "percent_of_total"]
    },
    {
      "id": "cost_breakdown",
      "type": "chart",
      "title": "Cost Breakdown",
      "chartType": "pie",
      "fields": ["labor", "materials", "equipment", "subcontractors", "overhead"]
    },
    {
      "id": "profitability",
      "type": "table",
      "title": "Project Profitability",
      "fields": ["project", "revenue", "costs", "profit", "margin", "roi"]
    }
  ]'::jsonb,
  true,
  true,
  true
) ON CONFLICT DO NOTHING;

-- CREW PRODUCTIVITY TEMPLATE
INSERT INTO public.report_templates (
  name,
  description,
  template_type,
  category,
  sections,
  is_system_template,
  is_default,
  is_public
) VALUES (
  'Crew Productivity Analysis',
  'Track crew efficiency and performance metrics',
  'progress',
  'operational',
  '[
    {
      "id": "summary",
      "type": "summary",
      "title": "Productivity Summary",
      "fields": ["period", "total_hours", "avg_productivity", "top_performer"]
    },
    {
      "id": "crew_ranking",
      "type": "table",
      "title": "Crew Performance",
      "fields": ["crew", "hours", "tasks_completed", "productivity_score", "quality_score"]
    },
    {
      "id": "trends",
      "type": "chart",
      "title": "Productivity Trends",
      "chartType": "line",
      "fields": ["week", "productivity", "hours"]
    }
  ]'::jsonb,
  true,
  true,
  true
) ON CONFLICT DO NOTHING;

-- CLIENT PORTFOLIO TEMPLATE
INSERT INTO public.report_templates (
  name,
  description,
  template_type,
  category,
  sections,
  is_system_template,
  is_default,
  is_public
) VALUES (
  'Client Portfolio Analysis',
  'Client profitability and value analysis',
  'custom',
  'sales',
  '[
    {
      "id": "portfolio_summary",
      "type": "summary",
      "title": "Portfolio Summary",
      "fields": ["total_clients", "active_clients", "total_revenue", "avg_value", "retention_rate"]
    },
    {
      "id": "top_clients",
      "type": "table",
      "title": "Top Clients",
      "fields": ["client", "revenue", "margin", "projects", "years_active", "score"]
    },
    {
      "id": "client_distribution",
      "type": "chart",
      "title": "Client Distribution",
      "chartType": "pie",
      "fields": ["platinum", "gold", "silver", "bronze"]
    }
  ]'::jsonb,
  true,
  true,
  true
) ON CONFLICT DO NOTHING;

-- ============================================================
-- SETUP COMPLETE!
-- ============================================================

SELECT 'ReportCenter Advanced Analytics Schema Created Successfully!' as status,
       'Phase 2: Business Intelligence, Custom Reporting, and Automation' as phase;


#end of sql 3

#start of sql 4

-- ============================================================
-- REPORTCENTER DATABASE SCHEMA
-- Professional reporting system for construction contractors
-- ============================================================

-- ============================================================
-- 1. REPORTS MASTER TABLE
-- ============================================================
CREATE TABLE IF NOT EXISTS public.reports (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,

  -- REPORT IDENTIFICATION
  report_number VARCHAR(50) UNIQUE NOT NULL,
  report_type VARCHAR(20) NOT NULL CHECK (report_type IN ('daily', 'weekly_timesheet', 'budget', 'safety', 'progress', 'custom')),
  title VARCHAR(255) NOT NULL,
  description TEXT,

  -- SOURCE DATA (What this report is about)
  project_id UUID REFERENCES public.projects(id) ON DELETE SET NULL,
  quote_id UUID REFERENCES public.quotes(id) ON DELETE SET NULL,
  date_range_start DATE NOT NULL,
  date_range_end DATE NOT NULL,

  -- GENERATION DETAILS
  generated_by UUID REFERENCES auth.users(id),
  generated_at TIMESTAMPTZ DEFAULT NOW(),
  generation_time_ms INTEGER, -- Track performance
  data_snapshot JSONB DEFAULT '{}'::jsonb, -- Raw data at generation time

  -- CONTENT & DELIVERY
  status VARCHAR(20) DEFAULT 'draft' CHECK (status IN ('draft', 'final', 'sent', 'archived')),
  sent_to_client BOOLEAN DEFAULT false,
  sent_at TIMESTAMPTZ,
  client_viewed BOOLEAN DEFAULT false,
  client_viewed_at TIMESTAMPTZ,
  client_email VARCHAR(255),

  -- FILE STORAGE
  file_path TEXT, -- Supabase storage path
  pdf_url TEXT,
  excel_url TEXT,
  file_size_bytes INTEGER,

  -- REPORT CONTENT (Structured data)
  summary JSONB DEFAULT '{}'::jsonb, -- Key metrics/summary
  sections JSONB DEFAULT '[]'::jsonb, -- Report sections with data
  photos JSONB DEFAULT '[]'::jsonb, -- Photo references
  attachments JSONB DEFAULT '[]'::jsonb,

  -- METADATA
  tags TEXT[],
  notes TEXT,
  version INTEGER DEFAULT 1,
  parent_report_id UUID REFERENCES public.reports(id), -- For revisions
  is_template BOOLEAN DEFAULT false,

  -- WEATHER DATA (for daily reports)
  weather_data JSONB,

  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Indexes for performance
CREATE INDEX IF NOT EXISTS idx_reports_user_id ON public.reports(user_id);
CREATE INDEX IF NOT EXISTS idx_reports_project_id ON public.reports(project_id);
CREATE INDEX IF NOT EXISTS idx_reports_type ON public.reports(report_type);
CREATE INDEX IF NOT EXISTS idx_reports_date_range ON public.reports(date_range_start, date_range_end);
CREATE INDEX IF NOT EXISTS idx_reports_status ON public.reports(status);
CREATE INDEX IF NOT EXISTS idx_reports_created_at ON public.reports(created_at DESC);

-- ============================================================
-- 2. REPORT TEMPLATES
-- ============================================================
CREATE TABLE IF NOT EXISTS public.report_templates (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,

  -- TEMPLATE INFO
  name VARCHAR(255) NOT NULL,
  description TEXT,
  template_type VARCHAR(50) NOT NULL CHECK (template_type IN ('daily', 'weekly_timesheet', 'budget', 'safety', 'progress', 'custom')),
  category VARCHAR(50), -- client, internal, compliance, financial

  -- TEMPLATE STRUCTURE
  sections JSONB NOT NULL DEFAULT '[]'::jsonb,
  -- Structure: [{ id, type, title, fields, settings }]

  styling JSONB DEFAULT '{
    "primaryColor": "#2563EB",
    "accentColor": "#F97316",
    "fontFamily": "Inter",
    "showLogo": true,
    "showWatermark": false
  }'::jsonb,

  formulas JSONB DEFAULT '{}'::jsonb, -- Calculations between fields
  data_sources JSONB DEFAULT '{}'::jsonb, -- Which data to auto-pull

  -- USAGE & VISIBILITY
  is_default BOOLEAN DEFAULT false,
  is_system_template BOOLEAN DEFAULT false, -- Built-in templates
  is_public BOOLEAN DEFAULT true,
  requires_approval BOOLEAN DEFAULT false,

  use_count INTEGER DEFAULT 0,
  last_used_at TIMESTAMPTZ,

  created_by UUID REFERENCES auth.users(id),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_report_templates_user_id ON public.report_templates(user_id);
CREATE INDEX IF NOT EXISTS idx_report_templates_type ON public.report_templates(template_type);

-- ============================================================
-- 3. REPORT SCHEDULES (Automated reporting)
-- ============================================================
CREATE TABLE IF NOT EXISTS public.report_schedules (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,

  name VARCHAR(255) NOT NULL,
  description TEXT,
  template_id UUID REFERENCES public.report_templates(id),
  report_type VARCHAR(20) NOT NULL,

  -- SCHEDULING
  frequency VARCHAR(20) NOT NULL CHECK (frequency IN ('daily', 'weekly', 'biweekly', 'monthly', 'quarterly')),
  day_of_week INTEGER, -- 0-6 (Sunday=0)
  day_of_month INTEGER, -- 1-31
  time_of_day TIME DEFAULT '17:00', -- 5 PM default
  timezone VARCHAR(50) DEFAULT 'America/New_York',

  -- DELIVERY
  delivery_method VARCHAR(20) DEFAULT 'email' CHECK (delivery_method IN ('email', 'download', 'portal', 'none')),
  recipients JSONB DEFAULT '[]'::jsonb, -- Array of emails
  cc_recipients JSONB DEFAULT '[]'::jsonb,

  include_pdf BOOLEAN DEFAULT true,
  include_excel BOOLEAN DEFAULT false,

  -- PROJECT FILTERS
  project_ids UUID[], -- Specific projects (empty = all active)
  active_projects_only BOOLEAN DEFAULT true,

  -- STATUS
  is_active BOOLEAN DEFAULT true,
  last_run_at TIMESTAMPTZ,
  next_run_at TIMESTAMPTZ,
  last_run_status VARCHAR(20), -- success, failed, skipped
  run_count INTEGER DEFAULT 0,

  created_by UUID REFERENCES auth.users(id),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_report_schedules_user_id ON public.report_schedules(user_id);
CREATE INDEX IF NOT EXISTS idx_report_schedules_active ON public.report_schedules(is_active, next_run_at);

-- ============================================================
-- 4. TIMESHEET ENTRIES (For weekly timesheet reports)
-- ============================================================
CREATE TABLE IF NOT EXISTS public.timesheet_entries (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,

  -- WHO & WHERE
  employee_id UUID REFERENCES auth.users(id) NOT NULL,
  employee_name VARCHAR(255) NOT NULL,
  project_id UUID REFERENCES public.projects(id),

  -- WHEN
  work_date DATE NOT NULL,
  week_start_date DATE NOT NULL, -- Monday of the week

  -- HOURS
  regular_hours DECIMAL(5,2) DEFAULT 0 CHECK (regular_hours >= 0),
  overtime_hours DECIMAL(5,2) DEFAULT 0 CHECK (overtime_hours >= 0),
  total_hours DECIMAL(5,2) GENERATED ALWAYS AS (regular_hours + overtime_hours) STORED,

  -- RATES & COST
  hourly_rate DECIMAL(10,2),
  overtime_rate DECIMAL(10,2),
  total_cost DECIMAL(12,2) GENERATED ALWAYS AS (
    (regular_hours * COALESCE(hourly_rate, 0)) +
    (overtime_hours * COALESCE(overtime_rate, COALESCE(hourly_rate, 0) * 1.5))
  ) STORED,

  -- DETAILS
  task_description TEXT,
  trade VARCHAR(100), -- carpenter, electrician, plumber, etc.
  notes TEXT,

  -- APPROVAL
  approved BOOLEAN DEFAULT false,
  approved_by UUID REFERENCES auth.users(id),
  approved_at TIMESTAMPTZ,

  -- METADATA
  source VARCHAR(20) DEFAULT 'manual', -- manual, taskflow, imported
  synced_from_task_id UUID REFERENCES public.tasks(id),

  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_timesheet_entries_user_id ON public.timesheet_entries(user_id);
CREATE INDEX IF NOT EXISTS idx_timesheet_entries_employee ON public.timesheet_entries(employee_id);
CREATE INDEX IF NOT EXISTS idx_timesheet_entries_project ON public.timesheet_entries(project_id);
CREATE INDEX IF NOT EXISTS idx_timesheet_entries_date ON public.timesheet_entries(work_date);
CREATE INDEX IF NOT EXISTS idx_timesheet_entries_week ON public.timesheet_entries(week_start_date);

-- ============================================================
-- 5. ENABLE ROW LEVEL SECURITY
-- ============================================================
ALTER TABLE public.reports ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.report_templates ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.report_schedules ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.timesheet_entries ENABLE ROW LEVEL SECURITY;

-- ============================================================
-- 6. RLS POLICIES
-- ============================================================

-- REPORTS POLICIES
DROP POLICY IF EXISTS "Users can view their own reports" ON public.reports;
CREATE POLICY "Users can view their own reports"
  ON public.reports FOR SELECT
  USING (user_id = auth.uid());

DROP POLICY IF EXISTS "Users can create their own reports" ON public.reports;
CREATE POLICY "Users can create their own reports"
  ON public.reports FOR INSERT
  WITH CHECK (user_id = auth.uid());

DROP POLICY IF EXISTS "Users can update their own reports" ON public.reports;
CREATE POLICY "Users can update their own reports"
  ON public.reports FOR UPDATE
  USING (user_id = auth.uid());

DROP POLICY IF EXISTS "Users can delete their own reports" ON public.reports;
CREATE POLICY "Users can delete their own reports"
  ON public.reports FOR DELETE
  USING (user_id = auth.uid());

-- TEMPLATES POLICIES
DROP POLICY IF EXISTS "Users can view templates" ON public.report_templates;
CREATE POLICY "Users can view templates"
  ON public.report_templates FOR SELECT
  USING (user_id = auth.uid() OR is_public = true OR is_system_template = true);

DROP POLICY IF EXISTS "Users can manage their templates" ON public.report_templates;
CREATE POLICY "Users can manage their templates"
  ON public.report_templates FOR ALL
  USING (user_id = auth.uid());

-- SCHEDULES POLICIES
DROP POLICY IF EXISTS "Users can manage schedules" ON public.report_schedules;
CREATE POLICY "Users can manage schedules"
  ON public.report_schedules FOR ALL
  USING (user_id = auth.uid());

-- TIMESHEET POLICIES
DROP POLICY IF EXISTS "Users can manage timesheet entries" ON public.timesheet_entries;
CREATE POLICY "Users can manage timesheet entries"
  ON public.timesheet_entries FOR ALL
  USING (user_id = auth.uid());

-- ============================================================
-- 7. GRANT PERMISSIONS
-- ============================================================
GRANT ALL ON public.reports TO authenticated;
GRANT ALL ON public.report_templates TO authenticated;
GRANT ALL ON public.report_schedules TO authenticated;
GRANT ALL ON public.timesheet_entries TO authenticated;

-- ============================================================
-- 8. HELPER FUNCTIONS
-- ============================================================

-- Generate unique report number
CREATE OR REPLACE FUNCTION generate_report_number()
RETURNS TRIGGER AS $$
DECLARE
  year_prefix VARCHAR(4);
  type_prefix VARCHAR(10);
  sequence_num INTEGER;
  new_report_number VARCHAR(50);
BEGIN
  year_prefix := TO_CHAR(CURRENT_DATE, 'YYYY');

  type_prefix := CASE NEW.report_type
    WHEN 'daily' THEN 'DAILY'
    WHEN 'weekly_timesheet' THEN 'TIME'
    WHEN 'budget' THEN 'BUDG'
    WHEN 'safety' THEN 'SAFE'
    WHEN 'progress' THEN 'PROG'
    ELSE 'REPT'
  END;

  SELECT COALESCE(MAX(CAST(SUBSTRING(report_number FROM '\d+$') AS INTEGER)), 0) + 1
  INTO sequence_num
  FROM public.reports
  WHERE report_type = NEW.report_type
  AND EXTRACT(YEAR FROM created_at) = EXTRACT(YEAR FROM CURRENT_DATE)
  AND user_id = NEW.user_id;

  new_report_number := 'R-' || year_prefix || '-' || type_prefix || '-' || LPAD(sequence_num::TEXT, 3, '0');

  NEW.report_number := new_report_number;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

DROP TRIGGER IF EXISTS trigger_generate_report_number ON public.reports;
CREATE TRIGGER trigger_generate_report_number
BEFORE INSERT ON public.reports
FOR EACH ROW
WHEN (NEW.report_number IS NULL OR NEW.report_number = '')
EXECUTE FUNCTION generate_report_number();

-- Auto-update timestamps
CREATE OR REPLACE FUNCTION update_updated_at()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at := NOW();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

DROP TRIGGER IF EXISTS trigger_update_reports_timestamp ON public.reports;
CREATE TRIGGER trigger_update_reports_timestamp
BEFORE UPDATE ON public.reports
FOR EACH ROW
EXECUTE FUNCTION update_updated_at();

DROP TRIGGER IF EXISTS trigger_update_templates_timestamp ON public.report_templates;
CREATE TRIGGER trigger_update_templates_timestamp
BEFORE UPDATE ON public.report_templates
FOR EACH ROW
EXECUTE FUNCTION update_updated_at();

-- ============================================================
-- 9. INSERT SYSTEM TEMPLATES
-- ============================================================

-- DAILY PROGRESS REPORT TEMPLATE
INSERT INTO public.report_templates (
  id,
  name,
  description,
  template_type,
  category,
  sections,
  is_system_template,
  is_default,
  is_public
) VALUES (
  gen_random_uuid(),
  'Daily Progress Report',
  'Professional daily update for clients with photos, tasks completed, and crew attendance',
  'daily',
  'client',
  '[
    {
      "id": "header",
      "type": "header",
      "title": "Report Header",
      "fields": ["project_name", "date", "weather", "supervisor", "report_number"]
    },
    {
      "id": "summary",
      "type": "summary",
      "title": "Today''s Summary",
      "fields": ["tasks_completed_count", "crew_size", "hours_worked", "progress_percent"]
    },
    {
      "id": "tasks",
      "type": "table",
      "title": "Tasks Completed Today",
      "fields": ["task_name", "assigned_to", "status", "notes"]
    },
    {
      "id": "photos",
      "type": "gallery",
      "title": "Today''s Progress Photos",
      "settings": {"maxPhotos": 6, "columns": 3}
    },
    {
      "id": "crew",
      "type": "table",
      "title": "Crew Attendance",
      "fields": ["crew_member", "trade", "hours_worked", "notes"]
    },
    {
      "id": "materials",
      "type": "list",
      "title": "Materials Delivered/Used",
      "fields": ["material", "quantity", "supplier", "notes"]
    },
    {
      "id": "issues",
      "type": "list",
      "title": "Issues & Concerns",
      "fields": ["issue_type", "description", "severity", "action_taken"]
    },
    {
      "id": "tomorrow",
      "type": "section",
      "title": "Tomorrow''s Plan",
      "fields": ["planned_tasks", "crew_needed", "materials_needed", "special_requirements"]
    }
  ]'::jsonb,
  true,
  true,
  true
) ON CONFLICT DO NOTHING;

-- WEEKLY TIMESHEET TEMPLATE
INSERT INTO public.report_templates (
  id,
  name,
  description,
  template_type,
  category,
  sections,
  is_system_template,
  is_default,
  is_public
) VALUES (
  gen_random_uuid(),
  'Weekly Timesheet Report',
  'Payroll-ready timesheet with project allocation and overtime calculations',
  'weekly_timesheet',
  'internal',
  '[
    {
      "id": "summary",
      "type": "summary",
      "title": "Week Summary",
      "fields": ["week_ending", "total_hours", "regular_hours", "overtime_hours", "total_cost", "employee_count"]
    },
    {
      "id": "by_employee",
      "type": "table",
      "title": "Hours by Employee",
      "fields": ["employee", "project", "mon", "tue", "wed", "thu", "fri", "sat", "sun", "total", "rate", "cost"]
    },
    {
      "id": "by_project",
      "type": "table",
      "title": "Labor Cost by Project",
      "fields": ["project", "total_hours", "regular_hours", "overtime_hours", "labor_cost", "budget_impact"]
    },
    {
      "id": "overtime",
      "type": "table",
      "title": "Overtime Analysis",
      "fields": ["employee", "overtime_hours", "ot_cost", "reason", "approved_by"]
    }
  ]'::jsonb,
  true,
  true,
  true
) ON CONFLICT DO NOTHING;

-- BUDGET REPORT TEMPLATE
INSERT INTO public.report_templates (
  id,
  name,
  description,
  template_type,
  category,
  sections,
  is_system_template,
  is_default,
  is_public
) VALUES (
  gen_random_uuid(),
  'Project Budget Report',
  'Comprehensive budget vs actual analysis with profit tracking',
  'budget',
  'financial',
  '[
    {
      "id": "executive",
      "type": "summary",
      "title": "Executive Summary",
      "fields": ["project", "client", "budget", "spent", "remaining", "percent_complete", "profit", "margin"]
    },
    {
      "id": "breakdown",
      "type": "chart",
      "title": "Cost Breakdown",
      "chartType": "pie",
      "fields": ["labor", "materials", "equipment", "subcontractors", "overhead", "other"]
    },
    {
      "id": "budget_actual",
      "type": "table",
      "title": "Budget vs Actual",
      "fields": ["category", "budgeted", "actual", "variance", "variance_percent", "status"]
    },
    {
      "id": "change_orders",
      "type": "table",
      "title": "Change Orders Impact",
      "fields": ["change_order_number", "description", "amount", "approved", "date", "impact"]
    },
    {
      "id": "forecast",
      "type": "section",
      "title": "Project Forecast",
      "fields": ["estimated_completion", "estimated_final_cost", "estimated_profit", "risks", "recommendations"]
    }
  ]'::jsonb,
  true,
  true,
  true
) ON CONFLICT DO NOTHING;

-- ============================================================
-- SETUP COMPLETE!
-- ============================================================

SELECT 'ReportCenter Database Schema Created Successfully!' as status;




#end of sql 4


#start of sql 5 

-- ============================================================
-- QUOTEHUB MIGRATION SCRIPT
-- Safely migrate from old schema to enhanced schema
-- ============================================================

-- ============================================================
-- STEP 1: DROP OLD TRIGGERS AND FUNCTIONS (if they exist)
-- ============================================================

DROP TRIGGER IF EXISTS trigger_auto_convert_on_approval ON public.quotes;
DROP TRIGGER IF EXISTS trigger_log_quote_activity ON public.quotes;
DROP TRIGGER IF EXISTS trigger_generate_quote_number ON public.quotes;
DROP TRIGGER IF EXISTS trigger_update_quote_totals ON public.quote_items;
DROP TRIGGER IF EXISTS trigger_update_line_item_totals ON public.quote_items;

DROP FUNCTION IF EXISTS auto_convert_on_approval();
DROP FUNCTION IF EXISTS log_quote_activity();
DROP FUNCTION IF EXISTS generate_quote_number();
DROP FUNCTION IF EXISTS update_quote_totals();
DROP FUNCTION IF EXISTS update_line_item_totals();
DROP FUNCTION IF EXISTS convert_quote_to_project(UUID);
DROP FUNCTION IF EXISTS apply_change_order_to_project(UUID);
DROP FUNCTION IF EXISTS record_quote_view(UUID, VARCHAR, JSONB);
DROP FUNCTION IF EXISTS add_client_interaction(UUID, VARCHAR, TEXT, VARCHAR, VARCHAR, VARCHAR, UUID);

DROP VIEW IF EXISTS quote_analytics;

-- ============================================================
-- STEP 2: DROP OLD TABLES (start fresh)
-- ============================================================

DROP TABLE IF EXISTS public.quote_comments CASCADE;
DROP TABLE IF EXISTS public.quote_emails CASCADE;
DROP TABLE IF EXISTS public.quote_activities CASCADE;
DROP TABLE IF EXISTS public.quote_client_interactions CASCADE;
DROP TABLE IF EXISTS public.quote_templates CASCADE;
DROP TABLE IF EXISTS public.quote_items CASCADE;
DROP TABLE IF EXISTS public.quotes CASCADE;

-- ============================================================
-- STEP 3: CREATE ENHANCED SCHEMA (all tables)
-- ============================================================

-- 1. ENHANCED QUOTES TABLE
CREATE TABLE public.quotes (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,

  -- SMART NUMBERING: Q-2024-PROP-001
  quote_number VARCHAR(50) UNIQUE NOT NULL DEFAULT '',
  quote_type VARCHAR(20) DEFAULT 'proposal' CHECK (quote_type IN ('proposal', 'bid', 'estimate', 'change_order', 'maintenance')),
  year INTEGER DEFAULT EXTRACT(YEAR FROM NOW()),
  sequence_number INTEGER,

  -- CLIENT & PROJECT LINKS
  client_id UUID REFERENCES public.contacts(id) ON DELETE SET NULL,
  project_id UUID REFERENCES public.projects(id) ON DELETE SET NULL,
  original_quote_id UUID REFERENCES public.quotes(id),

  -- QUOTE DETAILS
  title VARCHAR(255) NOT NULL,
  description TEXT,
  scope_of_work TEXT,

  -- STATUS WORKFLOW
  status VARCHAR(20) DEFAULT 'draft' CHECK (status IN ('draft', 'ready', 'sent', 'viewed', 'commented', 'revised', 'approved', 'rejected', 'on_hold', 'expired', 'won', 'lost', 'cancelled')),
  sub_status VARCHAR(50),

  -- CONVERSION TRACKING
  converted_to_project_id UUID REFERENCES public.projects(id),
  converted_at TIMESTAMPTZ,
  conversion_type VARCHAR(20) CHECK (conversion_type IN ('new_project', 'change_order', 'maintenance_schedule', NULL)),
  auto_create_project BOOLEAN DEFAULT true,
  auto_create_tasks BOOLEAN DEFAULT true,

  -- FINANCIALS
  subtotal DECIMAL(12,2) DEFAULT 0,
  tax_rate DECIMAL(5,2) DEFAULT 0,
  tax_amount DECIMAL(12,2) DEFAULT 0,
  discount_type VARCHAR(20) DEFAULT 'fixed',
  discount_value DECIMAL(10,2) DEFAULT 0,
  discount_amount DECIMAL(12,2) DEFAULT 0,
  total_amount DECIMAL(12,2) DEFAULT 0,
  deposit_required DECIMAL(5,2) DEFAULT 0,
  deposit_amount DECIMAL(12,2) DEFAULT 0,
  deposit_received BOOLEAN DEFAULT false,
  currency VARCHAR(3) DEFAULT 'USD',

  -- PROFIT TRACKING
  total_cost DECIMAL(12,2) DEFAULT 0,
  profit_margin DECIMAL(5,2) GENERATED ALWAYS AS (
    CASE
      WHEN subtotal > 0
      THEN ((subtotal - total_cost) / subtotal * 100)
      ELSE 0
    END
  ) STORED,

  -- DATES
  quote_date DATE DEFAULT CURRENT_DATE,
  valid_until DATE,
  sent_at TIMESTAMPTZ,
  first_viewed_at TIMESTAMPTZ,
  last_viewed_at TIMESTAMPTZ,
  client_approved_at TIMESTAMPTZ,
  client_rejected_at TIMESTAMPTZ,

  -- TRACKING
  view_count INTEGER DEFAULT 0,
  revision_count INTEGER DEFAULT 0,
  email_sent_count INTEGER DEFAULT 0,

  -- APPROVAL & REJECTION
  approved_by VARCHAR(255),
  rejection_reason TEXT,

  -- CONTENT
  notes TEXT,
  internal_notes TEXT,
  terms_conditions TEXT,
  payment_terms TEXT,
  branding JSONB DEFAULT '{"logo": null, "primaryColor": "#2563EB", "accentColor": "#F97316"}'::jsonb,

  -- METADATA
  created_by UUID REFERENCES auth.users(id),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Indexes
CREATE INDEX idx_quotes_quote_number ON public.quotes(quote_number);
CREATE INDEX idx_quotes_user_id ON public.quotes(user_id);
CREATE INDEX idx_quotes_status ON public.quotes(status);
CREATE INDEX idx_quotes_type ON public.quotes(quote_type);
CREATE INDEX idx_quotes_client_id ON public.quotes(client_id);
CREATE INDEX idx_quotes_project_id ON public.quotes(project_id);
CREATE INDEX idx_quotes_converted_project ON public.quotes(converted_to_project_id);

-- 2. QUOTE LINE ITEMS
CREATE TABLE public.quote_items (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  quote_id UUID REFERENCES public.quotes(id) ON DELETE CASCADE NOT NULL,
  item_number INTEGER NOT NULL,

  -- TASK CONVERSION
  convert_to_task BOOLEAN DEFAULT true,
  created_task_id UUID REFERENCES public.tasks(id),

  -- ITEM DETAILS
  category VARCHAR(100),
  description TEXT NOT NULL,
  detailed_description TEXT,
  benefits TEXT,

  -- QUANTITY & PRICING
  quantity DECIMAL(10,2) DEFAULT 1 CHECK (quantity > 0),
  unit VARCHAR(50) DEFAULT 'ea',
  unit_price DECIMAL(12,2) NOT NULL CHECK (unit_price >= 0),

  -- COST & MARGIN
  cost_price DECIMAL(12,2),
  markup_percentage DECIMAL(5,2),
  margin DECIMAL(5,2) GENERATED ALWAYS AS (
    CASE
      WHEN unit_price > 0 AND cost_price > 0
      THEN ((unit_price - cost_price) / unit_price * 100)
      ELSE 0
    END
  ) STORED,

  -- TAX
  tax_rate DECIMAL(5,2) DEFAULT 0,
  tax_amount DECIMAL(12,2) DEFAULT 0,
  is_taxable BOOLEAN DEFAULT true,

  -- TOTALS
  line_total DECIMAL(12,2) DEFAULT 0,

  -- FLAGS
  is_optional BOOLEAN DEFAULT false,
  is_allowance BOOLEAN DEFAULT false,

  -- ORDERING
  sort_order INTEGER DEFAULT 0,
  notes TEXT,

  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_quote_items_quote_id ON public.quote_items(quote_id);
CREATE INDEX idx_quote_items_sort_order ON public.quote_items(quote_id, sort_order);
CREATE INDEX idx_quote_items_task ON public.quote_items(created_task_id);

-- 3. QUOTE ACTIVITIES
CREATE TABLE public.quote_activities (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  quote_id UUID REFERENCES public.quotes(id) ON DELETE CASCADE NOT NULL,
  activity_type VARCHAR(50) NOT NULL,
  user_id UUID REFERENCES auth.users(id),
  client_name VARCHAR(255),
  description TEXT,
  metadata JSONB DEFAULT '{}'::jsonb,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_quote_activities_quote_id ON public.quote_activities(quote_id);
CREATE INDEX idx_quote_activities_created_at ON public.quote_activities(created_at DESC);

-- 4. CLIENT INTERACTIONS
CREATE TABLE public.quote_client_interactions (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  quote_id UUID REFERENCES public.quotes(id) ON DELETE CASCADE NOT NULL,
  interaction_type VARCHAR(50) NOT NULL,
  target_type VARCHAR(50),
  target_id UUID,
  content TEXT NOT NULL,
  client_name VARCHAR(255),
  client_email VARCHAR(255),
  resolved BOOLEAN DEFAULT false,
  resolved_by UUID REFERENCES auth.users(id),
  resolved_at TIMESTAMPTZ,
  resolution_notes TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_client_interactions_quote ON public.quote_client_interactions(quote_id);
CREATE INDEX idx_client_interactions_target ON public.quote_client_interactions(target_id);

-- 5. QUOTE TEMPLATES
CREATE TABLE public.quote_templates (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
  name VARCHAR(255) NOT NULL,
  description TEXT,
  template_type VARCHAR(20) DEFAULT 'proposal' CHECK (template_type IN ('proposal', 'bid', 'estimate', 'change_order', 'maintenance')),
  category VARCHAR(100),
  content JSONB NOT NULL DEFAULT '{}'::jsonb,
  default_items JSONB DEFAULT '[]'::jsonb,
  default_terms TEXT,
  default_payment_terms TEXT,
  default_tax_rate DECIMAL(5,2) DEFAULT 0,
  default_valid_days INTEGER DEFAULT 30,
  use_count INTEGER DEFAULT 0,
  last_used_at TIMESTAMPTZ,
  is_public BOOLEAN DEFAULT false,
  is_system_template BOOLEAN DEFAULT false,
  is_favorite BOOLEAN DEFAULT false,
  created_by UUID REFERENCES auth.users(id),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_quote_templates_user_id ON public.quote_templates(user_id);
CREATE INDEX idx_quote_templates_type ON public.quote_templates(template_type);
CREATE INDEX idx_quote_templates_category ON public.quote_templates(category);

-- ============================================================
-- STEP 4: ENABLE RLS
-- ============================================================

ALTER TABLE public.quotes ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.quote_items ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.quote_activities ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.quote_client_interactions ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.quote_templates ENABLE ROW LEVEL SECURITY;

-- ============================================================
-- STEP 5: CREATE RLS POLICIES
-- ============================================================

CREATE POLICY "Users can view their own quotes"
  ON public.quotes FOR SELECT
  USING (user_id = auth.uid());

CREATE POLICY "Users can insert their own quotes"
  ON public.quotes FOR INSERT
  WITH CHECK (user_id = auth.uid());

CREATE POLICY "Users can update their own quotes"
  ON public.quotes FOR UPDATE
  USING (user_id = auth.uid());

CREATE POLICY "Users can delete their own quotes"
  ON public.quotes FOR DELETE
  USING (user_id = auth.uid());

CREATE POLICY "Users can manage quote items"
  ON public.quote_items FOR ALL
  USING (
    quote_id IN (
      SELECT id FROM public.quotes WHERE user_id = auth.uid()
    )
  );

CREATE POLICY "Users can manage quote activities"
  ON public.quote_activities FOR ALL
  USING (
    quote_id IN (
      SELECT id FROM public.quotes WHERE user_id = auth.uid()
    )
  );

CREATE POLICY "Users can manage client interactions"
  ON public.quote_client_interactions FOR ALL
  USING (
    quote_id IN (
      SELECT id FROM public.quotes WHERE user_id = auth.uid()
    )
  );

CREATE POLICY "Users can view templates"
  ON public.quote_templates FOR SELECT
  USING (user_id = auth.uid() OR is_public = true);

CREATE POLICY "Users can manage their templates"
  ON public.quote_templates FOR ALL
  USING (user_id = auth.uid());

-- ============================================================
-- STEP 6: GRANT PERMISSIONS
-- ============================================================

GRANT ALL ON public.quotes TO authenticated;
GRANT ALL ON public.quote_items TO authenticated;
GRANT ALL ON public.quote_activities TO authenticated;
GRANT ALL ON public.quote_client_interactions TO authenticated;
GRANT ALL ON public.quote_templates TO authenticated;

-- ============================================================
-- STEP 7: CREATE FUNCTIONS
-- ============================================================

-- Update line item totals
CREATE OR REPLACE FUNCTION update_line_item_totals()
RETURNS TRIGGER AS $$
BEGIN
  NEW.line_total := NEW.quantity * NEW.unit_price;
  IF NEW.is_taxable THEN
    NEW.tax_amount := NEW.line_total * (NEW.tax_rate / 100);
  ELSE
    NEW.tax_amount := 0;
  END IF;
  NEW.updated_at := NOW();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_update_line_item_totals
BEFORE INSERT OR UPDATE ON public.quote_items
FOR EACH ROW
EXECUTE FUNCTION update_line_item_totals();

-- Update quote totals
CREATE OR REPLACE FUNCTION update_quote_totals()
RETURNS TRIGGER AS $$
DECLARE
  quote_subtotal DECIMAL(12,2);
  quote_cost DECIMAL(12,2);
  quote_tax DECIMAL(12,2);
  quote_discount DECIMAL(12,2);
  quote_total DECIMAL(12,2);
  quote_deposit DECIMAL(12,2);
  quote_record RECORD;
BEGIN
  SELECT * INTO quote_record FROM public.quotes
  WHERE id = COALESCE(NEW.quote_id, OLD.quote_id);

  SELECT
    COALESCE(SUM(line_total), 0),
    COALESCE(SUM(quantity * COALESCE(cost_price, 0)), 0)
  INTO quote_subtotal, quote_cost
  FROM public.quote_items
  WHERE quote_id = quote_record.id;

  quote_tax := quote_subtotal * (quote_record.tax_rate / 100);

  IF quote_record.discount_type = 'percentage' THEN
    quote_discount := quote_subtotal * (quote_record.discount_value / 100);
  ELSE
    quote_discount := quote_record.discount_value;
  END IF;

  quote_total := quote_subtotal + quote_tax - quote_discount;
  quote_deposit := quote_total * (quote_record.deposit_required / 100);

  UPDATE public.quotes
  SET
    subtotal = quote_subtotal,
    total_cost = quote_cost,
    tax_amount = quote_tax,
    discount_amount = quote_discount,
    total_amount = quote_total,
    deposit_amount = quote_deposit,
    updated_at = NOW()
  WHERE id = quote_record.id;

  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_update_quote_totals
AFTER INSERT OR UPDATE OR DELETE ON public.quote_items
FOR EACH ROW
EXECUTE FUNCTION update_quote_totals();

-- Smart quote numbering
CREATE OR REPLACE FUNCTION generate_quote_number()
RETURNS TRIGGER AS $$
DECLARE
  year_prefix VARCHAR(4);
  type_prefix VARCHAR(4);
  sequence_num INTEGER;
  new_quote_number VARCHAR(50);
BEGIN
  year_prefix := TO_CHAR(CURRENT_DATE, 'YYYY');

  type_prefix := CASE NEW.quote_type
    WHEN 'proposal' THEN 'PROP'
    WHEN 'bid' THEN 'BID'
    WHEN 'estimate' THEN 'EST'
    WHEN 'change_order' THEN 'CHG'
    WHEN 'maintenance' THEN 'MNT'
    ELSE 'QUOT'
  END;

  SELECT COALESCE(MAX(sequence_number), 0) + 1 INTO sequence_num
  FROM public.quotes
  WHERE quote_type = NEW.quote_type
  AND year = EXTRACT(YEAR FROM CURRENT_DATE)
  AND user_id = NEW.user_id;

  new_quote_number := 'Q-' || year_prefix || '-' || type_prefix || '-' || LPAD(sequence_num::TEXT, 3, '0');

  NEW.quote_number := new_quote_number;
  NEW.year := EXTRACT(YEAR FROM CURRENT_DATE);
  NEW.sequence_number := sequence_num;

  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_generate_quote_number
BEFORE INSERT ON public.quotes
FOR EACH ROW
WHEN (NEW.quote_number IS NULL OR NEW.quote_number = '')
EXECUTE FUNCTION generate_quote_number();

-- Log activities
CREATE OR REPLACE FUNCTION log_quote_activity()
RETURNS TRIGGER AS $$
BEGIN
  IF TG_OP = 'INSERT' THEN
    INSERT INTO public.quote_activities (quote_id, activity_type, description, user_id)
    VALUES (NEW.id, 'created', 'Quote created', NEW.created_by);
  ELSIF TG_OP = 'UPDATE' THEN
    IF OLD.status != NEW.status THEN
      INSERT INTO public.quote_activities (quote_id, activity_type, description, user_id, metadata)
      VALUES (
        NEW.id,
        'status_changed',
        'Status changed from ' || OLD.status || ' to ' || NEW.status,
        NEW.created_by,
        jsonb_build_object('old_status', OLD.status, 'new_status', NEW.status)
      );
    END IF;
    IF OLD.converted_to_project_id IS NULL AND NEW.converted_to_project_id IS NOT NULL THEN
      INSERT INTO public.quote_activities (quote_id, activity_type, description, user_id, metadata)
      VALUES (
        NEW.id,
        'converted_to_project',
        'Quote converted to project',
        NEW.created_by,
        jsonb_build_object('project_id', NEW.converted_to_project_id, 'conversion_type', NEW.conversion_type)
      );
    END IF;
  END IF;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_log_quote_activity
AFTER INSERT OR UPDATE ON public.quotes
FOR EACH ROW
EXECUTE FUNCTION log_quote_activity();

-- Convert quote to project
CREATE OR REPLACE FUNCTION convert_quote_to_project(quote_id_param UUID)
RETURNS UUID AS $$
DECLARE
  quote_record RECORD;
  new_project_id UUID;
  item_record RECORD;
  new_task_id UUID;
BEGIN
  SELECT * INTO quote_record FROM public.quotes WHERE id = quote_id_param;
  IF NOT FOUND THEN RAISE EXCEPTION 'Quote not found'; END IF;
  IF quote_record.status != 'approved' THEN RAISE EXCEPTION 'Quote must be approved'; END IF;
  IF quote_record.converted_to_project_id IS NOT NULL THEN RAISE EXCEPTION 'Already converted'; END IF;

  INSERT INTO public.projects (user_id, name, description, client_id, status, start_date, budget, created_at, updated_at)
  VALUES (quote_record.user_id, quote_record.title, 'Created from ' || quote_record.quote_number, quote_record.client_id, 'planning', CURRENT_DATE, quote_record.total_amount, NOW(), NOW())
  RETURNING id INTO new_project_id;

  UPDATE public.quotes SET converted_to_project_id = new_project_id, converted_at = NOW(), conversion_type = 'new_project', updated_at = NOW() WHERE id = quote_id_param;

  IF quote_record.auto_create_tasks THEN
    FOR item_record IN SELECT * FROM public.quote_items WHERE quote_id = quote_id_param AND convert_to_task = true ORDER BY sort_order
    LOOP
      INSERT INTO public.tasks (user_id, project_id, title, description, status, priority, estimated_hours, created_at, updated_at)
      VALUES (quote_record.user_id, new_project_id, item_record.description, COALESCE(item_record.detailed_description, item_record.notes, ''), 'pending', 'medium', CASE WHEN item_record.unit = 'hours' THEN item_record.quantity ELSE NULL END, NOW(), NOW())
      RETURNING id INTO new_task_id;

      UPDATE public.quote_items SET created_task_id = new_task_id WHERE id = item_record.id;
    END LOOP;
  END IF;

  INSERT INTO public.quote_activities (quote_id, activity_type, description, user_id, metadata)
  VALUES (quote_id_param, 'converted_to_project', 'Quote converted to project: ' || new_project_id, quote_record.user_id, jsonb_build_object('project_id', new_project_id, 'conversion_type', 'new_project'));

  RETURN new_project_id;
END;
$$ LANGUAGE plpgsql;

-- Apply change order
CREATE OR REPLACE FUNCTION apply_change_order_to_project(quote_id_param UUID)
RETURNS UUID AS $$
DECLARE
  quote_record RECORD;
  target_project_id UUID;
  item_record RECORD;
  new_task_id UUID;
  current_budget DECIMAL(12,2);
BEGIN
  SELECT * INTO quote_record FROM public.quotes WHERE id = quote_id_param;
  IF NOT FOUND THEN RAISE EXCEPTION 'Quote not found'; END IF;
  IF quote_record.quote_type != 'change_order' THEN RAISE EXCEPTION 'Must be change order'; END IF;
  IF quote_record.status != 'approved' THEN RAISE EXCEPTION 'Must be approved'; END IF;
  IF quote_record.project_id IS NULL THEN RAISE EXCEPTION 'Must be linked to project'; END IF;

  target_project_id := quote_record.project_id;
  SELECT budget INTO current_budget FROM public.projects WHERE id = target_project_id;

  UPDATE public.projects SET budget = current_budget + quote_record.total_amount, updated_at = NOW() WHERE id = target_project_id;
  UPDATE public.quotes SET converted_to_project_id = target_project_id, converted_at = NOW(), conversion_type = 'change_order', updated_at = NOW() WHERE id = quote_id_param;

  IF quote_record.auto_create_tasks THEN
    FOR item_record IN SELECT * FROM public.quote_items WHERE quote_id = quote_id_param AND convert_to_task = true ORDER BY sort_order
    LOOP
      INSERT INTO public.tasks (user_id, project_id, title, description, status, priority, estimated_hours, created_at, updated_at)
      VALUES (quote_record.user_id, target_project_id, '[CHANGE ORDER] ' || item_record.description, 'From ' || quote_record.quote_number, 'pending', 'high', CASE WHEN item_record.unit = 'hours' THEN item_record.quantity ELSE NULL END, NOW(), NOW())
      RETURNING id INTO new_task_id;

      UPDATE public.quote_items SET created_task_id = new_task_id WHERE id = item_record.id;
    END LOOP;
  END IF;

  INSERT INTO public.quote_activities (quote_id, activity_type, description, user_id, metadata)
  VALUES (quote_id_param, 'change_order_applied', 'Change order applied to project: ' || target_project_id, quote_record.user_id, jsonb_build_object('project_id', target_project_id, 'budget_increase', quote_record.total_amount));

  RETURN target_project_id;
END;
$$ LANGUAGE plpgsql;

-- Auto-convert on approval
CREATE OR REPLACE FUNCTION auto_convert_on_approval()
RETURNS TRIGGER AS $$
BEGIN
  IF OLD.status != 'approved' AND NEW.status = 'approved' THEN
    IF NEW.auto_create_project THEN
      IF NEW.quote_type IN ('proposal', 'bid') THEN
        PERFORM convert_quote_to_project(NEW.id);
      ELSIF NEW.quote_type = 'change_order' AND NEW.project_id IS NOT NULL THEN
        PERFORM apply_change_order_to_project(NEW.id);
      END IF;
    END IF;
  END IF;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_auto_convert_on_approval
AFTER UPDATE ON public.quotes
FOR EACH ROW
EXECUTE FUNCTION auto_convert_on_approval();

-- Client portal functions
CREATE OR REPLACE FUNCTION record_quote_view(quote_id_param UUID, client_name_param VARCHAR(255) DEFAULT NULL, metadata_param JSONB DEFAULT '{}'::jsonb)
RETURNS VOID AS $$
BEGIN
  UPDATE public.quotes SET view_count = view_count + 1, last_viewed_at = NOW(), first_viewed_at = COALESCE(first_viewed_at, NOW()), updated_at = NOW() WHERE id = quote_id_param;
  UPDATE public.quotes SET status = 'viewed' WHERE id = quote_id_param AND status = 'sent';
  INSERT INTO public.quote_activities (quote_id, activity_type, description, client_name, metadata) VALUES (quote_id_param, 'viewed', 'Quote viewed by client', client_name_param, metadata_param);
END;
$$ LANGUAGE plpgsql;

CREATE OR REPLACE FUNCTION add_client_interaction(quote_id_param UUID, interaction_type_param VARCHAR(50), content_param TEXT, client_name_param VARCHAR(255), client_email_param VARCHAR(255), target_type_param VARCHAR(50) DEFAULT NULL, target_id_param UUID DEFAULT NULL)
RETURNS UUID AS $$
DECLARE new_interaction_id UUID;
BEGIN
  INSERT INTO public.quote_client_interactions (quote_id, interaction_type, content, client_name, client_email, target_type, target_id) VALUES (quote_id_param, interaction_type_param, content_param, client_name_param, client_email_param, target_type_param, target_id_param) RETURNING id INTO new_interaction_id;
  UPDATE public.quotes SET status = 'commented' WHERE id = quote_id_param AND status IN ('sent', 'viewed');
  INSERT INTO public.quote_activities (quote_id, activity_type, description, client_name, metadata) VALUES (quote_id_param, 'client_' || interaction_type_param, 'Client ' || interaction_type_param || ': ' || LEFT(content_param, 100), client_name_param, jsonb_build_object('interaction_id', new_interaction_id, 'interaction_type', interaction_type_param));
  RETURN new_interaction_id;
END;
$$ LANGUAGE plpgsql;

-- Analytics view
CREATE OR REPLACE VIEW quote_analytics AS
SELECT q.user_id, q.quote_type, q.status, DATE_TRUNC('month', q.created_at) as month, COUNT(*) as quote_count, SUM(q.total_amount) as total_value, AVG(q.total_amount) as avg_value, AVG(q.profit_margin) as avg_margin, COUNT(CASE WHEN q.status = 'approved' THEN 1 END) as approved_count, COUNT(CASE WHEN q.status = 'rejected' THEN 1 END) as rejected_count, COUNT(CASE WHEN q.converted_to_project_id IS NOT NULL THEN 1 END) as converted_count, AVG(EXTRACT(EPOCH FROM (q.client_approved_at - q.sent_at)) / 86400) as avg_days_to_approval
FROM public.quotes q
GROUP BY q.user_id, q.quote_type, q.status, DATE_TRUNC('month', q.created_at);

-- ============================================================
-- MIGRATION COMPLETE!
-- ============================================================

SELECT 'QuoteHub Enhanced Schema - Migration Complete!' as status;
