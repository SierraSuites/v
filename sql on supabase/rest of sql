#10

-- FIX: Remove duplicate RLS policies causing infinite recursion
-- Run this to fix the "infinite recursion detected in policy" error
-- ============================================================

-- Drop ALL existing policies on projects table
DROP POLICY IF EXISTS "Users can view their own projects" ON public.projects;
DROP POLICY IF EXISTS "Users can view projects where they are members" ON public.projects;
DROP POLICY IF EXISTS "Users can insert their own projects" ON public.projects;
DROP POLICY IF EXISTS "Users can update their own projects" ON public.projects;
DROP POLICY IF EXISTS "Project members with edit permission can update projects" ON public.projects;
DROP POLICY IF EXISTS "Users can delete their own projects" ON public.projects;

-- Also drop any policies from ESSENTIAL_SQL_SETUP.sql
DROP POLICY IF EXISTS "Enable read access for users" ON public.projects;
DROP POLICY IF EXISTS "Enable insert for users" ON public.projects;
DROP POLICY IF EXISTS "Enable update for users" ON public.projects;
DROP POLICY IF EXISTS "Enable delete for users" ON public.projects;

-- ============================================================
-- RECREATE CLEAN RLS POLICIES (no recursion)
-- ============================================================

-- Policy: Users can view their own projects
CREATE POLICY "Users can view their own projects"
  ON public.projects FOR SELECT
  USING (auth.uid() = user_id);

-- Policy: Users can insert their own projects
CREATE POLICY "Users can insert their own projects"
  ON public.projects FOR INSERT
  WITH CHECK (auth.uid() = user_id);

-- Policy: Users can update their own projects
CREATE POLICY "Users can update their own projects"
  ON public.projects FOR UPDATE
  USING (auth.uid() = user_id);

-- Policy: Users can delete their own projects
CREATE POLICY "Users can delete their own projects"
  ON public.projects FOR DELETE
  USING (auth.uid() = user_id);

-- ============================================================
-- VERIFY RLS IS ENABLED
-- ============================================================

ALTER TABLE public.projects ENABLE ROW LEVEL SECURITY;

-- ============================================================
-- COMPLETED!
-- The infinite recursion issue should now be fixed
-- Refresh your app and try creating a project
-- ============================================================


#11

-- Drop existing policies
DROP POLICY IF EXISTS "Users can view their own projects" ON public.projects;
DROP POLICY IF EXISTS "Users can insert their own projects" ON public.projects;
DROP POLICY IF EXISTS "Users can update their own projects" ON public.projects;
DROP POLICY IF EXISTS "Users can delete their own projects" ON public.projects;

-- Disable RLS to grant permissions
ALTER TABLE public.projects DISABLE ROW LEVEL SECURITY;

-- Grant permissions
GRANT ALL ON public.projects TO authenticated;
GRANT ALL ON public.projects TO anon;

-- Re-enable RLS
ALTER TABLE public.projects ENABLE ROW LEVEL SECURITY;

-- Create wide-open policy for testing
CREATE POLICY "authenticated_all" ON public.projects 
  FOR ALL TO authenticated 
  USING (true) 
  WITH CHECK (true);

  #12

  -- ============================================================
-- FIX: Grant permissions for tasks table and related tables
-- Run this to fix "Error fetching tasks" permission errors
-- ============================================================

-- Grant permissions on tasks table
GRANT ALL ON public.tasks TO authenticated;
GRANT ALL ON public.tasks TO anon;

-- Grant permissions on related tables
GRANT ALL ON public.team_members TO authenticated;
GRANT ALL ON public.team_members TO anon;

GRANT ALL ON public.task_comments TO authenticated;
GRANT ALL ON public.task_comments TO anon;

GRANT ALL ON public.task_attachments TO authenticated;
GRANT ALL ON public.task_attachments TO anon;

-- ============================================================
-- COMPLETED!
-- Tasks permissions have been granted
-- You can now use TaskFlow without permission errors
-- ============================================================


#13

-- Drop existing policies
DROP POLICY IF EXISTS "Users can view their own tasks" ON public.tasks;
DROP POLICY IF EXISTS "Users can insert their own tasks" ON public.tasks;
DROP POLICY IF EXISTS "Users can update their own tasks" ON public.tasks;
DROP POLICY IF EXISTS "Users can delete their own tasks" ON public.tasks;
DROP POLICY IF EXISTS "Assigned users can view their assigned tasks" ON public.tasks;
DROP POLICY IF EXISTS "Assigned users can update their assigned tasks" ON public.tasks;

-- Disable RLS temporarily
ALTER TABLE public.tasks DISABLE ROW LEVEL SECURITY;

-- Grant permissions
GRANT ALL ON public.tasks TO authenticated;
GRANT ALL ON public.tasks TO anon;
GRANT ALL ON public.team_members TO authenticated;
GRANT ALL ON public.team_members TO anon;
GRANT ALL ON public.task_comments TO authenticated;
GRANT ALL ON public.task_comments TO anon;
GRANT ALL ON public.task_attachments TO authenticated;
GRANT ALL ON public.task_attachments TO anon;

-- Re-enable RLS
ALTER TABLE public.tasks ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.team_members ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.task_comments ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.task_attachments ENABLE ROW LEVEL SECURITY;

-- Create wide-open policies
CREATE POLICY "authenticated_all" ON public.tasks
  FOR ALL TO authenticated
  USING (true)
  WITH CHECK (true);

CREATE POLICY "authenticated_all" ON public.team_members
  FOR ALL TO authenticated
  USING (true)
  WITH CHECK (true);

CREATE POLICY "authenticated_all" ON public.task_comments
  FOR ALL TO authenticated
  USING (true)
  WITH CHECK (true);

CREATE POLICY "authenticated_all" ON public.task_attachments
  FOR ALL TO authenticated
  USING (true)
  WITH CHECK (true);

  #14

  -- ============================================================
-- QUOTEHUB COMPLETE DATABASE SETUP
-- Run this in Supabase SQL Editor to set up QuoteHub module
-- ============================================================

-- ============================================================
-- 1. CREATE CONTACTS TABLE (for clients)
-- ============================================================
CREATE TABLE IF NOT EXISTS public.contacts (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
  company_name VARCHAR(255),
  contact_name VARCHAR(255) NOT NULL,
  email VARCHAR(255),
  phone VARCHAR(50),
  address TEXT,
  city VARCHAR(100),
  state VARCHAR(100),
  zip VARCHAR(20),
  country VARCHAR(100) DEFAULT 'United States',
  contact_type VARCHAR(50) DEFAULT 'client', -- client, vendor, subcontractor
  notes TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- ============================================================
-- 2. CREATE QUOTES TABLE
-- ============================================================
CREATE TABLE IF NOT EXISTS public.quotes (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
  quote_number VARCHAR(50) UNIQUE NOT NULL,
  client_id UUID REFERENCES public.contacts(id) ON DELETE SET NULL,
  project_id UUID REFERENCES public.projects(id) ON DELETE SET NULL,
  title VARCHAR(255) NOT NULL,
  description TEXT,
  status VARCHAR(20) DEFAULT 'draft' CHECK (status IN ('draft', 'sent', 'viewed', 'approved', 'rejected', 'expired')),

  -- Financial fields
  subtotal DECIMAL(12,2) DEFAULT 0,
  tax_rate DECIMAL(5,2) DEFAULT 0,
  tax_amount DECIMAL(12,2) DEFAULT 0,
  discount_type VARCHAR(20) DEFAULT 'fixed', -- fixed or percentage
  discount_value DECIMAL(10,2) DEFAULT 0,
  discount_amount DECIMAL(10,2) DEFAULT 0,
  total_amount DECIMAL(12,2) DEFAULT 0,
  deposit_required DECIMAL(5,2) DEFAULT 0,
  deposit_amount DECIMAL(12,2) DEFAULT 0,
  currency VARCHAR(3) DEFAULT 'USD',

  -- Dates
  quote_date DATE DEFAULT CURRENT_DATE,
  valid_until DATE,
  sent_at TIMESTAMPTZ,
  viewed_at TIMESTAMPTZ,
  approved_at TIMESTAMPTZ,
  rejected_at TIMESTAMPTZ,

  -- Additional details
  approved_by VARCHAR(255),
  rejection_reason TEXT,
  notes TEXT,
  internal_notes TEXT,
  terms_conditions TEXT,
  payment_terms TEXT,

  -- Branding and customization
  branding JSONB DEFAULT '{"logo": null, "primaryColor": "#2563EB", "accentColor": "#F97316"}'::jsonb,

  -- Tracking
  email_sent_count INTEGER DEFAULT 0,
  last_email_sent_at TIMESTAMPTZ,
  view_count INTEGER DEFAULT 0,

  -- Metadata
  created_by UUID REFERENCES auth.users(id),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Create index for quote number lookup
CREATE INDEX IF NOT EXISTS idx_quotes_quote_number ON public.quotes(quote_number);
CREATE INDEX IF NOT EXISTS idx_quotes_user_id ON public.quotes(user_id);
CREATE INDEX IF NOT EXISTS idx_quotes_status ON public.quotes(status);
CREATE INDEX IF NOT EXISTS idx_quotes_client_id ON public.quotes(client_id);

-- ============================================================
-- 3. CREATE QUOTE LINE ITEMS TABLE
-- ============================================================
CREATE TABLE IF NOT EXISTS public.quote_items (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  quote_id UUID REFERENCES public.quotes(id) ON DELETE CASCADE NOT NULL,
  item_number INTEGER NOT NULL,
  category VARCHAR(100),
  description TEXT NOT NULL,
  quantity DECIMAL(10,2) DEFAULT 1 CHECK (quantity > 0),
  unit VARCHAR(50) DEFAULT 'ea',
  unit_price DECIMAL(12,2) NOT NULL CHECK (unit_price >= 0),
  tax_rate DECIMAL(5,2) DEFAULT 0,
  tax_amount DECIMAL(12,2) DEFAULT 0,
  line_total DECIMAL(12,2) DEFAULT 0,
  notes TEXT,
  sort_order INTEGER DEFAULT 0,
  is_optional BOOLEAN DEFAULT false,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_quote_items_quote_id ON public.quote_items(quote_id);
CREATE INDEX IF NOT EXISTS idx_quote_items_sort_order ON public.quote_items(quote_id, sort_order);

-- ============================================================
-- 4. CREATE QUOTE TEMPLATES TABLE
-- ============================================================
CREATE TABLE IF NOT EXISTS public.quote_templates (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
  name VARCHAR(255) NOT NULL,
  description TEXT,
  category VARCHAR(100),
  template_type VARCHAR(50) DEFAULT 'custom', -- custom, system, shared

  -- Template content
  content JSONB NOT NULL DEFAULT '{}'::jsonb,
  -- Structure: { "items": [...], "settings": {...}, "branding": {...} }

  -- Template settings
  default_terms TEXT,
  default_payment_terms TEXT,
  default_tax_rate DECIMAL(5,2) DEFAULT 0,
  default_valid_days INTEGER DEFAULT 30,

  -- Usage tracking
  is_public BOOLEAN DEFAULT false,
  is_favorite BOOLEAN DEFAULT false,
  use_count INTEGER DEFAULT 0,
  last_used_at TIMESTAMPTZ,

  created_by UUID REFERENCES auth.users(id),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_quote_templates_user_id ON public.quote_templates(user_id);
CREATE INDEX IF NOT EXISTS idx_quote_templates_category ON public.quote_templates(category);

-- ============================================================
-- 5. CREATE QUOTE ACTIVITIES TABLE
-- ============================================================
CREATE TABLE IF NOT EXISTS public.quote_activities (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  quote_id UUID REFERENCES public.quotes(id) ON DELETE CASCADE NOT NULL,
  activity_type VARCHAR(50) NOT NULL,
  -- Types: created, edited, sent, viewed, commented, approved, rejected, expired, converted
  description TEXT,
  metadata JSONB DEFAULT '{}'::jsonb,
  -- Metadata can include: {ip_address, user_agent, location, changes, etc.}

  created_by UUID REFERENCES auth.users(id),
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_quote_activities_quote_id ON public.quote_activities(quote_id);
CREATE INDEX IF NOT EXISTS idx_quote_activities_created_at ON public.quote_activities(created_at DESC);

-- ============================================================
-- 6. CREATE QUOTE EMAIL TRACKING TABLE
-- ============================================================
CREATE TABLE IF NOT EXISTS public.quote_emails (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  quote_id UUID REFERENCES public.quotes(id) ON DELETE CASCADE NOT NULL,
  sent_to VARCHAR(255) NOT NULL,
  sent_from VARCHAR(255),
  subject VARCHAR(500),
  message_body TEXT,

  -- Tracking
  sent_at TIMESTAMPTZ DEFAULT NOW(),
  opened_at TIMESTAMPTZ,
  clicked_at TIMESTAMPTZ,
  open_count INTEGER DEFAULT 0,
  click_count INTEGER DEFAULT 0,

  -- Technical details
  ip_address INET,
  user_agent TEXT,
  location VARCHAR(255),

  -- Email service metadata
  email_service_id VARCHAR(255), -- For tracking with SendGrid/Mailgun
  email_status VARCHAR(50) DEFAULT 'sent', -- sent, delivered, bounced, failed

  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_quote_emails_quote_id ON public.quote_emails(quote_id);
CREATE INDEX IF NOT EXISTS idx_quote_emails_sent_at ON public.quote_emails(sent_at DESC);

-- ============================================================
-- 7. CREATE QUOTE COMMENTS TABLE
-- ============================================================
CREATE TABLE IF NOT EXISTS public.quote_comments (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  quote_id UUID REFERENCES public.quotes(id) ON DELETE CASCADE NOT NULL,
  comment_text TEXT NOT NULL,
  comment_type VARCHAR(50) DEFAULT 'internal', -- internal, client, revision_request
  is_client_visible BOOLEAN DEFAULT false,

  -- Threading
  parent_comment_id UUID REFERENCES public.quote_comments(id) ON DELETE CASCADE,

  -- Mentions
  mentioned_users UUID[],

  -- Attachments
  attachments JSONB DEFAULT '[]'::jsonb,

  created_by UUID REFERENCES auth.users(id),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_quote_comments_quote_id ON public.quote_comments(quote_id);

-- ============================================================
-- 8. ENABLE ROW LEVEL SECURITY
-- ============================================================
ALTER TABLE public.contacts ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.quotes ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.quote_items ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.quote_templates ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.quote_activities ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.quote_emails ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.quote_comments ENABLE ROW LEVEL SECURITY;

-- ============================================================
-- 9. CREATE RLS POLICIES
-- ============================================================

-- CONTACTS POLICIES
DROP POLICY IF EXISTS "Users can view their own contacts" ON public.contacts;
CREATE POLICY "Users can view their own contacts"
  ON public.contacts FOR SELECT
  USING (user_id = auth.uid());

DROP POLICY IF EXISTS "Users can insert their own contacts" ON public.contacts;
CREATE POLICY "Users can insert their own contacts"
  ON public.contacts FOR INSERT
  WITH CHECK (user_id = auth.uid());

DROP POLICY IF EXISTS "Users can update their own contacts" ON public.contacts;
CREATE POLICY "Users can update their own contacts"
  ON public.contacts FOR UPDATE
  USING (user_id = auth.uid());

DROP POLICY IF EXISTS "Users can delete their own contacts" ON public.contacts;
CREATE POLICY "Users can delete their own contacts"
  ON public.contacts FOR DELETE
  USING (user_id = auth.uid());

-- QUOTES POLICIES
DROP POLICY IF EXISTS "Users can view their own quotes" ON public.quotes;
CREATE POLICY "Users can view their own quotes"
  ON public.quotes FOR SELECT
  USING (user_id = auth.uid());

DROP POLICY IF EXISTS "Users can insert their own quotes" ON public.quotes;
CREATE POLICY "Users can insert their own quotes"
  ON public.quotes FOR INSERT
  WITH CHECK (user_id = auth.uid());

DROP POLICY IF EXISTS "Users can update their own quotes" ON public.quotes;
CREATE POLICY "Users can update their own quotes"
  ON public.quotes FOR UPDATE
  USING (user_id = auth.uid());

DROP POLICY IF EXISTS "Users can delete their own quotes" ON public.quotes;
CREATE POLICY "Users can delete their own quotes"
  ON public.quotes FOR DELETE
  USING (user_id = auth.uid());

-- QUOTE ITEMS POLICIES
DROP POLICY IF EXISTS "Users can manage quote items" ON public.quote_items;
CREATE POLICY "Users can manage quote items"
  ON public.quote_items FOR ALL
  USING (
    quote_id IN (
      SELECT id FROM public.quotes WHERE user_id = auth.uid()
    )
  );

-- QUOTE TEMPLATES POLICIES
DROP POLICY IF EXISTS "Users can view templates" ON public.quote_templates;
CREATE POLICY "Users can view templates"
  ON public.quote_templates FOR SELECT
  USING (user_id = auth.uid() OR is_public = true);

DROP POLICY IF EXISTS "Users can manage their templates" ON public.quote_templates;
CREATE POLICY "Users can manage their templates"
  ON public.quote_templates FOR ALL
  USING (user_id = auth.uid());

-- QUOTE ACTIVITIES POLICIES
DROP POLICY IF EXISTS "Users can view quote activities" ON public.quote_activities;
CREATE POLICY "Users can view quote activities"
  ON public.quote_activities FOR ALL
  USING (
    quote_id IN (
      SELECT id FROM public.quotes WHERE user_id = auth.uid()
    )
  );

-- QUOTE EMAILS POLICIES
DROP POLICY IF EXISTS "Users can manage quote emails" ON public.quote_emails;
CREATE POLICY "Users can manage quote emails"
  ON public.quote_emails FOR ALL
  USING (
    quote_id IN (
      SELECT id FROM public.quotes WHERE user_id = auth.uid()
    )
  );

-- QUOTE COMMENTS POLICIES
DROP POLICY IF EXISTS "Users can manage quote comments" ON public.quote_comments;
CREATE POLICY "Users can manage quote comments"
  ON public.quote_comments FOR ALL
  USING (
    quote_id IN (
      SELECT id FROM public.quotes WHERE user_id = auth.uid()
    )
  );

-- ============================================================
-- 10. GRANT PERMISSIONS
-- ============================================================
GRANT ALL ON public.contacts TO authenticated;
GRANT ALL ON public.quotes TO authenticated;
GRANT ALL ON public.quote_items TO authenticated;
GRANT ALL ON public.quote_templates TO authenticated;
GRANT ALL ON public.quote_activities TO authenticated;
GRANT ALL ON public.quote_emails TO authenticated;
GRANT ALL ON public.quote_comments TO authenticated;

-- ============================================================
-- 11. CREATE FUNCTIONS FOR AUTO-CALCULATIONS
-- ============================================================

-- Function to update quote totals when line items change
CREATE OR REPLACE FUNCTION update_quote_totals()
RETURNS TRIGGER AS $$
DECLARE
  quote_subtotal DECIMAL(12,2);
  quote_tax DECIMAL(12,2);
  quote_discount DECIMAL(12,2);
  quote_total DECIMAL(12,2);
  quote_deposit DECIMAL(12,2);
  quote_record RECORD;
BEGIN
  -- Get the quote record
  SELECT * INTO quote_record FROM public.quotes
  WHERE id = COALESCE(NEW.quote_id, OLD.quote_id);

  -- Calculate subtotal from all line items
  SELECT COALESCE(SUM(line_total), 0) INTO quote_subtotal
  FROM public.quote_items
  WHERE quote_id = quote_record.id;

  -- Calculate tax
  quote_tax := quote_subtotal * (quote_record.tax_rate / 100);

  -- Calculate discount
  IF quote_record.discount_type = 'percentage' THEN
    quote_discount := quote_subtotal * (quote_record.discount_value / 100);
  ELSE
    quote_discount := quote_record.discount_value;
  END IF;

  -- Calculate total
  quote_total := quote_subtotal + quote_tax - quote_discount;

  -- Calculate deposit
  quote_deposit := quote_total * (quote_record.deposit_required / 100);

  -- Update the quote
  UPDATE public.quotes
  SET
    subtotal = quote_subtotal,
    tax_amount = quote_tax,
    discount_amount = quote_discount,
    total_amount = quote_total,
    deposit_amount = quote_deposit,
    updated_at = NOW()
  WHERE id = quote_record.id;

  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Trigger to update quote totals
DROP TRIGGER IF EXISTS trigger_update_quote_totals ON public.quote_items;
CREATE TRIGGER trigger_update_quote_totals
AFTER INSERT OR UPDATE OR DELETE ON public.quote_items
FOR EACH ROW
EXECUTE FUNCTION update_quote_totals();

-- Function to update line item totals
CREATE OR REPLACE FUNCTION update_line_item_totals()
RETURNS TRIGGER AS $$
BEGIN
  -- Calculate line total
  NEW.line_total := NEW.quantity * NEW.unit_price;

  -- Calculate tax for this line item
  NEW.tax_amount := NEW.line_total * (NEW.tax_rate / 100);

  -- Update timestamp
  NEW.updated_at := NOW();

  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Trigger for line item calculations
DROP TRIGGER IF EXISTS trigger_update_line_item_totals ON public.quote_items;
CREATE TRIGGER trigger_update_line_item_totals
BEFORE INSERT OR UPDATE ON public.quote_items
FOR EACH ROW
EXECUTE FUNCTION update_line_item_totals();

-- Function to generate quote number
CREATE OR REPLACE FUNCTION generate_quote_number()
RETURNS TRIGGER AS $$
DECLARE
  year_prefix VARCHAR(4);
  sequence_num INTEGER;
  new_quote_number VARCHAR(50);
BEGIN
  -- Get current year
  year_prefix := TO_CHAR(CURRENT_DATE, 'YYYY');

  -- Get the next sequence number for this year
  SELECT COALESCE(MAX(
    CAST(
      SUBSTRING(quote_number FROM '\d+$') AS INTEGER
    )
  ), 0) + 1 INTO sequence_num
  FROM public.quotes
  WHERE quote_number LIKE 'Q-' || year_prefix || '-%'
  AND user_id = NEW.user_id;

  -- Generate new quote number: Q-2024-001
  new_quote_number := 'Q-' || year_prefix || '-' || LPAD(sequence_num::TEXT, 3, '0');

  NEW.quote_number := new_quote_number;

  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Trigger to auto-generate quote number
DROP TRIGGER IF EXISTS trigger_generate_quote_number ON public.quotes;
CREATE TRIGGER trigger_generate_quote_number
BEFORE INSERT ON public.quotes
FOR EACH ROW
WHEN (NEW.quote_number IS NULL OR NEW.quote_number = '')
EXECUTE FUNCTION generate_quote_number();

-- Function to log quote activities
CREATE OR REPLACE FUNCTION log_quote_activity()
RETURNS TRIGGER AS $$
BEGIN
  IF TG_OP = 'INSERT' THEN
    INSERT INTO public.quote_activities (quote_id, activity_type, description, created_by)
    VALUES (NEW.id, 'created', 'Quote created', NEW.created_by);
  ELSIF TG_OP = 'UPDATE' THEN
    IF OLD.status != NEW.status THEN
      INSERT INTO public.quote_activities (quote_id, activity_type, description, created_by, metadata)
      VALUES (
        NEW.id,
        'status_changed',
        'Status changed from ' || OLD.status || ' to ' || NEW.status,
        NEW.created_by,
        jsonb_build_object('old_status', OLD.status, 'new_status', NEW.status)
      );
    END IF;
  END IF;

  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Trigger to log activities
DROP TRIGGER IF EXISTS trigger_log_quote_activity ON public.quotes;
CREATE TRIGGER trigger_log_quote_activity
AFTER INSERT OR UPDATE ON public.quotes
FOR EACH ROW
EXECUTE FUNCTION log_quote_activity();

-- ============================================================
-- 12. INSERT DEFAULT QUOTE TEMPLATES
-- ============================================================

-- We'll add default templates after user creation, so skip for now

-- ============================================================
-- 13. CREATE VIEWS FOR ANALYTICS
-- ============================================================

CREATE OR REPLACE VIEW quote_analytics AS
SELECT
  user_id,
  COUNT(*) as total_quotes,
  COUNT(*) FILTER (WHERE status = 'draft') as draft_count,
  COUNT(*) FILTER (WHERE status = 'sent') as sent_count,
  COUNT(*) FILTER (WHERE status = 'approved') as approved_count,
  COUNT(*) FILTER (WHERE status = 'rejected') as rejected_count,
  COUNT(*) FILTER (WHERE status = 'expired') as expired_count,
  SUM(total_amount) FILTER (WHERE status = 'approved') as approved_value,
  SUM(total_amount) as total_value,
  CASE
    WHEN COUNT(*) FILTER (WHERE status IN ('sent', 'approved', 'rejected')) > 0
    THEN ROUND(
      (COUNT(*) FILTER (WHERE status = 'approved')::DECIMAL /
       COUNT(*) FILTER (WHERE status IN ('sent', 'approved', 'rejected'))::DECIMAL * 100),
      2
    )
    ELSE 0
  END as conversion_rate,
  AVG(total_amount) as average_quote_value
FROM public.quotes
GROUP BY user_id;

-- ============================================================
-- SETUP COMPLETE!
-- ============================================================

SELECT 'QuoteHub database setup completed successfully!' as status;


#14

-- ============================================================
-- QUOTEHUB MIGRATION SCRIPT
-- Safely migrate from old schema to enhanced schema
-- ============================================================

-- ============================================================
-- STEP 1: DROP OLD TRIGGERS AND FUNCTIONS (if they exist)
-- ============================================================

DROP TRIGGER IF EXISTS trigger_auto_convert_on_approval ON public.quotes;
DROP TRIGGER IF EXISTS trigger_log_quote_activity ON public.quotes;
DROP TRIGGER IF EXISTS trigger_generate_quote_number ON public.quotes;
DROP TRIGGER IF EXISTS trigger_update_quote_totals ON public.quote_items;
DROP TRIGGER IF EXISTS trigger_update_line_item_totals ON public.quote_items;

DROP FUNCTION IF EXISTS auto_convert_on_approval();
DROP FUNCTION IF EXISTS log_quote_activity();
DROP FUNCTION IF EXISTS generate_quote_number();
DROP FUNCTION IF EXISTS update_quote_totals();
DROP FUNCTION IF EXISTS update_line_item_totals();
DROP FUNCTION IF EXISTS convert_quote_to_project(UUID);
DROP FUNCTION IF EXISTS apply_change_order_to_project(UUID);
DROP FUNCTION IF EXISTS record_quote_view(UUID, VARCHAR, JSONB);
DROP FUNCTION IF EXISTS add_client_interaction(UUID, VARCHAR, TEXT, VARCHAR, VARCHAR, VARCHAR, UUID);

DROP VIEW IF EXISTS quote_analytics;

-- ============================================================
-- STEP 2: DROP OLD TABLES (start fresh)
-- ============================================================

DROP TABLE IF EXISTS public.quote_comments CASCADE;
DROP TABLE IF EXISTS public.quote_emails CASCADE;
DROP TABLE IF EXISTS public.quote_activities CASCADE;
DROP TABLE IF EXISTS public.quote_client_interactions CASCADE;
DROP TABLE IF EXISTS public.quote_templates CASCADE;
DROP TABLE IF EXISTS public.quote_items CASCADE;
DROP TABLE IF EXISTS public.quotes CASCADE;

-- ============================================================
-- STEP 3: CREATE ENHANCED SCHEMA (all tables)
-- ============================================================

-- 1. ENHANCED QUOTES TABLE
CREATE TABLE public.quotes (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,

  -- SMART NUMBERING: Q-2024-PROP-001
  quote_number VARCHAR(50) UNIQUE NOT NULL DEFAULT '',
  quote_type VARCHAR(20) DEFAULT 'proposal' CHECK (quote_type IN ('proposal', 'bid', 'estimate', 'change_order', 'maintenance')),
  year INTEGER DEFAULT EXTRACT(YEAR FROM NOW()),
  sequence_number INTEGER,

  -- CLIENT & PROJECT LINKS
  client_id UUID REFERENCES public.contacts(id) ON DELETE SET NULL,
  project_id UUID REFERENCES public.projects(id) ON DELETE SET NULL,
  original_quote_id UUID REFERENCES public.quotes(id),

  -- QUOTE DETAILS
  title VARCHAR(255) NOT NULL,
  description TEXT,
  scope_of_work TEXT,

  -- STATUS WORKFLOW
  status VARCHAR(20) DEFAULT 'draft' CHECK (status IN ('draft', 'ready', 'sent', 'viewed', 'commented', 'revised', 'approved', 'rejected', 'on_hold', 'expired', 'won', 'lost', 'cancelled')),
  sub_status VARCHAR(50),

  -- CONVERSION TRACKING
  converted_to_project_id UUID REFERENCES public.projects(id),
  converted_at TIMESTAMPTZ,
  conversion_type VARCHAR(20) CHECK (conversion_type IN ('new_project', 'change_order', 'maintenance_schedule', NULL)),
  auto_create_project BOOLEAN DEFAULT true,
  auto_create_tasks BOOLEAN DEFAULT true,

  -- FINANCIALS
  subtotal DECIMAL(12,2) DEFAULT 0,
  tax_rate DECIMAL(5,2) DEFAULT 0,
  tax_amount DECIMAL(12,2) DEFAULT 0,
  discount_type VARCHAR(20) DEFAULT 'fixed',
  discount_value DECIMAL(10,2) DEFAULT 0,
  discount_amount DECIMAL(12,2) DEFAULT 0,
  total_amount DECIMAL(12,2) DEFAULT 0,
  deposit_required DECIMAL(5,2) DEFAULT 0,
  deposit_amount DECIMAL(12,2) DEFAULT 0,
  deposit_received BOOLEAN DEFAULT false,
  currency VARCHAR(3) DEFAULT 'USD',

  -- PROFIT TRACKING
  total_cost DECIMAL(12,2) DEFAULT 0,
  profit_margin DECIMAL(5,2) GENERATED ALWAYS AS (
    CASE
      WHEN subtotal > 0
      THEN ((subtotal - total_cost) / subtotal * 100)
      ELSE 0
    END
  ) STORED,

  -- DATES
  quote_date DATE DEFAULT CURRENT_DATE,
  valid_until DATE,
  sent_at TIMESTAMPTZ,
  first_viewed_at TIMESTAMPTZ,
  last_viewed_at TIMESTAMPTZ,
  client_approved_at TIMESTAMPTZ,
  client_rejected_at TIMESTAMPTZ,

  -- TRACKING
  view_count INTEGER DEFAULT 0,
  revision_count INTEGER DEFAULT 0,
  email_sent_count INTEGER DEFAULT 0,

  -- APPROVAL & REJECTION
  approved_by VARCHAR(255),
  rejection_reason TEXT,

  -- CONTENT
  notes TEXT,
  internal_notes TEXT,
  terms_conditions TEXT,
  payment_terms TEXT,
  branding JSONB DEFAULT '{"logo": null, "primaryColor": "#2563EB", "accentColor": "#F97316"}'::jsonb,

  -- METADATA
  created_by UUID REFERENCES auth.users(id),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Indexes
CREATE INDEX idx_quotes_quote_number ON public.quotes(quote_number);
CREATE INDEX idx_quotes_user_id ON public.quotes(user_id);
CREATE INDEX idx_quotes_status ON public.quotes(status);
CREATE INDEX idx_quotes_type ON public.quotes(quote_type);
CREATE INDEX idx_quotes_client_id ON public.quotes(client_id);
CREATE INDEX idx_quotes_project_id ON public.quotes(project_id);
CREATE INDEX idx_quotes_converted_project ON public.quotes(converted_to_project_id);

-- 2. QUOTE LINE ITEMS
CREATE TABLE public.quote_items (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  quote_id UUID REFERENCES public.quotes(id) ON DELETE CASCADE NOT NULL,
  item_number INTEGER NOT NULL,

  -- TASK CONVERSION
  convert_to_task BOOLEAN DEFAULT true,
  created_task_id UUID REFERENCES public.tasks(id),

  -- ITEM DETAILS
  category VARCHAR(100),
  description TEXT NOT NULL,
  detailed_description TEXT,
  benefits TEXT,

  -- QUANTITY & PRICING
  quantity DECIMAL(10,2) DEFAULT 1 CHECK (quantity > 0),
  unit VARCHAR(50) DEFAULT 'ea',
  unit_price DECIMAL(12,2) NOT NULL CHECK (unit_price >= 0),

  -- COST & MARGIN
  cost_price DECIMAL(12,2),
  markup_percentage DECIMAL(5,2),
  margin DECIMAL(5,2) GENERATED ALWAYS AS (
    CASE
      WHEN unit_price > 0 AND cost_price > 0
      THEN ((unit_price - cost_price) / unit_price * 100)
      ELSE 0
    END
  ) STORED,

  -- TAX
  tax_rate DECIMAL(5,2) DEFAULT 0,
  tax_amount DECIMAL(12,2) DEFAULT 0,
  is_taxable BOOLEAN DEFAULT true,

  -- TOTALS
  line_total DECIMAL(12,2) DEFAULT 0,

  -- FLAGS
  is_optional BOOLEAN DEFAULT false,
  is_allowance BOOLEAN DEFAULT false,

  -- ORDERING
  sort_order INTEGER DEFAULT 0,
  notes TEXT,

  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_quote_items_quote_id ON public.quote_items(quote_id);
CREATE INDEX idx_quote_items_sort_order ON public.quote_items(quote_id, sort_order);
CREATE INDEX idx_quote_items_task ON public.quote_items(created_task_id);

-- 3. QUOTE ACTIVITIES
CREATE TABLE public.quote_activities (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  quote_id UUID REFERENCES public.quotes(id) ON DELETE CASCADE NOT NULL,
  activity_type VARCHAR(50) NOT NULL,
  user_id UUID REFERENCES auth.users(id),
  client_name VARCHAR(255),
  description TEXT,
  metadata JSONB DEFAULT '{}'::jsonb,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_quote_activities_quote_id ON public.quote_activities(quote_id);
CREATE INDEX idx_quote_activities_created_at ON public.quote_activities(created_at DESC);

-- 4. CLIENT INTERACTIONS
CREATE TABLE public.quote_client_interactions (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  quote_id UUID REFERENCES public.quotes(id) ON DELETE CASCADE NOT NULL,
  interaction_type VARCHAR(50) NOT NULL,
  target_type VARCHAR(50),
  target_id UUID,
  content TEXT NOT NULL,
  client_name VARCHAR(255),
  client_email VARCHAR(255),
  resolved BOOLEAN DEFAULT false,
  resolved_by UUID REFERENCES auth.users(id),
  resolved_at TIMESTAMPTZ,
  resolution_notes TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_client_interactions_quote ON public.quote_client_interactions(quote_id);
CREATE INDEX idx_client_interactions_target ON public.quote_client_interactions(target_id);

-- 5. QUOTE TEMPLATES
CREATE TABLE public.quote_templates (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
  name VARCHAR(255) NOT NULL,
  description TEXT,
  template_type VARCHAR(20) DEFAULT 'proposal' CHECK (template_type IN ('proposal', 'bid', 'estimate', 'change_order', 'maintenance')),
  category VARCHAR(100),
  content JSONB NOT NULL DEFAULT '{}'::jsonb,
  default_items JSONB DEFAULT '[]'::jsonb,
  default_terms TEXT,
  default_payment_terms TEXT,
  default_tax_rate DECIMAL(5,2) DEFAULT 0,
  default_valid_days INTEGER DEFAULT 30,
  use_count INTEGER DEFAULT 0,
  last_used_at TIMESTAMPTZ,
  is_public BOOLEAN DEFAULT false,
  is_system_template BOOLEAN DEFAULT false,
  is_favorite BOOLEAN DEFAULT false,
  created_by UUID REFERENCES auth.users(id),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_quote_templates_user_id ON public.quote_templates(user_id);
CREATE INDEX idx_quote_templates_type ON public.quote_templates(template_type);
CREATE INDEX idx_quote_templates_category ON public.quote_templates(category);

-- ============================================================
-- STEP 4: ENABLE RLS
-- ============================================================

ALTER TABLE public.quotes ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.quote_items ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.quote_activities ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.quote_client_interactions ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.quote_templates ENABLE ROW LEVEL SECURITY;

-- ============================================================
-- STEP 5: CREATE RLS POLICIES
-- ============================================================

CREATE POLICY "Users can view their own quotes"
  ON public.quotes FOR SELECT
  USING (user_id = auth.uid());

CREATE POLICY "Users can insert their own quotes"
  ON public.quotes FOR INSERT
  WITH CHECK (user_id = auth.uid());

CREATE POLICY "Users can update their own quotes"
  ON public.quotes FOR UPDATE
  USING (user_id = auth.uid());

CREATE POLICY "Users can delete their own quotes"
  ON public.quotes FOR DELETE
  USING (user_id = auth.uid());

CREATE POLICY "Users can manage quote items"
  ON public.quote_items FOR ALL
  USING (
    quote_id IN (
      SELECT id FROM public.quotes WHERE user_id = auth.uid()
    )
  );

CREATE POLICY "Users can manage quote activities"
  ON public.quote_activities FOR ALL
  USING (
    quote_id IN (
      SELECT id FROM public.quotes WHERE user_id = auth.uid()
    )
  );

CREATE POLICY "Users can manage client interactions"
  ON public.quote_client_interactions FOR ALL
  USING (
    quote_id IN (
      SELECT id FROM public.quotes WHERE user_id = auth.uid()
    )
  );

CREATE POLICY "Users can view templates"
  ON public.quote_templates FOR SELECT
  USING (user_id = auth.uid() OR is_public = true);

CREATE POLICY "Users can manage their templates"
  ON public.quote_templates FOR ALL
  USING (user_id = auth.uid());

-- ============================================================
-- STEP 6: GRANT PERMISSIONS
-- ============================================================

GRANT ALL ON public.quotes TO authenticated;
GRANT ALL ON public.quote_items TO authenticated;
GRANT ALL ON public.quote_activities TO authenticated;
GRANT ALL ON public.quote_client_interactions TO authenticated;
GRANT ALL ON public.quote_templates TO authenticated;

-- ============================================================
-- STEP 7: CREATE FUNCTIONS
-- ============================================================

-- Update line item totals
CREATE OR REPLACE FUNCTION update_line_item_totals()
RETURNS TRIGGER AS $$
BEGIN
  NEW.line_total := NEW.quantity * NEW.unit_price;
  IF NEW.is_taxable THEN
    NEW.tax_amount := NEW.line_total * (NEW.tax_rate / 100);
  ELSE
    NEW.tax_amount := 0;
  END IF;
  NEW.updated_at := NOW();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_update_line_item_totals
BEFORE INSERT OR UPDATE ON public.quote_items
FOR EACH ROW
EXECUTE FUNCTION update_line_item_totals();

-- Update quote totals
CREATE OR REPLACE FUNCTION update_quote_totals()
RETURNS TRIGGER AS $$
DECLARE
  quote_subtotal DECIMAL(12,2);
  quote_cost DECIMAL(12,2);
  quote_tax DECIMAL(12,2);
  quote_discount DECIMAL(12,2);
  quote_total DECIMAL(12,2);
  quote_deposit DECIMAL(12,2);
  quote_record RECORD;
BEGIN
  SELECT * INTO quote_record FROM public.quotes
  WHERE id = COALESCE(NEW.quote_id, OLD.quote_id);

  SELECT
    COALESCE(SUM(line_total), 0),
    COALESCE(SUM(quantity * COALESCE(cost_price, 0)), 0)
  INTO quote_subtotal, quote_cost
  FROM public.quote_items
  WHERE quote_id = quote_record.id;

  quote_tax := quote_subtotal * (quote_record.tax_rate / 100);

  IF quote_record.discount_type = 'percentage' THEN
    quote_discount := quote_subtotal * (quote_record.discount_value / 100);
  ELSE
    quote_discount := quote_record.discount_value;
  END IF;

  quote_total := quote_subtotal + quote_tax - quote_discount;
  quote_deposit := quote_total * (quote_record.deposit_required / 100);

  UPDATE public.quotes
  SET
    subtotal = quote_subtotal,
    total_cost = quote_cost,
    tax_amount = quote_tax,
    discount_amount = quote_discount,
    total_amount = quote_total,
    deposit_amount = quote_deposit,
    updated_at = NOW()
  WHERE id = quote_record.id;

  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_update_quote_totals
AFTER INSERT OR UPDATE OR DELETE ON public.quote_items
FOR EACH ROW
EXECUTE FUNCTION update_quote_totals();

-- Smart quote numbering
CREATE OR REPLACE FUNCTION generate_quote_number()
RETURNS TRIGGER AS $$
DECLARE
  year_prefix VARCHAR(4);
  type_prefix VARCHAR(4);
  sequence_num INTEGER;
  new_quote_number VARCHAR(50);
BEGIN
  year_prefix := TO_CHAR(CURRENT_DATE, 'YYYY');

  type_prefix := CASE NEW.quote_type
    WHEN 'proposal' THEN 'PROP'
    WHEN 'bid' THEN 'BID'
    WHEN 'estimate' THEN 'EST'
    WHEN 'change_order' THEN 'CHG'
    WHEN 'maintenance' THEN 'MNT'
    ELSE 'QUOT'
  END;

  SELECT COALESCE(MAX(sequence_number), 0) + 1 INTO sequence_num
  FROM public.quotes
  WHERE quote_type = NEW.quote_type
  AND year = EXTRACT(YEAR FROM CURRENT_DATE)
  AND user_id = NEW.user_id;

  new_quote_number := 'Q-' || year_prefix || '-' || type_prefix || '-' || LPAD(sequence_num::TEXT, 3, '0');

  NEW.quote_number := new_quote_number;
  NEW.year := EXTRACT(YEAR FROM CURRENT_DATE);
  NEW.sequence_number := sequence_num;

  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_generate_quote_number
BEFORE INSERT ON public.quotes
FOR EACH ROW
WHEN (NEW.quote_number IS NULL OR NEW.quote_number = '')
EXECUTE FUNCTION generate_quote_number();

-- Log activities
CREATE OR REPLACE FUNCTION log_quote_activity()
RETURNS TRIGGER AS $$
BEGIN
  IF TG_OP = 'INSERT' THEN
    INSERT INTO public.quote_activities (quote_id, activity_type, description, user_id)
    VALUES (NEW.id, 'created', 'Quote created', NEW.created_by);
  ELSIF TG_OP = 'UPDATE' THEN
    IF OLD.status != NEW.status THEN
      INSERT INTO public.quote_activities (quote_id, activity_type, description, user_id, metadata)
      VALUES (
        NEW.id,
        'status_changed',
        'Status changed from ' || OLD.status || ' to ' || NEW.status,
        NEW.created_by,
        jsonb_build_object('old_status', OLD.status, 'new_status', NEW.status)
      );
    END IF;
    IF OLD.converted_to_project_id IS NULL AND NEW.converted_to_project_id IS NOT NULL THEN
      INSERT INTO public.quote_activities (quote_id, activity_type, description, user_id, metadata)
      VALUES (
        NEW.id,
        'converted_to_project',
        'Quote converted to project',
        NEW.created_by,
        jsonb_build_object('project_id', NEW.converted_to_project_id, 'conversion_type', NEW.conversion_type)
      );
    END IF;
  END IF;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_log_quote_activity
AFTER INSERT OR UPDATE ON public.quotes
FOR EACH ROW
EXECUTE FUNCTION log_quote_activity();

-- Convert quote to project
CREATE OR REPLACE FUNCTION convert_quote_to_project(quote_id_param UUID)
RETURNS UUID AS $$
DECLARE
  quote_record RECORD;
  new_project_id UUID;
  item_record RECORD;
  new_task_id UUID;
BEGIN
  SELECT * INTO quote_record FROM public.quotes WHERE id = quote_id_param;
  IF NOT FOUND THEN RAISE EXCEPTION 'Quote not found'; END IF;
  IF quote_record.status != 'approved' THEN RAISE EXCEPTION 'Quote must be approved'; END IF;
  IF quote_record.converted_to_project_id IS NOT NULL THEN RAISE EXCEPTION 'Already converted'; END IF;

  INSERT INTO public.projects (user_id, name, description, client_id, status, start_date, budget, created_at, updated_at)
  VALUES (quote_record.user_id, quote_record.title, 'Created from ' || quote_record.quote_number, quote_record.client_id, 'planning', CURRENT_DATE, quote_record.total_amount, NOW(), NOW())
  RETURNING id INTO new_project_id;

  UPDATE public.quotes SET converted_to_project_id = new_project_id, converted_at = NOW(), conversion_type = 'new_project', updated_at = NOW() WHERE id = quote_id_param;

  IF quote_record.auto_create_tasks THEN
    FOR item_record IN SELECT * FROM public.quote_items WHERE quote_id = quote_id_param AND convert_to_task = true ORDER BY sort_order
    LOOP
      INSERT INTO public.tasks (user_id, project_id, title, description, status, priority, estimated_hours, created_at, updated_at)
      VALUES (quote_record.user_id, new_project_id, item_record.description, COALESCE(item_record.detailed_description, item_record.notes, ''), 'pending', 'medium', CASE WHEN item_record.unit = 'hours' THEN item_record.quantity ELSE NULL END, NOW(), NOW())
      RETURNING id INTO new_task_id;

      UPDATE public.quote_items SET created_task_id = new_task_id WHERE id = item_record.id;
    END LOOP;
  END IF;

  INSERT INTO public.quote_activities (quote_id, activity_type, description, user_id, metadata)
  VALUES (quote_id_param, 'converted_to_project', 'Quote converted to project: ' || new_project_id, quote_record.user_id, jsonb_build_object('project_id', new_project_id, 'conversion_type', 'new_project'));

  RETURN new_project_id;
END;
$$ LANGUAGE plpgsql;

-- Apply change order
CREATE OR REPLACE FUNCTION apply_change_order_to_project(quote_id_param UUID)
RETURNS UUID AS $$
DECLARE
  quote_record RECORD;
  target_project_id UUID;
  item_record RECORD;
  new_task_id UUID;
  current_budget DECIMAL(12,2);
BEGIN
  SELECT * INTO quote_record FROM public.quotes WHERE id = quote_id_param;
  IF NOT FOUND THEN RAISE EXCEPTION 'Quote not found'; END IF;
  IF quote_record.quote_type != 'change_order' THEN RAISE EXCEPTION 'Must be change order'; END IF;
  IF quote_record.status != 'approved' THEN RAISE EXCEPTION 'Must be approved'; END IF;
  IF quote_record.project_id IS NULL THEN RAISE EXCEPTION 'Must be linked to project'; END IF;

  target_project_id := quote_record.project_id;
  SELECT budget INTO current_budget FROM public.projects WHERE id = target_project_id;

  UPDATE public.projects SET budget = current_budget + quote_record.total_amount, updated_at = NOW() WHERE id = target_project_id;
  UPDATE public.quotes SET converted_to_project_id = target_project_id, converted_at = NOW(), conversion_type = 'change_order', updated_at = NOW() WHERE id = quote_id_param;

  IF quote_record.auto_create_tasks THEN
    FOR item_record IN SELECT * FROM public.quote_items WHERE quote_id = quote_id_param AND convert_to_task = true ORDER BY sort_order
    LOOP
      INSERT INTO public.tasks (user_id, project_id, title, description, status, priority, estimated_hours, created_at, updated_at)
      VALUES (quote_record.user_id, target_project_id, '[CHANGE ORDER] ' || item_record.description, 'From ' || quote_record.quote_number, 'pending', 'high', CASE WHEN item_record.unit = 'hours' THEN item_record.quantity ELSE NULL END, NOW(), NOW())
      RETURNING id INTO new_task_id;

      UPDATE public.quote_items SET created_task_id = new_task_id WHERE id = item_record.id;
    END LOOP;
  END IF;

  INSERT INTO public.quote_activities (quote_id, activity_type, description, user_id, metadata)
  VALUES (quote_id_param, 'change_order_applied', 'Change order applied to project: ' || target_project_id, quote_record.user_id, jsonb_build_object('project_id', target_project_id, 'budget_increase', quote_record.total_amount));

  RETURN target_project_id;
END;
$$ LANGUAGE plpgsql;

-- Auto-convert on approval
CREATE OR REPLACE FUNCTION auto_convert_on_approval()
RETURNS TRIGGER AS $$
BEGIN
  IF OLD.status != 'approved' AND NEW.status = 'approved' THEN
    IF NEW.auto_create_project THEN
      IF NEW.quote_type IN ('proposal', 'bid') THEN
        PERFORM convert_quote_to_project(NEW.id);
      ELSIF NEW.quote_type = 'change_order' AND NEW.project_id IS NOT NULL THEN
        PERFORM apply_change_order_to_project(NEW.id);
      END IF;
    END IF;
  END IF;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_auto_convert_on_approval
AFTER UPDATE ON public.quotes
FOR EACH ROW
EXECUTE FUNCTION auto_convert_on_approval();

-- Client portal functions
CREATE OR REPLACE FUNCTION record_quote_view(quote_id_param UUID, client_name_param VARCHAR(255) DEFAULT NULL, metadata_param JSONB DEFAULT '{}'::jsonb)
RETURNS VOID AS $$
BEGIN
  UPDATE public.quotes SET view_count = view_count + 1, last_viewed_at = NOW(), first_viewed_at = COALESCE(first_viewed_at, NOW()), updated_at = NOW() WHERE id = quote_id_param;
  UPDATE public.quotes SET status = 'viewed' WHERE id = quote_id_param AND status = 'sent';
  INSERT INTO public.quote_activities (quote_id, activity_type, description, client_name, metadata) VALUES (quote_id_param, 'viewed', 'Quote viewed by client', client_name_param, metadata_param);
END;
$$ LANGUAGE plpgsql;

CREATE OR REPLACE FUNCTION add_client_interaction(quote_id_param UUID, interaction_type_param VARCHAR(50), content_param TEXT, client_name_param VARCHAR(255), client_email_param VARCHAR(255), target_type_param VARCHAR(50) DEFAULT NULL, target_id_param UUID DEFAULT NULL)
RETURNS UUID AS $$
DECLARE new_interaction_id UUID;
BEGIN
  INSERT INTO public.quote_client_interactions (quote_id, interaction_type, content, client_name, client_email, target_type, target_id) VALUES (quote_id_param, interaction_type_param, content_param, client_name_param, client_email_param, target_type_param, target_id_param) RETURNING id INTO new_interaction_id;
  UPDATE public.quotes SET status = 'commented' WHERE id = quote_id_param AND status IN ('sent', 'viewed');
  INSERT INTO public.quote_activities (quote_id, activity_type, description, client_name, metadata) VALUES (quote_id_param, 'client_' || interaction_type_param, 'Client ' || interaction_type_param || ': ' || LEFT(content_param, 100), client_name_param, jsonb_build_object('interaction_id', new_interaction_id, 'interaction_type', interaction_type_param));
  RETURN new_interaction_id;
END;
$$ LANGUAGE plpgsql;

-- Analytics view
CREATE OR REPLACE VIEW quote_analytics AS
SELECT q.user_id, q.quote_type, q.status, DATE_TRUNC('month', q.created_at) as month, COUNT(*) as quote_count, SUM(q.total_amount) as total_value, AVG(q.total_amount) as avg_value, AVG(q.profit_margin) as avg_margin, COUNT(CASE WHEN q.status = 'approved' THEN 1 END) as approved_count, COUNT(CASE WHEN q.status = 'rejected' THEN 1 END) as rejected_count, COUNT(CASE WHEN q.converted_to_project_id IS NOT NULL THEN 1 END) as converted_count, AVG(EXTRACT(EPOCH FROM (q.client_approved_at - q.sent_at)) / 86400) as avg_days_to_approval
FROM public.quotes q
GROUP BY q.user_id, q.quote_type, q.status, DATE_TRUNC('month', q.created_at);

-- ============================================================
-- MIGRATION COMPLETE!
-- ============================================================

SELECT 'QuoteHub Enhanced Schema - Migration Complete!' as status;


#14
-- ============================================================
-- REPORTCENTER DATABASE SCHEMA
-- Professional reporting system for construction contractors
-- ============================================================

-- ============================================================
-- 1. REPORTS MASTER TABLE
-- ============================================================
CREATE TABLE IF NOT EXISTS public.reports (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,

  -- REPORT IDENTIFICATION
  report_number VARCHAR(50) UNIQUE NOT NULL,
  report_type VARCHAR(20) NOT NULL CHECK (report_type IN ('daily', 'weekly_timesheet', 'budget', 'safety', 'progress', 'custom')),
  title VARCHAR(255) NOT NULL,
  description TEXT,

  -- SOURCE DATA (What this report is about)
  project_id UUID REFERENCES public.projects(id) ON DELETE SET NULL,
  quote_id UUID REFERENCES public.quotes(id) ON DELETE SET NULL,
  date_range_start DATE NOT NULL,
  date_range_end DATE NOT NULL,

  -- GENERATION DETAILS
  generated_by UUID REFERENCES auth.users(id),
  generated_at TIMESTAMPTZ DEFAULT NOW(),
  generation_time_ms INTEGER, -- Track performance
  data_snapshot JSONB DEFAULT '{}'::jsonb, -- Raw data at generation time

  -- CONTENT & DELIVERY
  status VARCHAR(20) DEFAULT 'draft' CHECK (status IN ('draft', 'final', 'sent', 'archived')),
  sent_to_client BOOLEAN DEFAULT false,
  sent_at TIMESTAMPTZ,
  client_viewed BOOLEAN DEFAULT false,
  client_viewed_at TIMESTAMPTZ,
  client_email VARCHAR(255),

  -- FILE STORAGE
  file_path TEXT, -- Supabase storage path
  pdf_url TEXT,
  excel_url TEXT,
  file_size_bytes INTEGER,

  -- REPORT CONTENT (Structured data)
  summary JSONB DEFAULT '{}'::jsonb, -- Key metrics/summary
  sections JSONB DEFAULT '[]'::jsonb, -- Report sections with data
  photos JSONB DEFAULT '[]'::jsonb, -- Photo references
  attachments JSONB DEFAULT '[]'::jsonb,

  -- METADATA
  tags TEXT[],
  notes TEXT,
  version INTEGER DEFAULT 1,
  parent_report_id UUID REFERENCES public.reports(id), -- For revisions
  is_template BOOLEAN DEFAULT false,

  -- WEATHER DATA (for daily reports)
  weather_data JSONB,

  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Indexes for performance
CREATE INDEX IF NOT EXISTS idx_reports_user_id ON public.reports(user_id);
CREATE INDEX IF NOT EXISTS idx_reports_project_id ON public.reports(project_id);
CREATE INDEX IF NOT EXISTS idx_reports_type ON public.reports(report_type);
CREATE INDEX IF NOT EXISTS idx_reports_date_range ON public.reports(date_range_start, date_range_end);
CREATE INDEX IF NOT EXISTS idx_reports_status ON public.reports(status);
CREATE INDEX IF NOT EXISTS idx_reports_created_at ON public.reports(created_at DESC);

-- ============================================================
-- 2. REPORT TEMPLATES
-- ============================================================
CREATE TABLE IF NOT EXISTS public.report_templates (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,

  -- TEMPLATE INFO
  name VARCHAR(255) NOT NULL,
  description TEXT,
  template_type VARCHAR(50) NOT NULL CHECK (template_type IN ('daily', 'weekly_timesheet', 'budget', 'safety', 'progress', 'custom')),
  category VARCHAR(50), -- client, internal, compliance, financial

  -- TEMPLATE STRUCTURE
  sections JSONB NOT NULL DEFAULT '[]'::jsonb,
  -- Structure: [{ id, type, title, fields, settings }]

  styling JSONB DEFAULT '{
    "primaryColor": "#2563EB",
    "accentColor": "#F97316",
    "fontFamily": "Inter",
    "showLogo": true,
    "showWatermark": false
  }'::jsonb,

  formulas JSONB DEFAULT '{}'::jsonb, -- Calculations between fields
  data_sources JSONB DEFAULT '{}'::jsonb, -- Which data to auto-pull

  -- USAGE & VISIBILITY
  is_default BOOLEAN DEFAULT false,
  is_system_template BOOLEAN DEFAULT false, -- Built-in templates
  is_public BOOLEAN DEFAULT true,
  requires_approval BOOLEAN DEFAULT false,

  use_count INTEGER DEFAULT 0,
  last_used_at TIMESTAMPTZ,

  created_by UUID REFERENCES auth.users(id),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_report_templates_user_id ON public.report_templates(user_id);
CREATE INDEX IF NOT EXISTS idx_report_templates_type ON public.report_templates(template_type);

-- ============================================================
-- 3. REPORT SCHEDULES (Automated reporting)
-- ============================================================
CREATE TABLE IF NOT EXISTS public.report_schedules (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,

  name VARCHAR(255) NOT NULL,
  description TEXT,
  template_id UUID REFERENCES public.report_templates(id),
  report_type VARCHAR(20) NOT NULL,

  -- SCHEDULING
  frequency VARCHAR(20) NOT NULL CHECK (frequency IN ('daily', 'weekly', 'biweekly', 'monthly', 'quarterly')),
  day_of_week INTEGER, -- 0-6 (Sunday=0)
  day_of_month INTEGER, -- 1-31
  time_of_day TIME DEFAULT '17:00', -- 5 PM default
  timezone VARCHAR(50) DEFAULT 'America/New_York',

  -- DELIVERY
  delivery_method VARCHAR(20) DEFAULT 'email' CHECK (delivery_method IN ('email', 'download', 'portal', 'none')),
  recipients JSONB DEFAULT '[]'::jsonb, -- Array of emails
  cc_recipients JSONB DEFAULT '[]'::jsonb,

  include_pdf BOOLEAN DEFAULT true,
  include_excel BOOLEAN DEFAULT false,

  -- PROJECT FILTERS
  project_ids UUID[], -- Specific projects (empty = all active)
  active_projects_only BOOLEAN DEFAULT true,

  -- STATUS
  is_active BOOLEAN DEFAULT true,
  last_run_at TIMESTAMPTZ,
  next_run_at TIMESTAMPTZ,
  last_run_status VARCHAR(20), -- success, failed, skipped
  run_count INTEGER DEFAULT 0,

  created_by UUID REFERENCES auth.users(id),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_report_schedules_user_id ON public.report_schedules(user_id);
CREATE INDEX IF NOT EXISTS idx_report_schedules_active ON public.report_schedules(is_active, next_run_at);

-- ============================================================
-- 4. TIMESHEET ENTRIES (For weekly timesheet reports)
-- ============================================================
CREATE TABLE IF NOT EXISTS public.timesheet_entries (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,

  -- WHO & WHERE
  employee_id UUID REFERENCES auth.users(id) NOT NULL,
  employee_name VARCHAR(255) NOT NULL,
  project_id UUID REFERENCES public.projects(id),

  -- WHEN
  work_date DATE NOT NULL,
  week_start_date DATE NOT NULL, -- Monday of the week

  -- HOURS
  regular_hours DECIMAL(5,2) DEFAULT 0 CHECK (regular_hours >= 0),
  overtime_hours DECIMAL(5,2) DEFAULT 0 CHECK (overtime_hours >= 0),
  total_hours DECIMAL(5,2) GENERATED ALWAYS AS (regular_hours + overtime_hours) STORED,

  -- RATES & COST
  hourly_rate DECIMAL(10,2),
  overtime_rate DECIMAL(10,2),
  total_cost DECIMAL(12,2) GENERATED ALWAYS AS (
    (regular_hours * COALESCE(hourly_rate, 0)) +
    (overtime_hours * COALESCE(overtime_rate, COALESCE(hourly_rate, 0) * 1.5))
  ) STORED,

  -- DETAILS
  task_description TEXT,
  trade VARCHAR(100), -- carpenter, electrician, plumber, etc.
  notes TEXT,

  -- APPROVAL
  approved BOOLEAN DEFAULT false,
  approved_by UUID REFERENCES auth.users(id),
  approved_at TIMESTAMPTZ,

  -- METADATA
  source VARCHAR(20) DEFAULT 'manual', -- manual, taskflow, imported
  synced_from_task_id UUID REFERENCES public.tasks(id),

  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_timesheet_entries_user_id ON public.timesheet_entries(user_id);
CREATE INDEX IF NOT EXISTS idx_timesheet_entries_employee ON public.timesheet_entries(employee_id);
CREATE INDEX IF NOT EXISTS idx_timesheet_entries_project ON public.timesheet_entries(project_id);
CREATE INDEX IF NOT EXISTS idx_timesheet_entries_date ON public.timesheet_entries(work_date);
CREATE INDEX IF NOT EXISTS idx_timesheet_entries_week ON public.timesheet_entries(week_start_date);

-- ============================================================
-- 5. ENABLE ROW LEVEL SECURITY
-- ============================================================
ALTER TABLE public.reports ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.report_templates ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.report_schedules ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.timesheet_entries ENABLE ROW LEVEL SECURITY;

-- ============================================================
-- 6. RLS POLICIES
-- ============================================================

-- REPORTS POLICIES
DROP POLICY IF EXISTS "Users can view their own reports" ON public.reports;
CREATE POLICY "Users can view their own reports"
  ON public.reports FOR SELECT
  USING (user_id = auth.uid());

DROP POLICY IF EXISTS "Users can create their own reports" ON public.reports;
CREATE POLICY "Users can create their own reports"
  ON public.reports FOR INSERT
  WITH CHECK (user_id = auth.uid());

DROP POLICY IF EXISTS "Users can update their own reports" ON public.reports;
CREATE POLICY "Users can update their own reports"
  ON public.reports FOR UPDATE
  USING (user_id = auth.uid());

DROP POLICY IF EXISTS "Users can delete their own reports" ON public.reports;
CREATE POLICY "Users can delete their own reports"
  ON public.reports FOR DELETE
  USING (user_id = auth.uid());

-- TEMPLATES POLICIES
DROP POLICY IF EXISTS "Users can view templates" ON public.report_templates;
CREATE POLICY "Users can view templates"
  ON public.report_templates FOR SELECT
  USING (user_id = auth.uid() OR is_public = true OR is_system_template = true);

DROP POLICY IF EXISTS "Users can manage their templates" ON public.report_templates;
CREATE POLICY "Users can manage their templates"
  ON public.report_templates FOR ALL
  USING (user_id = auth.uid());

-- SCHEDULES POLICIES
DROP POLICY IF EXISTS "Users can manage schedules" ON public.report_schedules;
CREATE POLICY "Users can manage schedules"
  ON public.report_schedules FOR ALL
  USING (user_id = auth.uid());

-- TIMESHEET POLICIES
DROP POLICY IF EXISTS "Users can manage timesheet entries" ON public.timesheet_entries;
CREATE POLICY "Users can manage timesheet entries"
  ON public.timesheet_entries FOR ALL
  USING (user_id = auth.uid());

-- ============================================================
-- 7. GRANT PERMISSIONS
-- ============================================================
GRANT ALL ON public.reports TO authenticated;
GRANT ALL ON public.report_templates TO authenticated;
GRANT ALL ON public.report_schedules TO authenticated;
GRANT ALL ON public.timesheet_entries TO authenticated;

-- ============================================================
-- 8. HELPER FUNCTIONS
-- ============================================================

-- Generate unique report number
CREATE OR REPLACE FUNCTION generate_report_number()
RETURNS TRIGGER AS $$
DECLARE
  year_prefix VARCHAR(4);
  type_prefix VARCHAR(10);
  sequence_num INTEGER;
  new_report_number VARCHAR(50);
BEGIN
  year_prefix := TO_CHAR(CURRENT_DATE, 'YYYY');

  type_prefix := CASE NEW.report_type
    WHEN 'daily' THEN 'DAILY'
    WHEN 'weekly_timesheet' THEN 'TIME'
    WHEN 'budget' THEN 'BUDG'
    WHEN 'safety' THEN 'SAFE'
    WHEN 'progress' THEN 'PROG'
    ELSE 'REPT'
  END;

  SELECT COALESCE(MAX(CAST(SUBSTRING(report_number FROM '\d+$') AS INTEGER)), 0) + 1
  INTO sequence_num
  FROM public.reports
  WHERE report_type = NEW.report_type
  AND EXTRACT(YEAR FROM created_at) = EXTRACT(YEAR FROM CURRENT_DATE)
  AND user_id = NEW.user_id;

  new_report_number := 'R-' || year_prefix || '-' || type_prefix || '-' || LPAD(sequence_num::TEXT, 3, '0');

  NEW.report_number := new_report_number;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

DROP TRIGGER IF EXISTS trigger_generate_report_number ON public.reports;
CREATE TRIGGER trigger_generate_report_number
BEFORE INSERT ON public.reports
FOR EACH ROW
WHEN (NEW.report_number IS NULL OR NEW.report_number = '')
EXECUTE FUNCTION generate_report_number();

-- Auto-update timestamps
CREATE OR REPLACE FUNCTION update_updated_at()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at := NOW();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

DROP TRIGGER IF EXISTS trigger_update_reports_timestamp ON public.reports;
CREATE TRIGGER trigger_update_reports_timestamp
BEFORE UPDATE ON public.reports
FOR EACH ROW
EXECUTE FUNCTION update_updated_at();

DROP TRIGGER IF EXISTS trigger_update_templates_timestamp ON public.report_templates;
CREATE TRIGGER trigger_update_templates_timestamp
BEFORE UPDATE ON public.report_templates
FOR EACH ROW
EXECUTE FUNCTION update_updated_at();

-- ============================================================
-- 9. INSERT SYSTEM TEMPLATES
-- ============================================================

-- DAILY PROGRESS REPORT TEMPLATE
INSERT INTO public.report_templates (
  id,
  name,
  description,
  template_type,
  category,
  sections,
  is_system_template,
  is_default,
  is_public
) VALUES (
  gen_random_uuid(),
  'Daily Progress Report',
  'Professional daily update for clients with photos, tasks completed, and crew attendance',
  'daily',
  'client',
  '[
    {
      "id": "header",
      "type": "header",
      "title": "Report Header",
      "fields": ["project_name", "date", "weather", "supervisor", "report_number"]
    },
    {
      "id": "summary",
      "type": "summary",
      "title": "Today''s Summary",
      "fields": ["tasks_completed_count", "crew_size", "hours_worked", "progress_percent"]
    },
    {
      "id": "tasks",
      "type": "table",
      "title": "Tasks Completed Today",
      "fields": ["task_name", "assigned_to", "status", "notes"]
    },
    {
      "id": "photos",
      "type": "gallery",
      "title": "Today''s Progress Photos",
      "settings": {"maxPhotos": 6, "columns": 3}
    },
    {
      "id": "crew",
      "type": "table",
      "title": "Crew Attendance",
      "fields": ["crew_member", "trade", "hours_worked", "notes"]
    },
    {
      "id": "materials",
      "type": "list",
      "title": "Materials Delivered/Used",
      "fields": ["material", "quantity", "supplier", "notes"]
    },
    {
      "id": "issues",
      "type": "list",
      "title": "Issues & Concerns",
      "fields": ["issue_type", "description", "severity", "action_taken"]
    },
    {
      "id": "tomorrow",
      "type": "section",
      "title": "Tomorrow''s Plan",
      "fields": ["planned_tasks", "crew_needed", "materials_needed", "special_requirements"]
    }
  ]'::jsonb,
  true,
  true,
  true
) ON CONFLICT DO NOTHING;

-- WEEKLY TIMESHEET TEMPLATE
INSERT INTO public.report_templates (
  id,
  name,
  description,
  template_type,
  category,
  sections,
  is_system_template,
  is_default,
  is_public
) VALUES (
  gen_random_uuid(),
  'Weekly Timesheet Report',
  'Payroll-ready timesheet with project allocation and overtime calculations',
  'weekly_timesheet',
  'internal',
  '[
    {
      "id": "summary",
      "type": "summary",
      "title": "Week Summary",
      "fields": ["week_ending", "total_hours", "regular_hours", "overtime_hours", "total_cost", "employee_count"]
    },
    {
      "id": "by_employee",
      "type": "table",
      "title": "Hours by Employee",
      "fields": ["employee", "project", "mon", "tue", "wed", "thu", "fri", "sat", "sun", "total", "rate", "cost"]
    },
    {
      "id": "by_project",
      "type": "table",
      "title": "Labor Cost by Project",
      "fields": ["project", "total_hours", "regular_hours", "overtime_hours", "labor_cost", "budget_impact"]
    },
    {
      "id": "overtime",
      "type": "table",
      "title": "Overtime Analysis",
      "fields": ["employee", "overtime_hours", "ot_cost", "reason", "approved_by"]
    }
  ]'::jsonb,
  true,
  true,
  true
) ON CONFLICT DO NOTHING;

-- BUDGET REPORT TEMPLATE
INSERT INTO public.report_templates (
  id,
  name,
  description,
  template_type,
  category,
  sections,
  is_system_template,
  is_default,
  is_public
) VALUES (
  gen_random_uuid(),
  'Project Budget Report',
  'Comprehensive budget vs actual analysis with profit tracking',
  'budget',
  'financial',
  '[
    {
      "id": "executive",
      "type": "summary",
      "title": "Executive Summary",
      "fields": ["project", "client", "budget", "spent", "remaining", "percent_complete", "profit", "margin"]
    },
    {
      "id": "breakdown",
      "type": "chart",
      "title": "Cost Breakdown",
      "chartType": "pie",
      "fields": ["labor", "materials", "equipment", "subcontractors", "overhead", "other"]
    },
    {
      "id": "budget_actual",
      "type": "table",
      "title": "Budget vs Actual",
      "fields": ["category", "budgeted", "actual", "variance", "variance_percent", "status"]
    },
    {
      "id": "change_orders",
      "type": "table",
      "title": "Change Orders Impact",
      "fields": ["change_order_number", "description", "amount", "approved", "date", "impact"]
    },
    {
      "id": "forecast",
      "type": "section",
      "title": "Project Forecast",
      "fields": ["estimated_completion", "estimated_final_cost", "estimated_profit", "risks", "recommendations"]
    }
  ]'::jsonb,
  true,
  true,
  true
) ON CONFLICT DO NOTHING;

-- ============================================================
-- SETUP COMPLETE!
-- ============================================================

SELECT 'ReportCenter Database Schema Created Successfully!' as status;


#15

-REPORTCENTER ADVANCED ANALYTICS - PHASE 2
-- Business intelligence, custom reporting, and automation
-- ============================================================

-- ============================================================
-- 1. REPORT ANALYTICS (Track usage and value)
-- ============================================================
CREATE TABLE IF NOT EXISTS public.report_analytics (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  report_id UUID REFERENCES public.reports(id) ON DELETE CASCADE NOT NULL,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,

  -- GENERATION - ============================================================
-- METRICS
  generation_time_ms INTEGER,
  file_size_bytes INTEGER,
  data_points_count INTEGER,

  -- CLIENT INTERACTION
  client_opened BOOLEAN DEFAULT false,
  client_opened_at TIMESTAMPTZ,
  client_open_count INTEGER DEFAULT 0,
  client_downloaded BOOLEAN DEFAULT false,
  client_downloaded_at TIMESTAMPTZ,
  client_time_spent_seconds INTEGER,

  -- BUSINESS IMPACT
  led_to_action BOOLEAN DEFAULT false,
  action_type VARCHAR(50), -- approval, payment, change_order, contract_signed
  action_value DECIMAL(12,2), -- Estimated value of action taken

  -- FEEDBACK
  rating INTEGER CHECK (rating BETWEEN 1 AND 5),
  feedback TEXT,
  was_useful BOOLEAN,

  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_report_analytics_report ON public.report_analytics(report_id);
CREATE INDEX IF NOT EXISTS idx_report_analytics_user ON public.report_analytics(user_id);

-- ============================================================
-- 2. CUSTOM REPORT BUILDER SAVES
-- ============================================================
CREATE TABLE IF NOT EXISTS public.custom_report_saves (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,

  -- REPORT INFO
  name VARCHAR(255) NOT NULL,
  description TEXT,
  category VARCHAR(50), -- financial, operational, client, custom

  -- REPORT CONFIGURATION (Full JSON config)
  config JSONB NOT NULL DEFAULT '{}'::jsonb,
  -- Structure: {
  --   sections: [{ id, type, title, dataSource, fields, visualization }],
  --   filters: { dateRange, projects, clients },
  --   styling: { colors, fonts, layout }
  -- }

  data_sources JSONB DEFAULT '[]'::jsonb,
  -- Which data to include: ['projects', 'tasks', 'financial', 'crew']

  filters JSONB DEFAULT '{}'::jsonb,
  -- Saved filter state

  visualizations JSONB DEFAULT '[]'::jsonb,
  -- Chart configurations

  -- USAGE TRACKING
  use_count INTEGER DEFAULT 0,
  last_used_at TIMESTAMPTZ,
  avg_generation_time_ms INTEGER,

  -- SHARING
  is_favorite BOOLEAN DEFAULT false,
  shared_with_team BOOLEAN DEFAULT false,
  shared_with_users UUID[],
  is_public BOOLEAN DEFAULT false,

  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_custom_reports_user ON public.custom_report_saves(user_id);
CREATE INDEX IF NOT EXISTS idx_custom_reports_favorite ON public.custom_report_saves(is_favorite);

-- ============================================================
-- 3. REPORT ALERTS & NOTIFICATIONS
-- ============================================================
CREATE TABLE IF NOT EXISTS public.report_alerts (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,

  -- ALERT CONFIG
  name VARCHAR(255) NOT NULL,
  description TEXT,
  alert_type VARCHAR(50) NOT NULL, -- budget, schedule, safety, quality, financial

  -- CONDITION (JSONB for flexibility)
  condition JSONB NOT NULL,
  -- Structure: {
  --   metric: 'budget_variance',
  --   operator: 'greater_than',
  --   threshold: 0.15,
  --   scope: 'project' | 'company' | 'client'
  -- }

  -- ACTION CONFIGURATION
  action VARCHAR(50) NOT NULL, -- email, notification, generate_report, create_task
  action_config JSONB DEFAULT '{}'::jsonb,
  -- Structure: {
  --   recipients: ['user_id', 'email'],
  --   template_id: 'uuid',
  --   priority: 'high' | 'medium' | 'low'
  -- }

  -- SCHEDULING
  check_frequency VARCHAR(20) DEFAULT 'daily', -- hourly, daily, weekly, realtime
  last_checked_at TIMESTAMPTZ,
  last_triggered_at TIMESTAMPTZ,
  next_check_at TIMESTAMPTZ,

  -- STATUS
  is_active BOOLEAN DEFAULT true,
  trigger_count INTEGER DEFAULT 0,
  false_positive_count INTEGER DEFAULT 0,

  -- METADATA
  created_by UUID REFERENCES auth.users(id),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_report_alerts_user ON public.report_alerts(user_id);
CREATE INDEX IF NOT EXISTS idx_report_alerts_active ON public.report_alerts(is_active, next_check_at);

-- ============================================================
-- 4. ALERT TRIGGERS LOG
-- ============================================================
CREATE TABLE IF NOT EXISTS public.alert_triggers (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  alert_id UUID REFERENCES public.report_alerts(id) ON DELETE CASCADE NOT NULL,

  -- TRIGGER DETAILS
  triggered_at TIMESTAMPTZ DEFAULT NOW(),
  actual_value DECIMAL(12,2),
  threshold_value DECIMAL(12,2),
  variance DECIMAL(12,2),

  -- CONTEXT
  related_project_id UUID REFERENCES public.projects(id),
  related_quote_id UUID REFERENCES public.quotes(id),
  context JSONB DEFAULT '{}'::jsonb,

  -- ACTION TAKEN
  action_taken VARCHAR(50),
  action_status VARCHAR(20), -- sent, failed, acknowledged, resolved
  action_result JSONB,

  -- RESOLUTION
  acknowledged BOOLEAN DEFAULT false,
  acknowledged_by UUID REFERENCES auth.users(id),
  acknowledged_at TIMESTAMPTZ,
  resolution_notes TEXT,

  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_alert_triggers_alert ON public.alert_triggers(alert_id);
CREATE INDEX IF NOT EXISTS idx_alert_triggers_project ON public.alert_triggers(related_project_id);

-- ============================================================
-- 5. FINANCIAL METRICS CACHE (For fast dashboard loading)
-- ============================================================
CREATE TABLE IF NOT EXISTS public.financial_metrics_cache (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,

  -- PERIOD
  period_type VARCHAR(20) NOT NULL, -- daily, weekly, monthly, quarterly, yearly
  period_start DATE NOT NULL,
  period_end DATE NOT NULL,

  -- PROJECT SCOPE (null = all projects)
  project_id UUID REFERENCES public.projects(id),

  -- REVENUE METRICS
  total_revenue DECIMAL(12,2) DEFAULT 0,
  completed_revenue DECIMAL(12,2) DEFAULT 0,
  pending_revenue DECIMAL(12,2) DEFAULT 0,
  change_order_revenue DECIMAL(12,2) DEFAULT 0,

  -- COST METRICS
  total_costs DECIMAL(12,2) DEFAULT 0,
  labor_costs DECIMAL(12,2) DEFAULT 0,
  material_costs DECIMAL(12,2) DEFAULT 0,
  equipment_costs DECIMAL(12,2) DEFAULT 0,
  subcontractor_costs DECIMAL(12,2) DEFAULT 0,
  overhead_costs DECIMAL(12,2) DEFAULT 0,

  -- PROFIT METRICS
  gross_profit DECIMAL(12,2) GENERATED ALWAYS AS (total_revenue - total_costs) STORED,
  gross_margin DECIMAL(5,4) GENERATED ALWAYS AS (
    CASE WHEN total_revenue > 0
    THEN (total_revenue - total_costs) / total_revenue
    ELSE 0 END
  ) STORED,

  -- PROJECT METRICS
  active_projects_count INTEGER DEFAULT 0,
  completed_projects_count INTEGER DEFAULT 0,
  avg_project_value DECIMAL(12,2),
  avg_project_margin DECIMAL(5,4),

  -- CREW METRICS
  total_hours_worked DECIMAL(10,2) DEFAULT 0,
  regular_hours DECIMAL(10,2) DEFAULT 0,
  overtime_hours DECIMAL(10,2) DEFAULT 0,
  avg_hourly_cost DECIMAL(10,2),

  -- CACHE METADATA
  calculated_at TIMESTAMPTZ DEFAULT NOW(),
  is_stale BOOLEAN DEFAULT false,

  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),

  UNIQUE(user_id, period_type, period_start, period_end, project_id)
);

CREATE INDEX IF NOT EXISTS idx_financial_cache_user_period ON public.financial_metrics_cache(user_id, period_type, period_start);
CREATE INDEX IF NOT EXISTS idx_financial_cache_project ON public.financial_metrics_cache(project_id);

-- ============================================================
-- 6. ENABLE ROW LEVEL SECURITY
-- ============================================================
ALTER TABLE public.report_analytics ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.custom_report_saves ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.report_alerts ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.alert_triggers ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.financial_metrics_cache ENABLE ROW LEVEL SECURITY;

-- ============================================================
-- 7. RLS POLICIES
-- ============================================================

-- REPORT ANALYTICS
DROP POLICY IF EXISTS "Users manage their analytics" ON public.report_analytics;
CREATE POLICY "Users manage their analytics"
  ON public.report_analytics FOR ALL
  USING (user_id = auth.uid());

-- CUSTOM REPORT SAVES
DROP POLICY IF EXISTS "Users manage their custom reports" ON public.custom_report_saves;
CREATE POLICY "Users manage their custom reports"
  ON public.custom_report_saves FOR ALL
  USING (user_id = auth.uid());

-- REPORT ALERTS
DROP POLICY IF EXISTS "Users manage their alerts" ON public.report_alerts;
CREATE POLICY "Users manage their alerts"
  ON public.report_alerts FOR ALL
  USING (user_id = auth.uid());

-- ALERT TRIGGERS
DROP POLICY IF EXISTS "Users view their alert triggers" ON public.alert_triggers;
CREATE POLICY "Users view their alert triggers"
  ON public.alert_triggers FOR SELECT
  USING (
    alert_id IN (
      SELECT id FROM public.report_alerts WHERE user_id = auth.uid()
    )
  );

-- FINANCIAL METRICS CACHE
DROP POLICY IF EXISTS "Users access their financial cache" ON public.financial_metrics_cache;
CREATE POLICY "Users access their financial cache"
  ON public.financial_metrics_cache FOR ALL
  USING (user_id = auth.uid());

-- ============================================================
-- 8. GRANT PERMISSIONS
-- ============================================================
GRANT ALL ON public.report_analytics TO authenticated;
GRANT ALL ON public.custom_report_saves TO authenticated;
GRANT ALL ON public.report_alerts TO authenticated;
GRANT ALL ON public.alert_triggers TO authenticated;
GRANT ALL ON public.financial_metrics_cache TO authenticated;

-- ============================================================
-- 9. ADVANCED FUNCTIONS
-- ============================================================

-- Calculate financial metrics for a period
CREATE OR REPLACE FUNCTION calculate_financial_metrics(
  user_id_param UUID,
  period_start_param DATE,
  period_end_param DATE,
  project_id_param UUID DEFAULT NULL
)
RETURNS TABLE(
  total_revenue DECIMAL(12,2),
  total_costs DECIMAL(12,2),
  gross_profit DECIMAL(12,2),
  gross_margin DECIMAL(5,4),
  project_count INTEGER
) AS $$
BEGIN
  RETURN QUERY
  SELECT
    COALESCE(SUM(p.budget), 0) as total_revenue,
    COALESCE(SUM(
      (SELECT SUM(te.total_cost)
       FROM public.timesheet_entries te
       WHERE te.project_id = p.id
       AND te.work_date BETWEEN period_start_param AND period_end_param)
    ), 0) as total_costs,
    COALESCE(SUM(p.budget), 0) - COALESCE(SUM(
      (SELECT SUM(te.total_cost)
       FROM public.timesheet_entries te
       WHERE te.project_id = p.id
       AND te.work_date BETWEEN period_start_param AND period_end_param)
    ), 0) as gross_profit,
    CASE
      WHEN COALESCE(SUM(p.budget), 0) > 0
      THEN (COALESCE(SUM(p.budget), 0) - COALESCE(SUM(
        (SELECT SUM(te.total_cost)
         FROM public.timesheet_entries te
         WHERE te.project_id = p.id
         AND te.work_date BETWEEN period_start_param AND period_end_param)
      ), 0)) / COALESCE(SUM(p.budget), 0)
      ELSE 0
    END as gross_margin,
    COUNT(*)::INTEGER as project_count
  FROM public.projects p
  WHERE p.created_by = user_id_param
    AND p.created_at BETWEEN period_start_param AND period_end_param
    AND (project_id_param IS NULL OR p.id = project_id_param);
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Refresh financial metrics cache
CREATE OR REPLACE FUNCTION refresh_financial_cache(
  user_id_param UUID,
  period_type_param VARCHAR(20),
  period_start_param DATE,
  period_end_param DATE
)
RETURNS VOID AS $$
DECLARE
  metrics RECORD;
BEGIN
  -- Calculate metrics
  SELECT * INTO metrics
  FROM calculate_financial_metrics(
    user_id_param,
    period_start_param,
    period_end_param,
    NULL
  );

  -- Upsert into cache
  INSERT INTO public.financial_metrics_cache (
    user_id,
    period_type,
    period_start,
    period_end,
    total_revenue,
    total_costs,
    calculated_at,
    is_stale
  ) VALUES (
    user_id_param,
    period_type_param,
    period_start_param,
    period_end_param,
    metrics.total_revenue,
    metrics.total_costs,
    NOW(),
    false
  )
  ON CONFLICT (user_id, period_type, period_start, period_end, project_id)
  DO UPDATE SET
    total_revenue = EXCLUDED.total_revenue,
    total_costs = EXCLUDED.total_costs,
    calculated_at = NOW(),
    is_stale = false;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Check alert conditions
CREATE OR REPLACE FUNCTION check_alert_conditions()
RETURNS VOID AS $$
DECLARE
  alert_record RECORD;
  should_trigger BOOLEAN;
  metric_value DECIMAL(12,2);
BEGIN
  -- Loop through active alerts that need checking
  FOR alert_record IN
    SELECT * FROM public.report_alerts
    WHERE is_active = true
    AND (next_check_at IS NULL OR next_check_at <= NOW())
  LOOP
    -- Evaluate condition (simplified - expand based on condition type)
    should_trigger := false;

    -- Example: Budget variance check
    IF alert_record.alert_type = 'budget' THEN
      -- Get actual budget variance for user's projects
      SELECT AVG(
        CASE
          WHEN p.budget > 0
          THEN ABS(p.budget - COALESCE(p.actual_cost, 0)) / p.budget
          ELSE 0
        END
      ) INTO metric_value
      FROM public.projects p
      WHERE p.created_by = alert_record.user_id
      AND p.status = 'active';

      -- Check if exceeds threshold
      IF metric_value > (alert_record.condition->>'threshold')::DECIMAL THEN
        should_trigger := true;
      END IF;
    END IF;

    -- If should trigger, log it
    IF should_trigger THEN
      INSERT INTO public.alert_triggers (
        alert_id,
        actual_value,
        threshold_value,
        variance,
        action_status
      ) VALUES (
        alert_record.id,
        metric_value,
        (alert_record.condition->>'threshold')::DECIMAL,
        metric_value - (alert_record.condition->>'threshold')::DECIMAL,
        'sent'
      );

      -- Update alert stats
      UPDATE public.report_alerts
      SET
        last_triggered_at = NOW(),
        trigger_count = trigger_count + 1
      WHERE id = alert_record.id;
    END IF;

    -- Update next check time
    UPDATE public.report_alerts
    SET
      last_checked_at = NOW(),
      next_check_at = NOW() + CASE check_frequency
        WHEN 'hourly' THEN INTERVAL '1 hour'
        WHEN 'daily' THEN INTERVAL '1 day'
        WHEN 'weekly' THEN INTERVAL '1 week'
        ELSE INTERVAL '1 day'
      END
    WHERE id = alert_record.id;
  END LOOP;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- ============================================================
-- 10. INSERT ADVANCED TEMPLATES
-- ============================================================

-- PROFIT & LOSS TEMPLATE
INSERT INTO public.report_templates (
  name,
  description,
  template_type,
  category,
  sections,
  is_system_template,
  is_default,
  is_public
) VALUES (
  'Profit & Loss Statement',
  'Comprehensive P&L with project allocation and trend analysis',
  'budget',
  'financial',
  '[
    {
      "id": "executive_summary",
      "type": "summary",
      "title": "Executive Summary",
      "fields": ["period", "total_revenue", "total_costs", "gross_profit", "net_profit", "margin"]
    },
    {
      "id": "revenue_breakdown",
      "type": "table",
      "title": "Revenue by Project",
      "fields": ["project", "client", "contract_value", "change_orders", "total_revenue", "percent_of_total"]
    },
    {
      "id": "cost_breakdown",
      "type": "chart",
      "title": "Cost Breakdown",
      "chartType": "pie",
      "fields": ["labor", "materials", "equipment", "subcontractors", "overhead"]
    },
    {
      "id": "profitability",
      "type": "table",
      "title": "Project Profitability",
      "fields": ["project", "revenue", "costs", "profit", "margin", "roi"]
    }
  ]'::jsonb,
  true,
  true,
  true
) ON CONFLICT DO NOTHING;

-- CREW PRODUCTIVITY TEMPLATE
INSERT INTO public.report_templates (
  name,
  description,
  template_type,
  category,
  sections,
  is_system_template,
  is_default,
  is_public
) VALUES (
  'Crew Productivity Analysis',
  'Track crew efficiency and performance metrics',
  'progress',
  'operational',
  '[
    {
      "id": "summary",
      "type": "summary",
      "title": "Productivity Summary",
      "fields": ["period", "total_hours", "avg_productivity", "top_performer"]
    },
    {
      "id": "crew_ranking",
      "type": "table",
      "title": "Crew Performance",
      "fields": ["crew", "hours", "tasks_completed", "productivity_score", "quality_score"]
    },
    {
      "id": "trends",
      "type": "chart",
      "title": "Productivity Trends",
      "chartType": "line",
      "fields": ["week", "productivity", "hours"]
    }
  ]'::jsonb,
  true,
  true,
  true
) ON CONFLICT DO NOTHING;

-- CLIENT PORTFOLIO TEMPLATE
INSERT INTO public.report_templates (
  name,
  description,
  template_type,
  category,
  sections,
  is_system_template,
  is_default,
  is_public
) VALUES (
  'Client Portfolio Analysis',
  'Client profitability and value analysis',
  'custom',
  'sales',
  '[
    {
      "id": "portfolio_summary",
      "type": "summary",
      "title": "Portfolio Summary",
      "fields": ["total_clients", "active_clients", "total_revenue", "avg_value", "retention_rate"]
    },
    {
      "id": "top_clients",
      "type": "table",
      "title": "Top Clients",
      "fields": ["client", "revenue", "margin", "projects", "years_active", "score"]
    },
    {
      "id": "client_distribution",
      "type": "chart",
      "title": "Client Distribution",
      "chartType": "pie",
      "fields": ["platinum", "gold", "silver", "bronze"]
    }
  ]'::jsonb,
  true,
  true,
  true
) ON CONFLICT DO NOTHING;

-- ============================================================
-- SETUP COMPLETE!
-- ============================================================

SELECT 'ReportCenter Advanced Analytics Schema Created Successfully!' as status,
       'Phase 2: Business Intelligence, Custom Reporting, and Automation' as phase;


#16

-- ============================================================
-- REPORTCENTER ENTERPRISE FEATURES - PHASE 3
-- Automation, Client Portal, Compliance, and Security
-- ============================================================

-- ============================================================
-- 1. REPORT AUTOMATION WORKFLOWS
-- ============================================================
CREATE TABLE IF NOT EXISTS public.report_workflows (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,

  -- WORKFLOW INFO
  name VARCHAR(255) NOT NULL,
  description TEXT,
  category VARCHAR(50), -- reporting, compliance, client_updates, internal

  -- TRIGGER CONFIGURATION
  trigger_type VARCHAR(50) NOT NULL, -- schedule, event, threshold, manual
  trigger_config JSONB NOT NULL,
  -- Structure for schedule: {
  --   frequency: 'daily' | 'weekly' | 'monthly',
  --   time: '17:00',
  --   days: [1,2,3,4,5] (for weekly)
  -- }
  -- Structure for event: {
  --   event: 'project_milestone' | 'task_complete' | 'budget_threshold',
  --   conditions: {...}
  -- }
  -- Structure for threshold: {
  --   metric: 'budget_variance' | 'schedule_delay',
  --   operator: 'greater_than' | 'less_than',
  --   value: 0.15
  -- }

  -- ACTIONS TO EXECUTE
  actions JSONB NOT NULL DEFAULT '[]'::jsonb,
  -- Array of actions:
  -- [
  --   {type: 'generate_report', template_id: 'uuid', project_id: 'uuid'},
  --   {type: 'send_email', recipients: ['email'], subject: '...'},
  --   {type: 'create_task', task_details: {...}},
  --   {type: 'update_project', project_id: 'uuid', updates: {...}}
  -- ]

  -- CONDITIONS (When to run)
  conditions JSONB DEFAULT '{}'::jsonb,
  -- {
  --   project_status: ['active', 'in_progress'],
  --   client_types: ['premium', 'vip'],
  --   date_ranges: {...}
  -- }

  -- EXECUTION TRACKING
  last_run_at TIMESTAMPTZ,
  last_run_status VARCHAR(20), -- success, failed, partial, skipped
  last_run_log TEXT,
  next_run_at TIMESTAMPTZ,
  last_error TEXT,

  -- ERROR HANDLING
  retry_on_failure BOOLEAN DEFAULT true,
  max_retries INTEGER DEFAULT 3,
  retry_count INTEGER DEFAULT 0,
  notify_on_failure BOOLEAN DEFAULT true,
  notification_emails TEXT[],

  -- STATUS
  is_active BOOLEAN DEFAULT true,
  is_paused BOOLEAN DEFAULT false,
  run_count INTEGER DEFAULT 0,
  success_count INTEGER DEFAULT 0,
  failure_count INTEGER DEFAULT 0,

  -- METADATA
  created_by UUID REFERENCES auth.users(id),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_workflows_user ON public.report_workflows(user_id);
CREATE INDEX IF NOT EXISTS idx_workflows_active ON public.report_workflows(is_active, next_run_at);
CREATE INDEX IF NOT EXISTS idx_workflows_trigger ON public.report_workflows(trigger_type);

-- ============================================================
-- 2. WORKFLOW EXECUTION HISTORY
-- ============================================================
CREATE TABLE IF NOT EXISTS public.workflow_executions (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  workflow_id UUID REFERENCES public.report_workflows(id) ON DELETE CASCADE NOT NULL,

  -- EXECUTION DETAILS
  started_at TIMESTAMPTZ DEFAULT NOW(),
  completed_at TIMESTAMPTZ,
  duration_ms INTEGER,
  status VARCHAR(20), -- running, success, failed, cancelled

  -- TRIGGER INFO
  triggered_by VARCHAR(50), -- schedule, manual, event, threshold
  triggered_by_user UUID REFERENCES auth.users(id),

  -- EXECUTION CONTEXT
  execution_context JSONB DEFAULT '{}'::jsonb,
  -- {project_id, client_id, trigger_value, etc.}

  -- RESULTS
  actions_executed JSONB DEFAULT '[]'::jsonb,
  -- [{action: 'generate_report', status: 'success', report_id: 'uuid'}]

  reports_generated UUID[], -- Array of report IDs created
  emails_sent INTEGER DEFAULT 0,
  tasks_created INTEGER DEFAULT 0,

  -- ERROR TRACKING
  error_message TEXT,
  error_stack TEXT,
  retry_attempt INTEGER DEFAULT 0,

  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_workflow_executions_workflow ON public.workflow_executions(workflow_id);
CREATE INDEX IF NOT EXISTS idx_workflow_executions_status ON public.workflow_executions(status);
CREATE INDEX IF NOT EXISTS idx_workflow_executions_date ON public.workflow_executions(started_at DESC);

-- ============================================================
-- 3. CLIENT PORTAL ACCESS
-- ============================================================
CREATE TABLE IF NOT EXISTS public.client_portal_access (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,

  -- CLIENT INFO
  client_email VARCHAR(255) UNIQUE NOT NULL,
  client_name VARCHAR(255) NOT NULL,
  client_company VARCHAR(255),
  client_phone VARCHAR(50),

  -- ACCESS CREDENTIALS
  portal_username VARCHAR(255) UNIQUE,
  portal_password_hash TEXT,
  temporary_password BOOLEAN DEFAULT true,
  password_reset_token TEXT,
  password_reset_expires TIMESTAMPTZ,
  two_factor_enabled BOOLEAN DEFAULT false,
  two_factor_secret TEXT,

  -- PERMISSIONS
  allowed_report_types TEXT[], -- Which report types can see
  allowed_projects UUID[], -- Which projects can access
  view_only BOOLEAN DEFAULT true,
  can_download BOOLEAN DEFAULT true,
  can_comment BOOLEAN DEFAULT true,
  can_approve BOOLEAN DEFAULT false,
  can_request_changes BOOLEAN DEFAULT true,

  -- ACTIVITY TRACKING
  first_login_at TIMESTAMPTZ,
  last_login_at TIMESTAMPTZ,
  login_count INTEGER DEFAULT 0,
  last_activity_at TIMESTAMPTZ,
  failed_login_attempts INTEGER DEFAULT 0,
  locked_until TIMESTAMPTZ,

  -- SETTINGS
  email_notifications BOOLEAN DEFAULT true,
  notification_frequency VARCHAR(20) DEFAULT 'immediate', -- immediate, daily, weekly
  preferred_language VARCHAR(10) DEFAULT 'en',
  timezone VARCHAR(50) DEFAULT 'America/New_York',

  -- STATUS
  is_active BOOLEAN DEFAULT true,
  is_verified BOOLEAN DEFAULT false,
  verification_token TEXT,
  verification_sent_at TIMESTAMPTZ,

  created_by UUID REFERENCES auth.users(id),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_client_portal_email ON public.client_portal_access(client_email);
CREATE INDEX IF NOT EXISTS idx_client_portal_username ON public.client_portal_access(portal_username);
CREATE INDEX IF NOT EXISTS idx_client_portal_user ON public.client_portal_access(user_id);

-- ============================================================
-- 4. CLIENT PORTAL ACTIVITY LOG
-- ============================================================
CREATE TABLE IF NOT EXISTS public.client_portal_activity (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  portal_access_id UUID REFERENCES public.client_portal_access(id) ON DELETE CASCADE NOT NULL,

  -- ACTIVITY INFO
  activity_type VARCHAR(50), -- login, logout, view_report, download, comment, approve
  activity_details TEXT,

  -- CONTEXT
  report_id UUID REFERENCES public.reports(id),
  project_id UUID REFERENCES public.projects(id),

  -- METADATA
  ip_address INET,
  user_agent TEXT,
  device_type VARCHAR(50), -- desktop, mobile, tablet
  location JSONB, -- {country, city, lat, lon}

  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_portal_activity_access ON public.client_portal_activity(portal_access_id);
CREATE INDEX IF NOT EXISTS idx_portal_activity_type ON public.client_portal_activity(activity_type);
CREATE INDEX IF NOT EXISTS idx_portal_activity_date ON public.client_portal_activity(created_at DESC);

-- ============================================================
-- 5. COMPLIANCE & AUDIT TRAIL
-- ============================================================
CREATE TABLE IF NOT EXISTS public.compliance_audit_trail (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id) ON DELETE SET NULL,

  -- WHAT WAS CHANGED
  entity_type VARCHAR(50) NOT NULL, -- report, template, workflow, portal_access
  entity_id UUID NOT NULL,
  action VARCHAR(50) NOT NULL, -- created, updated, deleted, viewed, exported, approved

  -- WHO MADE THE CHANGE
  actor_type VARCHAR(20), -- user, system, client, workflow
  actor_id UUID,
  actor_name VARCHAR(255),
  actor_email VARCHAR(255),

  -- WHEN
  action_timestamp TIMESTAMPTZ DEFAULT NOW(),

  -- NETWORK CONTEXT
  ip_address INET,
  user_agent TEXT,
  session_id TEXT,

  -- CHANGE DETAILS
  previous_values JSONB,
  new_values JSONB,
  changes_summary TEXT,

  -- BUSINESS CONTEXT
  project_id UUID REFERENCES public.projects(id),
  client_id UUID,
  reason TEXT, -- Why the change was made

  -- DATA INTEGRITY
  checksum TEXT, -- Hash of the data for integrity verification
  previous_checksum TEXT,

  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_audit_trail_entity ON public.compliance_audit_trail(entity_type, entity_id);
CREATE INDEX IF NOT EXISTS idx_audit_trail_actor ON public.compliance_audit_trail(actor_id);
CREATE INDEX IF NOT EXISTS idx_audit_trail_date ON public.compliance_audit_trail(action_timestamp DESC);
CREATE INDEX IF NOT EXISTS idx_audit_trail_project ON public.compliance_audit_trail(project_id);

-- ============================================================
-- 6. REPORT EXPORT HISTORY (For tracking downloads)
-- ============================================================
CREATE TABLE IF NOT EXISTS public.report_exports (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  report_id UUID REFERENCES public.reports(id) ON DELETE CASCADE NOT NULL,
  user_id UUID REFERENCES auth.users(id) ON DELETE SET NULL,

  -- EXPORT DETAILS
  export_type VARCHAR(20) NOT NULL, -- pdf, excel, csv, json, powerbi
  export_format VARCHAR(50), -- A4, letter, landscape, portrait
  file_size_bytes INTEGER,
  file_hash TEXT, -- SHA256 hash for integrity

  -- WHO EXPORTED
  exported_by_type VARCHAR(20), -- user, client, system
  exported_by_id UUID,
  exported_by_name VARCHAR(255),
  exported_by_email VARCHAR(255),

  -- WHEN & WHERE
  exported_at TIMESTAMPTZ DEFAULT NOW(),
  ip_address INET,
  user_agent TEXT,

  -- CLIENT EXPORTS
  client_portal_access_id UUID REFERENCES public.client_portal_access(id),

  -- WATERMARKING
  watermarked BOOLEAN DEFAULT false,
  watermark_text TEXT,
  watermark_config JSONB,

  -- FILE STORAGE
  file_url TEXT,
  storage_path TEXT,
  expires_at TIMESTAMPTZ, -- For temporary download links

  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_report_exports_report ON public.report_exports(report_id);
CREATE INDEX IF NOT EXISTS idx_report_exports_user ON public.report_exports(user_id);
CREATE INDEX IF NOT EXISTS idx_report_exports_date ON public.report_exports(exported_at DESC);

-- ============================================================
-- 7. REPORT APPROVAL WORKFLOWS
-- ============================================================
CREATE TABLE IF NOT EXISTS public.report_approvals (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  report_id UUID REFERENCES public.reports(id) ON DELETE CASCADE NOT NULL,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,

  -- WORKFLOW CONFIGURATION
  workflow_type VARCHAR(50) DEFAULT 'single', -- single, sequential, parallel
  required_approvers JSONB NOT NULL,
  -- [
  --   {user_id: 'uuid', role: 'project_manager', order: 1},
  --   {user_id: 'uuid', role: 'client', order: 2}
  -- ]

  current_step INTEGER DEFAULT 1,
  total_steps INTEGER,

  -- APPROVALS RECEIVED
  approvals JSONB DEFAULT '[]'::jsonb,
  -- [
  --   {user_id: 'uuid', approved: true, approved_at: '...', comments: '...', signature: '...'}
  -- ]

  rejections JSONB DEFAULT '[]'::jsonb,

  -- STATUS
  status VARCHAR(20) DEFAULT 'pending', -- pending, approved, rejected, expired
  final_decision_at TIMESTAMPTZ,
  final_decision_by UUID REFERENCES auth.users(id),
  final_comments TEXT,

  -- NOTIFICATIONS
  next_reminder_at TIMESTAMPTZ,
  reminder_count INTEGER DEFAULT 0,
  escalation_level INTEGER DEFAULT 0,

  -- DEADLINES
  due_date TIMESTAMPTZ,
  expires_at TIMESTAMPTZ,

  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_report_approvals_report ON public.report_approvals(report_id);
CREATE INDEX IF NOT EXISTS idx_report_approvals_status ON public.report_approvals(status);
CREATE INDEX IF NOT EXISTS idx_report_approvals_due ON public.report_approvals(due_date);

-- ============================================================
-- 8. COMPLIANCE CERTIFICATIONS TRACKER
-- ============================================================
CREATE TABLE IF NOT EXISTS public.compliance_certifications (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,

  -- CERTIFICATION INFO
  certification_name VARCHAR(255) NOT NULL,
  certification_type VARCHAR(100), -- OSHA, LEED, EPA, ISO, etc.
  certification_number VARCHAR(100),
  issuing_authority VARCHAR(255),

  -- RESPONSIBLE PARTY
  responsible_person_id UUID REFERENCES auth.users(id),
  responsible_person_name VARCHAR(255),
  responsible_person_email VARCHAR(255),

  -- DATES
  issue_date DATE,
  expiry_date DATE,
  renewal_date DATE,
  last_verified_date DATE,

  -- STATUS
  status VARCHAR(20), -- valid, expiring_soon, expired, pending_renewal
  is_active BOOLEAN DEFAULT true,

  -- DOCUMENTATION
  certificate_url TEXT,
  document_path TEXT,
  verification_url TEXT,

  -- RENEWAL TRACKING
  renewal_notification_sent BOOLEAN DEFAULT false,
  renewal_notification_sent_at TIMESTAMPTZ,
  auto_renew BOOLEAN DEFAULT false,

  -- PROJECTS REQUIRING THIS CERTIFICATION
  required_for_projects UUID[],

  -- METADATA
  notes TEXT,
  tags TEXT[],

  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_certifications_user ON public.compliance_certifications(user_id);
CREATE INDEX IF NOT EXISTS idx_certifications_expiry ON public.compliance_certifications(expiry_date);
CREATE INDEX IF NOT EXISTS idx_certifications_status ON public.compliance_certifications(status);

-- ============================================================
-- 9. ENABLE ROW LEVEL SECURITY
-- ============================================================
ALTER TABLE public.report_workflows ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.workflow_executions ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.client_portal_access ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.client_portal_activity ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.compliance_audit_trail ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.report_exports ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.report_approvals ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.compliance_certifications ENABLE ROW LEVEL SECURITY;

-- ============================================================
-- 10. RLS POLICIES
-- ============================================================

-- WORKFLOWS
DROP POLICY IF EXISTS "Users manage their workflows" ON public.report_workflows;
CREATE POLICY "Users manage their workflows"
  ON public.report_workflows FOR ALL
  USING (user_id = auth.uid());

-- WORKFLOW EXECUTIONS
DROP POLICY IF EXISTS "Users view their executions" ON public.workflow_executions;
CREATE POLICY "Users view their executions"
  ON public.workflow_executions FOR SELECT
  USING (
    workflow_id IN (
      SELECT id FROM public.report_workflows WHERE user_id = auth.uid()
    )
  );

-- CLIENT PORTAL ACCESS
DROP POLICY IF EXISTS "Users manage client portal" ON public.client_portal_access;
CREATE POLICY "Users manage client portal"
  ON public.client_portal_access FOR ALL
  USING (user_id = auth.uid());

-- CLIENT PORTAL ACTIVITY
DROP POLICY IF EXISTS "Users view portal activity" ON public.client_portal_activity;
CREATE POLICY "Users view portal activity"
  ON public.client_portal_activity FOR SELECT
  USING (
    portal_access_id IN (
      SELECT id FROM public.client_portal_access WHERE user_id = auth.uid()
    )
  );

-- AUDIT TRAIL
DROP POLICY IF EXISTS "Users view audit trail" ON public.compliance_audit_trail;
CREATE POLICY "Users view audit trail"
  ON public.compliance_audit_trail FOR SELECT
  USING (user_id = auth.uid());

-- EXPORTS
DROP POLICY IF EXISTS "Users view exports" ON public.report_exports;
CREATE POLICY "Users view exports"
  ON public.report_exports FOR SELECT
  USING (user_id = auth.uid());

-- APPROVALS
DROP POLICY IF EXISTS "Users manage approvals" ON public.report_approvals;
CREATE POLICY "Users manage approvals"
  ON public.report_approvals FOR ALL
  USING (user_id = auth.uid());

-- CERTIFICATIONS
DROP POLICY IF EXISTS "Users manage certifications" ON public.compliance_certifications;
CREATE POLICY "Users manage certifications"
  ON public.compliance_certifications FOR ALL
  USING (user_id = auth.uid());

-- ============================================================
-- 11. GRANT PERMISSIONS
-- ============================================================
GRANT ALL ON public.report_workflows TO authenticated;
GRANT ALL ON public.workflow_executions TO authenticated;
GRANT ALL ON public.client_portal_access TO authenticated;
GRANT ALL ON public.client_portal_activity TO authenticated;
GRANT ALL ON public.compliance_audit_trail TO authenticated;
GRANT ALL ON public.report_exports TO authenticated;
GRANT ALL ON public.report_approvals TO authenticated;
GRANT ALL ON public.compliance_certifications TO authenticated;

-- ============================================================
-- 12. ENTERPRISE FUNCTIONS
-- ============================================================

-- Execute workflow
CREATE OR REPLACE FUNCTION execute_workflow(workflow_id_param UUID)
RETURNS UUID AS $$
DECLARE
  execution_id UUID;
  workflow_record RECORD;
  action JSONB;
  report_id UUID;
BEGIN
  -- Get workflow
  SELECT * INTO workflow_record
  FROM public.report_workflows
  WHERE id = workflow_id_param
  AND is_active = true;

  IF NOT FOUND THEN
    RAISE EXCEPTION 'Workflow not found or inactive';
  END IF;

  -- Create execution record
  INSERT INTO public.workflow_executions (
    workflow_id,
    triggered_by,
    status
  ) VALUES (
    workflow_id_param,
    'manual',
    'running'
  ) RETURNING id INTO execution_id;

  -- Execute each action
  FOR action IN SELECT * FROM jsonb_array_elements(workflow_record.actions)
  LOOP
    -- Handle different action types
    IF action->>'type' = 'generate_report' THEN
      -- Generate report logic would go here
      -- For now, just log the action
      UPDATE public.workflow_executions
      SET actions_executed = actions_executed || jsonb_build_object(
        'action', 'generate_report',
        'status', 'success',
        'timestamp', NOW()
      )
      WHERE id = execution_id;
    END IF;
  END LOOP;

  -- Mark execution as complete
  UPDATE public.workflow_executions
  SET
    status = 'success',
    completed_at = NOW(),
    duration_ms = EXTRACT(EPOCH FROM (NOW() - started_at)) * 1000
  WHERE id = execution_id;

  -- Update workflow stats
  UPDATE public.report_workflows
  SET
    last_run_at = NOW(),
    last_run_status = 'success',
    run_count = run_count + 1,
    success_count = success_count + 1
  WHERE id = workflow_id_param;

  RETURN execution_id;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Log audit trail
CREATE OR REPLACE FUNCTION log_audit_trail(
  entity_type_param VARCHAR,
  entity_id_param UUID,
  action_param VARCHAR,
  previous_values_param JSONB DEFAULT NULL,
  new_values_param JSONB DEFAULT NULL
)
RETURNS UUID AS $$
DECLARE
  audit_id UUID;
BEGIN
  INSERT INTO public.compliance_audit_trail (
    user_id,
    entity_type,
    entity_id,
    action,
    actor_type,
    actor_id,
    previous_values,
    new_values
  ) VALUES (
    auth.uid(),
    entity_type_param,
    entity_id_param,
    action_param,
    'user',
    auth.uid(),
    previous_values_param,
    new_values_param
  ) RETURNING id INTO audit_id;

  RETURN audit_id;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Check certification expiry
CREATE OR REPLACE FUNCTION check_certification_expiry()
RETURNS TABLE(
  certification_id UUID,
  certification_name VARCHAR,
  expiry_date DATE,
  days_until_expiry INTEGER,
  status VARCHAR
) AS $$
BEGIN
  RETURN QUERY
  SELECT
    id,
    certification_name,
    expiry_date,
    (expiry_date - CURRENT_DATE)::INTEGER as days_until_expiry,
    CASE
      WHEN expiry_date < CURRENT_DATE THEN 'expired'
      WHEN expiry_date <= CURRENT_DATE + INTERVAL '30 days' THEN 'expiring_soon'
      ELSE 'valid'
    END::VARCHAR as status
  FROM public.compliance_certifications
  WHERE is_active = true
  AND user_id = auth.uid()
  ORDER BY expiry_date ASC;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- ============================================================
-- SETUP COMPLETE!
-- ============================================================

SELECT 'ReportCenter Enterprise Schema Created Successfully!' as status,
       'Phase 3: Automation, Client Portal, Compliance, and Security' as phase;


#17

===========================================================
-- CRM SUITE DATABASE SCHEMA
-- Complete customer relationship management for construction
-- ============================================================

-- ============================================================
-- 1. CRM CONTACTS (Clients, Prospects, Vendors, Subcontractors)
-- ============================================================
CREATE TABLE IF NOT EXISTS public.crm_contacts (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,

  -- CONTACT INFO
  first_name VARCHAR(100) NOT NULL,
  last_name VARCHAR(100) NOT NULL,
  full_name VARCHAR(255) GENERATED ALWAYS AS (first_name || ' ' || last_name) STORED,
  email VARCHAR(255),
  phone VARCHAR(50),
  mobile VARCHAR(50),

  -- COMPANY INFO
  company VARCHAR(255),
  job_title VARCHAR(100),
  website VARCHAR(255),

  -- ADDRESS
  street_address TEXT,
  city VARCHAR(100),
  state VARCHAR(50),
  zip_code VARCHAR(20),
  country VARCHAR(100) DEFAULT 'United States',

  -- CATEGORIZATION
  category VARCHAR(50) DEFAULT 'prospect', -- client, prospect, vendor, subcontractor, partner
  contact_type VARCHAR(50), -- homeowner, property_manager, developer, architect, gc
  lead_source VARCHAR(100), -- referral, website, trade_show, cold_call, advertisement
  tags TEXT[],

  -- CONSTRUCTION-SPECIFIC
  project_types_interested TEXT[], -- residential, commercial, renovation, new_construction
  preferred_contract_method VARCHAR(50), -- fixed_price, time_materials, cost_plus
  trade_specialties TEXT[], -- For subcontractors
  annual_volume DECIMAL(12,2), -- Estimated annual project volume
  territory VARCHAR(100),

  -- RELATIONSHIPS
  referred_by UUID REFERENCES public.crm_contacts(id),
  account_manager UUID REFERENCES auth.users(id),

  -- STATUS
  status VARCHAR(20) DEFAULT 'active', -- active, inactive, do_not_contact
  is_favorite BOOLEAN DEFAULT false,
  quality_score INTEGER CHECK (quality_score BETWEEN 1 AND 5), -- Lead quality rating

  -- COMMUNICATION PREFERENCES
  preferred_contact_method VARCHAR(20), -- email, phone, text, in_person
  best_time_to_contact VARCHAR(50),
  email_opt_in BOOLEAN DEFAULT true,
  sms_opt_in BOOLEAN DEFAULT false,

  -- FINANCIAL
  credit_limit DECIMAL(12,2),
  payment_terms VARCHAR(50), -- Net 30, Net 15, COD, etc.
  tax_id VARCHAR(50), -- EIN for businesses

  -- INTEGRATION
  integration_id UUID, -- Reference to user_integrations if synced from external system
  external_id VARCHAR(255), -- ID from QuickBooks, etc.
  sync_status VARCHAR(20), -- synced, pending, error
  last_sync_at TIMESTAMPTZ,

  -- METADATA
  notes TEXT,
  profile_image_url TEXT,
  social_media JSONB, -- {linkedin, facebook, instagram}
  custom_fields JSONB, -- Extensible for user-specific data

  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),

  -- CONSTRAINTS
  UNIQUE(user_id, email)
);

CREATE INDEX IF NOT EXISTS idx_crm_contacts_user ON public.crm_contacts(user_id);
CREATE INDEX IF NOT EXISTS idx_crm_contacts_email ON public.crm_contacts(email);
CREATE INDEX IF NOT EXISTS idx_crm_contacts_category ON public.crm_contacts(category);
CREATE INDEX IF NOT EXISTS idx_crm_contacts_status ON public.crm_contacts(status);
CREATE INDEX IF NOT EXISTS idx_crm_contacts_company ON public.crm_contacts(company);

-- ============================================================
-- 2. CRM LEADS PIPELINE
-- ============================================================
CREATE TABLE IF NOT EXISTS public.crm_leads (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
  contact_id UUID REFERENCES public.crm_contacts(id) ON DELETE CASCADE,

  -- LEAD INFO
  title VARCHAR(255) NOT NULL, -- "Kitchen Remodel - Smith Residence"
  description TEXT,

  -- PIPELINE STAGE
  stage VARCHAR(50) DEFAULT 'new', -- new, contacted, qualified, proposal_sent, negotiation, won, lost
  stage_order INTEGER, -- For custom stage ordering
  stage_changed_at TIMESTAMPTZ DEFAULT NOW(),

  -- VALUE & PROBABILITY
  estimated_value DECIMAL(12,2),
  probability INTEGER DEFAULT 50 CHECK (probability BETWEEN 0 AND 100),
  weighted_value DECIMAL(12,2) GENERATED ALWAYS AS (estimated_value * probability / 100) STORED,

  -- CONSTRUCTION-SPECIFIC
  project_type VARCHAR(100), -- residential_remodel, commercial_build, new_construction
  project_size VARCHAR(50), -- small (<50k), medium (50k-250k), large (250k+)
  square_footage INTEGER,
  estimated_duration_days INTEGER,
  preferred_start_date DATE,

  -- TRACKING
  lead_source VARCHAR(100),
  source_campaign VARCHAR(100), -- For marketing attribution
  assigned_to UUID REFERENCES auth.users(id),

  -- TIMELINE
  first_contact_date DATE,
  last_contact_date DATE,
  expected_close_date DATE,
  actual_close_date DATE,

  -- OUTCOME
  won_reason TEXT, -- Why we won
  lost_reason TEXT, -- Why we lost
  lost_to_competitor VARCHAR(255), -- Which competitor

  -- LINKED RECORDS
  quote_id UUID REFERENCES public.quotes(id), -- From QuoteHub
  project_id UUID REFERENCES public.projects(id), -- If converted to project

  -- STATUS
  is_active BOOLEAN DEFAULT true,
  priority VARCHAR(20) DEFAULT 'medium', -- low, medium, high, urgent
  confidence_level VARCHAR(20), -- low, medium, high

  -- FOLLOW-UP
  next_action VARCHAR(255),
  next_action_date DATE,
  reminder_set BOOLEAN DEFAULT false,

  -- METADATA
  notes TEXT,
  tags TEXT[],
  custom_fields JSONB,

  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_crm_leads_user ON public.crm_leads(user_id);
CREATE INDEX IF NOT EXISTS idx_crm_leads_contact ON public.crm_leads(contact_id);
CREATE INDEX IF NOT EXISTS idx_crm_leads_stage ON public.crm_leads(stage);
CREATE INDEX IF NOT EXISTS idx_crm_leads_assigned ON public.crm_leads(assigned_to);
CREATE INDEX IF NOT EXISTS idx_crm_leads_status ON public.crm_leads(is_active);

-- ============================================================
-- 3. CRM ACTIVITIES (Calls, Emails, Meetings, Site Visits)
-- ============================================================
CREATE TABLE IF NOT EXISTS public.crm_activities (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,

  -- ASSOCIATIONS
  contact_id UUID REFERENCES public.crm_contacts(id) ON DELETE CASCADE,
  lead_id UUID REFERENCES public.crm_leads(id) ON DELETE SET NULL,
  project_id UUID REFERENCES public.projects(id) ON DELETE SET NULL,

  -- ACTIVITY TYPE
  activity_type VARCHAR(50) NOT NULL, -- call, email, meeting, site_visit, quote_sent, proposal_sent, contract_signed
  activity_subtype VARCHAR(50), -- inbound_call, outbound_call, cold_call, follow_up

  -- DETAILS
  subject VARCHAR(255),
  description TEXT,

  -- SCHEDULING
  scheduled_date TIMESTAMPTZ,
  scheduled_duration_minutes INTEGER,
  actual_start_time TIMESTAMPTZ,
  actual_end_time TIMESTAMPTZ,
  actual_duration_minutes INTEGER,

  -- STATUS
  status VARCHAR(20) DEFAULT 'scheduled', -- scheduled, completed, cancelled, no_show
  is_completed BOOLEAN DEFAULT false,
  completed_at TIMESTAMPTZ,

  -- OUTCOME
  outcome VARCHAR(100), -- successful, unsuccessful, needs_follow_up, meeting_scheduled
  outcome_notes TEXT,
  sentiment VARCHAR(20), -- positive, neutral, negative

  -- FOLLOW-UP
  follow_up_required BOOLEAN DEFAULT false,
  follow_up_date DATE,
  follow_up_assigned_to UUID REFERENCES auth.users(id),

  -- LOCATION (for site visits, meetings)
  location VARCHAR(255),
  location_coordinates POINT, -- GPS coordinates

  -- PARTICIPANTS
  participants JSONB, -- [{user_id, name, role}]
  attendees_count INTEGER,

  -- COMMUNICATION TRACKING
  email_message_id TEXT, -- If synced from email integration
  email_thread_id TEXT,
  call_recording_url TEXT,
  call_duration_seconds INTEGER,

  -- METADATA
  priority VARCHAR(20) DEFAULT 'normal', -- low, normal, high
  is_billable BOOLEAN DEFAULT false,
  billable_amount DECIMAL(10,2),
  tags TEXT[],

  created_by UUID REFERENCES auth.users(id),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_crm_activities_user ON public.crm_activities(user_id);
CREATE INDEX IF NOT EXISTS idx_crm_activities_contact ON public.crm_activities(contact_id);
CREATE INDEX IF NOT EXISTS idx_crm_activities_lead ON public.crm_activities(lead_id);
CREATE INDEX IF NOT EXISTS idx_crm_activities_type ON public.crm_activities(activity_type);
CREATE INDEX IF NOT EXISTS idx_crm_activities_date ON public.crm_activities(scheduled_date);
CREATE INDEX IF NOT EXISTS idx_crm_activities_status ON public.crm_activities(status);

-- ============================================================
-- 4. CRM OPPORTUNITIES (Converted Leads / Active Deals)
-- ============================================================
CREATE TABLE IF NOT EXISTS public.crm_opportunities (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,

  -- SOURCE
  lead_id UUID REFERENCES public.crm_leads(id),
  contact_id UUID REFERENCES public.crm_contacts(id) NOT NULL,
  quote_id UUID REFERENCES public.quotes(id),

  -- OPPORTUNITY INFO
  opportunity_name VARCHAR(255) NOT NULL,
  description TEXT,

  -- PROJECT DETAILS
  project_id UUID REFERENCES public.projects(id), -- When opportunity converts to active project
  project_type VARCHAR(100),
  scope_of_work TEXT,

  -- FINANCIAL
  contract_value DECIMAL(12,2) NOT NULL,
  estimated_costs DECIMAL(12,2),
  estimated_profit DECIMAL(12,2) GENERATED ALWAYS AS (contract_value - COALESCE(estimated_costs, 0)) STORED,
  profit_margin DECIMAL(5,4) GENERATED ALWAYS AS (
    CASE WHEN contract_value > 0
    THEN (contract_value - COALESCE(estimated_costs, 0)) / contract_value
    ELSE 0 END
  ) STORED,

  -- TIMELINE
  start_date DATE,
  expected_completion_date DATE,
  actual_completion_date DATE,

  -- STATUS
  status VARCHAR(50) DEFAULT 'active', -- active, won, completed, on_hold, cancelled, lost
  stage VARCHAR(50), -- planning, permitting, construction, closeout
  completion_percentage INTEGER DEFAULT 0 CHECK (completion_percentage BETWEEN 0 AND 100),

  -- TEAM
  account_owner UUID REFERENCES auth.users(id),
  project_manager UUID REFERENCES auth.users(id),
  team_members UUID[],

  -- TRACKING
  win_date DATE,
  win_probability INTEGER CHECK (win_probability BETWEEN 0 AND 100),

  -- RISK FACTORS
  risk_level VARCHAR(20), -- low, medium, high
  risk_notes TEXT,

  -- METADATA
  notes TEXT,
  tags TEXT[],
  custom_fields JSONB,

  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_crm_opportunities_user ON public.crm_opportunities(user_id);
CREATE INDEX IF NOT EXISTS idx_crm_opportunities_contact ON public.crm_opportunities(contact_id);
CREATE INDEX IF NOT EXISTS idx_crm_opportunities_lead ON public.crm_opportunities(lead_id);
CREATE INDEX IF NOT EXISTS idx_crm_opportunities_status ON public.crm_opportunities(status);
CREATE INDEX IF NOT EXISTS idx_crm_opportunities_project ON public.crm_opportunities(project_id);

-- ============================================================
-- 5. CRM EMAIL TEMPLATES
-- ============================================================
CREATE TABLE IF NOT EXISTS public.crm_email_templates (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,

  -- TEMPLATE INFO
  template_name VARCHAR(255) NOT NULL,
  subject_line VARCHAR(500),
  body_html TEXT,
  body_plain TEXT,

  -- CATEGORIZATION
  category VARCHAR(50), -- follow_up, quote, proposal, thank_you, status_update
  is_system_template BOOLEAN DEFAULT false,
  is_active BOOLEAN DEFAULT true,

  -- USAGE
  use_count INTEGER DEFAULT 0,
  last_used_at TIMESTAMPTZ,

  -- VARIABLES (for personalization)
  available_variables JSONB, -- {contact_name, project_name, quote_total, etc.}

  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_crm_email_templates_user ON public.crm_email_templates(user_id);
CREATE INDEX IF NOT EXISTS idx_crm_email_templates_category ON public.crm_email_templates(category);

-- ============================================================
-- 6. CRM NOTES
-- ============================================================
CREATE TABLE IF NOT EXISTS public.crm_notes (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,

  -- ASSOCIATIONS
  contact_id UUID REFERENCES public.crm_contacts(id) ON DELETE CASCADE,
  lead_id UUID REFERENCES public.crm_leads(id) ON DELETE CASCADE,
  opportunity_id UUID REFERENCES public.crm_opportunities(id) ON DELETE CASCADE,
  activity_id UUID REFERENCES public.crm_activities(id) ON DELETE CASCADE,

  -- NOTE CONTENT
  note_type VARCHAR(50) DEFAULT 'general', -- general, follow_up, meeting_notes, phone_call
  content TEXT NOT NULL,

  -- METADATA
  is_pinned BOOLEAN DEFAULT false,
  is_private BOOLEAN DEFAULT false, -- Only visible to creator
  tags TEXT[],

  -- ATTACHMENTS
  attachments JSONB, -- [{filename, url, size, type}]

  created_by UUID REFERENCES auth.users(id),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_crm_notes_contact ON public.crm_notes(contact_id);
CREATE INDEX IF NOT EXISTS idx_crm_notes_lead ON public.crm_notes(lead_id);
CREATE INDEX IF NOT EXISTS idx_crm_notes_created_by ON public.crm_notes(created_by);

-- ============================================================
-- 7. CRM PIPELINE STAGES (Customizable)
-- ============================================================
CREATE TABLE IF NOT EXISTS public.crm_pipeline_stages (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,

  -- STAGE INFO
  stage_name VARCHAR(100) NOT NULL,
  stage_key VARCHAR(50) NOT NULL, -- Unique identifier for queries
  description TEXT,

  -- CONFIGURATION
  stage_order INTEGER NOT NULL,
  probability_default INTEGER DEFAULT 50,

  -- VISUAL
  color VARCHAR(7), -- Hex color code
  icon VARCHAR(50),

  -- AUTOMATION
  auto_actions JSONB, -- Actions to take when lead enters this stage
  required_fields TEXT[], -- Fields that must be filled before moving to next stage

  -- STATUS
  is_active BOOLEAN DEFAULT true,
  is_system_stage BOOLEAN DEFAULT false, -- Can't be deleted

  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),

  UNIQUE(user_id, stage_key)
);

CREATE INDEX IF NOT EXISTS idx_crm_pipeline_stages_user ON public.crm_pipeline_stages(user_id);
CREATE INDEX IF NOT EXISTS idx_crm_pipeline_stages_order ON public.crm_pipeline_stages(stage_order);

-- ============================================================
-- 8. CRM INTEGRATIONS LOG
-- ============================================================
CREATE TABLE IF NOT EXISTS public.crm_integration_sync_log (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,

  -- SYNC INFO
  integration_type VARCHAR(50), -- quickbooks, google_contacts, outlook, excel
  sync_direction VARCHAR(20), -- import, export, bidirectional

  -- RESULTS
  records_processed INTEGER DEFAULT 0,
  records_created INTEGER DEFAULT 0,
  records_updated INTEGER DEFAULT 0,
  records_failed INTEGER DEFAULT 0,

  -- STATUS
  status VARCHAR(20), -- running, completed, failed, partial
  error_message TEXT,
  error_details JSONB,

  -- TIMING
  started_at TIMESTAMPTZ DEFAULT NOW(),
  completed_at TIMESTAMPTZ,
  duration_seconds INTEGER,

  -- METADATA
  sync_config JSONB, -- Configuration used for this sync

  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_crm_sync_log_user ON public.crm_integration_sync_log(user_id);
CREATE INDEX IF NOT EXISTS idx_crm_sync_log_type ON public.crm_integration_sync_log(integration_type);
CREATE INDEX IF NOT EXISTS idx_crm_sync_log_date ON public.crm_integration_sync_log(created_at DESC);

-- ============================================================
-- 9. ENABLE ROW LEVEL SECURITY
-- ============================================================
ALTER TABLE public.crm_contacts ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.crm_leads ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.crm_activities ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.crm_opportunities ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.crm_email_templates ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.crm_notes ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.crm_pipeline_stages ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.crm_integration_sync_log ENABLE ROW LEVEL SECURITY;

-- ============================================================
-- 10. RLS POLICIES
-- ============================================================

-- CONTACTS
DROP POLICY IF EXISTS "Users manage their contacts" ON public.crm_contacts;
CREATE POLICY "Users manage their contacts"
  ON public.crm_contacts FOR ALL
  USING (user_id = auth.uid());

-- LEADS
DROP POLICY IF EXISTS "Users manage their leads" ON public.crm_leads;
CREATE POLICY "Users manage their leads"
  ON public.crm_leads FOR ALL
  USING (user_id = auth.uid());

-- ACTIVITIES
DROP POLICY IF EXISTS "Users manage their activities" ON public.crm_activities;
CREATE POLICY "Users manage their activities"
  ON public.crm_activities FOR ALL
  USING (user_id = auth.uid());

-- OPPORTUNITIES
DROP POLICY IF EXISTS "Users manage their opportunities" ON public.crm_opportunities;
CREATE POLICY "Users manage their opportunities"
  ON public.crm_opportunities FOR ALL
  USING (user_id = auth.uid());

-- EMAIL TEMPLATES
DROP POLICY IF EXISTS "Users manage their templates" ON public.crm_email_templates;
CREATE POLICY "Users manage their templates"
  ON public.crm_email_templates FOR ALL
  USING (user_id = auth.uid() OR is_system_template = true);

-- NOTES
DROP POLICY IF EXISTS "Users view their notes" ON public.crm_notes;
CREATE POLICY "Users view their notes"
  ON public.crm_notes FOR SELECT
  USING (user_id = auth.uid() OR (created_by = auth.uid() AND is_private = false));

DROP POLICY IF EXISTS "Users create notes" ON public.crm_notes;
CREATE POLICY "Users create notes"
  ON public.crm_notes FOR INSERT
  WITH CHECK (user_id = auth.uid());

-- PIPELINE STAGES
DROP POLICY IF EXISTS "Users manage their stages" ON public.crm_pipeline_stages;
CREATE POLICY "Users manage their stages"
  ON public.crm_pipeline_stages FOR ALL
  USING (user_id = auth.uid());

-- INTEGRATION LOG
DROP POLICY IF EXISTS "Users view sync log" ON public.crm_integration_sync_log;
CREATE POLICY "Users view sync log"
  ON public.crm_integration_sync_log FOR SELECT
  USING (user_id = auth.uid());

-- ============================================================
-- 11. GRANT PERMISSIONS
-- ============================================================
GRANT ALL ON public.crm_contacts TO authenticated;
GRANT ALL ON public.crm_leads TO authenticated;
GRANT ALL ON public.crm_activities TO authenticated;
GRANT ALL ON public.crm_opportunities TO authenticated;
GRANT ALL ON public.crm_email_templates TO authenticated;
GRANT ALL ON public.crm_notes TO authenticated;
GRANT ALL ON public.crm_pipeline_stages TO authenticated;
GRANT ALL ON public.crm_integration_sync_log TO authenticated;

-- ============================================================
-- 12. HELPER FUNCTIONS
-- ============================================================

-- Convert lead to opportunity
CREATE OR REPLACE FUNCTION convert_lead_to_opportunity(
  lead_id_param UUID,
  contract_value_param DECIMAL
)
RETURNS UUID AS $$
DECLARE
  opportunity_id UUID;
  lead_record RECORD;
BEGIN
  -- Get lead data
  SELECT * INTO lead_record
  FROM public.crm_leads
  WHERE id = lead_id_param;

  -- Create opportunity
  INSERT INTO public.crm_opportunities (
    user_id,
    lead_id,
    contact_id,
    quote_id,
    opportunity_name,
    description,
    project_type,
    contract_value,
    account_owner,
    win_date,
    status
  ) VALUES (
    lead_record.user_id,
    lead_record.id,
    lead_record.contact_id,
    lead_record.quote_id,
    lead_record.title,
    lead_record.description,
    lead_record.project_type,
    contract_value_param,
    lead_record.assigned_to,
    CURRENT_DATE,
    'won'
  ) RETURNING id INTO opportunity_id;

  -- Update lead
  UPDATE public.crm_leads
  SET
    stage = 'won',
    actual_close_date = CURRENT_DATE,
    is_active = false
  WHERE id = lead_id_param;

  RETURN opportunity_id;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Calculate pipeline metrics
CREATE OR REPLACE FUNCTION get_pipeline_metrics(user_id_param UUID)
RETURNS TABLE(
  total_leads INTEGER,
  total_value DECIMAL,
  weighted_value DECIMAL,
  avg_deal_size DECIMAL,
  win_rate DECIMAL
) AS $$
BEGIN
  RETURN QUERY
  SELECT
    COUNT(*)::INTEGER as total_leads,
    COALESCE(SUM(estimated_value), 0) as total_value,
    COALESCE(SUM(weighted_value), 0) as weighted_value,
    COALESCE(AVG(estimated_value), 0) as avg_deal_size,
    CASE
      WHEN COUNT(*) FILTER (WHERE stage IN ('won', 'lost')) > 0
      THEN COUNT(*) FILTER (WHERE stage = 'won')::DECIMAL / COUNT(*) FILTER (WHERE stage IN ('won', 'lost'))
      ELSE 0
    END as win_rate
  FROM public.crm_leads
  WHERE user_id = user_id_param
  AND is_active = true;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- ============================================================
-- 13. INSERT DEFAULT PIPELINE STAGES
-- ============================================================

-- These are inserted per user on account creation
-- For now, create a function to initialize stages

CREATE OR REPLACE FUNCTION initialize_crm_pipeline_stages(user_id_param UUID)
RETURNS VOID AS $$
BEGIN
  INSERT INTO public.crm_pipeline_stages (user_id, stage_name, stage_key, stage_order, probability_default, color, is_system_stage)
  VALUES
    (user_id_param, 'New Lead', 'new', 1, 10, '#6B7280', true),
    (user_id_param, 'Contacted', 'contacted', 2, 20, '#3B82F6', true),
    (user_id_param, 'Qualified', 'qualified', 3, 40, '#8B5CF6', true),
    (user_id_param, 'Proposal Sent', 'proposal_sent', 4, 60, '#F59E0B', true),
    (user_id_param, 'Negotiation', 'negotiation', 5, 80, '#F97316', true),
    (user_id_param, 'Won', 'won', 6, 100, '#10B981', true),
    (user_id_param, 'Lost', 'lost', 7, 0, '#EF4444', true)
  ON CONFLICT DO NOTHING;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- ============================================================
-- SETUP COMPLETE!
-- ============================================================

SELECT 'CRM Suite Database Schema Created Successfully!' as status,
       '8 tables created with construction-focused CRM capabilities' as details;


#18

============================================================================
-- MIGRATION 003: ADD CUSTOM TASK TEMPLATES
-- ============================================================================
-- Date: January 24, 2026
-- Purpose: Deploy custom_task_templates table (missing from Supabase)
-- Required for: CustomTemplateManager component (Enterprise Part 2)
-- Dependencies: tasks table must exist
-- ============================================================================

-- ============================================================================
-- STEP 1: CREATE TABLE
-- ============================================================================

CREATE TABLE IF NOT EXISTS public.custom_task_templates (
  -- Primary Key
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

  -- Ownership
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  company_id UUID NOT NULL,

  -- Template Information
  name VARCHAR(255) NOT NULL,
  description TEXT,
  category VARCHAR(50) NOT NULL CHECK (category IN ('general', 'residential', 'commercial', 'renovation', 'infrastructure')),
  icon VARCHAR(10) DEFAULT '',

  -- Tasks (JSONB array of task objects)
  tasks JSONB NOT NULL DEFAULT '[]'::jsonb,

  -- Sharing
  is_public BOOLEAN DEFAULT false, -- Share with company

  -- Timestamps
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- ============================================================================
-- STEP 2: CREATE INDEXES
-- ============================================================================

-- Index for user templates
CREATE INDEX IF NOT EXISTS idx_custom_task_templates_user ON public.custom_task_templates(user_id);

-- Index for company templates
CREATE INDEX IF NOT EXISTS idx_custom_task_templates_company ON public.custom_task_templates(company_id);

-- Index for public templates
CREATE INDEX IF NOT EXISTS idx_custom_task_templates_public ON public.custom_task_templates(is_public) WHERE is_public = true;

-- Index for category filtering
CREATE INDEX IF NOT EXISTS idx_custom_task_templates_category ON public.custom_task_templates(category);

-- Composite index for efficient queries
CREATE INDEX IF NOT EXISTS idx_custom_task_templates_user_company ON public.custom_task_templates(user_id, company_id);

-- ============================================================================
-- STEP 3: ENABLE ROW LEVEL SECURITY (RLS)
-- ============================================================================

ALTER TABLE public.custom_task_templates ENABLE ROW LEVEL SECURITY;

-- ============================================================================
-- STEP 4: CREATE RLS POLICIES
-- ============================================================================

-- Users can see their own templates
DROP POLICY IF EXISTS "Users can view own templates" ON public.custom_task_templates;
CREATE POLICY "Users can view own templates" ON public.custom_task_templates
  FOR SELECT
  USING (auth.uid() = user_id);

-- Users can see public templates from their company
DROP POLICY IF EXISTS "Users can view company public templates" ON public.custom_task_templates;
CREATE POLICY "Users can view company public templates" ON public.custom_task_templates
  FOR SELECT
  USING (
    is_public = true
    AND company_id IN (
      SELECT company_id FROM public.user_profiles WHERE id = auth.uid()
    )
  );

-- Users can create templates
DROP POLICY IF EXISTS "Users can create templates" ON public.custom_task_templates;
CREATE POLICY "Users can create templates" ON public.custom_task_templates
  FOR INSERT
  WITH CHECK (
    auth.uid() = user_id
    AND company_id IN (
      SELECT company_id FROM public.user_profiles WHERE id = auth.uid()
    )
  );

-- Users can update their own templates
DROP POLICY IF EXISTS "Users can update own templates" ON public.custom_task_templates;
CREATE POLICY "Users can update own templates" ON public.custom_task_templates
  FOR UPDATE
  USING (auth.uid() = user_id)
  WITH CHECK (auth.uid() = user_id);

-- Users can delete their own templates
DROP POLICY IF EXISTS "Users can delete own templates" ON public.custom_task_templates;
CREATE POLICY "Users can delete own templates" ON public.custom_task_templates
  FOR DELETE
  USING (auth.uid() = user_id);

-- ============================================================================
-- STEP 5: CREATE FUNCTIONS
-- ============================================================================

-- Update updated_at timestamp
CREATE OR REPLACE FUNCTION update_custom_task_templates_timestamp()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- ============================================================================
-- STEP 6: CREATE TRIGGERS
-- ============================================================================

DROP TRIGGER IF EXISTS custom_task_templates_updated_at ON public.custom_task_templates;
CREATE TRIGGER custom_task_templates_updated_at
  BEFORE UPDATE ON public.custom_task_templates
  FOR EACH ROW
  EXECUTE FUNCTION update_custom_task_templates_timestamp();

-- ============================================================================
-- STEP 7: ADD CONSTRAINTS
-- ============================================================================

-- Add constraint to ensure tasks is a valid array
ALTER TABLE public.custom_task_templates
  DROP CONSTRAINT IF EXISTS tasks_is_array;
ALTER TABLE public.custom_task_templates
  ADD CONSTRAINT tasks_is_array CHECK (jsonb_typeof(tasks) = 'array');

-- Add constraint for minimum template name length
ALTER TABLE public.custom_task_templates
  DROP CONSTRAINT IF EXISTS name_min_length;
ALTER TABLE public.custom_task_templates
  ADD CONSTRAINT name_min_length CHECK (char_length(name) >= 3);

-- ============================================================================
-- STEP 8: ADD COMMENTS
-- ============================================================================

COMMENT ON TABLE public.custom_task_templates IS 'User-created and company-shared workflow templates';
COMMENT ON COLUMN public.custom_task_templates.id IS 'Unique identifier for the template';
COMMENT ON COLUMN public.custom_task_templates.user_id IS 'User who created the template';
COMMENT ON COLUMN public.custom_task_templates.company_id IS 'Company the template belongs to';
COMMENT ON COLUMN public.custom_task_templates.name IS 'Template name';
COMMENT ON COLUMN public.custom_task_templates.description IS 'Template description';
COMMENT ON COLUMN public.custom_task_templates.category IS 'Template category (general, residential, commercial, etc.)';
COMMENT ON COLUMN public.custom_task_templates.icon IS 'Emoji icon for the template';
COMMENT ON COLUMN public.custom_task_templates.tasks IS 'JSONB array of task objects';
COMMENT ON COLUMN public.custom_task_templates.is_public IS 'Whether the template is shared with the company';
COMMENT ON COLUMN public.custom_task_templates.created_at IS 'Timestamp when template was created';
COMMENT ON COLUMN public.custom_task_templates.updated_at IS 'Timestamp when template was last updated';

-- ============================================================================
-- STEP 9: GRANT PERMISSIONS
-- ============================================================================

GRANT ALL ON public.custom_task_templates TO authenticated;

-- ============================================================================
-- STEP 10: VERIFY DEPLOYMENT
-- ============================================================================

DO $$
BEGIN
  -- Check if table exists
  IF EXISTS (
    SELECT FROM information_schema.tables
    WHERE table_schema = 'public'
    AND table_name = 'custom_task_templates'
  ) THEN
    RAISE NOTICE ' Table custom_task_templates created successfully!';
  ELSE
    RAISE EXCEPTION ' Table custom_task_templates was not created!';
  END IF;

  -- Check if RLS is enabled
  IF EXISTS (
    SELECT FROM pg_tables
    WHERE schemaname = 'public'
    AND tablename = 'custom_task_templates'
    AND rowsecurity = true
  ) THEN
    RAISE NOTICE ' RLS enabled on custom_task_templates';
  ELSE
    RAISE WARNING '  RLS NOT enabled on custom_task_templates!';
  END IF;

  -- Check policies
  IF EXISTS (
    SELECT FROM pg_policies
    WHERE tablename = 'custom_task_templates'
  ) THEN
    RAISE NOTICE ' RLS policies created for custom_task_templates';
    RAISE NOTICE 'Policy count: %', (SELECT COUNT(*) FROM pg_policies WHERE tablename = 'custom_task_templates');
  ELSE
    RAISE WARNING '  No RLS policies found for custom_task_templates!';
  END IF;

  RAISE NOTICE '';
  RAISE NOTICE '====================================';
  RAISE NOTICE ' MIGRATION 003 COMPLETED';
  RAISE NOTICE '====================================';
  RAISE NOTICE 'Table: custom_task_templates';
  RAISE NOTICE 'Indexes: 5 created';
  RAISE NOTICE 'RLS Policies: 5 created';
  RAISE NOTICE 'Triggers: 1 created';
  RAISE NOTICE 'Constraints: 2 created';
  RAISE NOTICE '';
  RAISE NOTICE ' Custom Task Templates feature is now ready!';
  RAISE NOTICE 'Users can create and share workflow templates.';
END $$;

-- ============================================================================
-- OPTIONAL: SAMPLE DATA (Uncomment to insert example template)
-- ============================================================================

/*
-- Example custom template (DO NOT RUN IN PRODUCTION)
INSERT INTO public.custom_task_templates (user_id, company_id, name, description, category, icon, is_public, tasks)
VALUES (
  'YOUR-USER-ID-HERE',
  'YOUR-COMPANY-ID-HERE',
  'Sample Custom Workflow',
  'Example template showing structure',
  'general',
  '',
  false,
  '[
    {
      "title": "Task 1",
      "description": "First task in workflow",
      "estimated_hours": 8,
      "priority": "high",
      "dependencies": []
    },
    {
      "title": "Task 2",
      "description": "Second task in workflow",
      "estimated_hours": 16,
      "priority": "medium",
      "dependencies": [0]
    }
  ]'::jsonb
);
*/

-- ============================================================================
-- ROLLBACK SCRIPT (If you need to undo this migration)
-- ============================================================================

/*
-- To rollback this migration, run:

DROP TRIGGER IF EXISTS custom_task_templates_updated_at ON public.custom_task_templates;
DROP FUNCTION IF EXISTS update_custom_task_templates_timestamp();
DROP TABLE IF EXISTS public.custom_task_templates CASCADE;

-- Verify rollback
SELECT 'custom_task_templates table dropped successfully' AS status
WHERE NOT EXISTS (
  SELECT FROM information_schema.tables
  WHERE table_schema = 'public'
  AND table_name = 'custom_task_templates'
);
*/

-- ============================================================================
-- END OF MIGRATION 003
-- ============================================================================


#19

===========================================
-- MODULE 10: TEAMS & RBAC - DATABASE SCHEMA
-- ============================================
-- Created: February 9, 2026
-- Purpose: Complete role-based access control system
-- Quality Target: 98%+ production-ready
--
-- Features:
-- - 7 built-in construction-specific roles
-- - Custom role creation
-- - Granular permissions (30+ permission points)
-- - Row-level security
-- - Comprehensive audit logging
-- - Multi-company isolation
-- - Project-level role overrides
-- ============================================

BEGIN;

-- ============================================
-- TABLE: custom_roles
-- Stores both system roles and company-custom roles
-- ============================================

CREATE TABLE IF NOT EXISTS custom_roles (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  company_id UUID REFERENCES companies(id) ON DELETE CASCADE,

  -- Role Identity
  role_name VARCHAR(100) NOT NULL,
  role_slug VARCHAR(100) NOT NULL,
  description TEXT,
  color VARCHAR(7) NOT NULL DEFAULT '#6B7280', -- Hex color for UI
  icon VARCHAR(10) DEFAULT '', -- Emoji icon

  -- Permissions (JSONB for flexibility)
  permissions JSONB NOT NULL DEFAULT '{}'::jsonb,
  /* Permission structure (30 permissions total):
  {
    "canViewAllProjects": boolean,
    "canEditProjects": boolean,
    "canDeleteProjects": boolean,
    "canCreateProjects": boolean,
    "canManageTeam": boolean,
    "canInviteMembers": boolean,
    "canRemoveMembers": boolean,
    "canChangeRoles": boolean,
    "canViewAllPhotos": boolean,
    "canUploadPhotos": boolean,
    "canDeletePhotos": boolean,
    "canSharePhotos": boolean,
    "canEditPhotoMetadata": boolean,
    "canViewAnalytics": boolean,
    "canExportData": boolean,
    "canViewReports": boolean,
    "canManageAI": boolean,
    "canRunAIAnalysis": boolean,
    "canViewAIInsights": boolean,
    "canManageTasks": boolean,
    "canAssignTasks": boolean,
    "canViewAllTasks": boolean,
    "canManagePunchList": boolean,
    "canResolvePunchItems": boolean,
    "canViewPunchList": boolean,
    "canManageFinances": boolean,
    "canApproveExpenses": boolean,
    "canViewFinancials": boolean,
    "canUploadDocuments": boolean,
    "canDeleteDocuments": boolean,
    "canShareDocuments": boolean,
    "canManageCompanySettings": boolean,
    "canManageIntegrations": boolean
  }
  */

  -- System Role Flag
  is_active BOOLEAN DEFAULT true,
  is_system_role BOOLEAN DEFAULT false, -- Cannot be edited/deleted if true

  -- Metadata
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  created_by UUID REFERENCES auth.users(id),

  -- Constraints
  UNIQUE(company_id, role_slug),
  CHECK (role_name != ''),
  CHECK (LENGTH(color) = 7 AND color ~ '^#[0-9A-Fa-f]{6}$'), -- Valid hex color
  CHECK (is_system_role = false OR company_id IS NULL) -- System roles have no company
);

-- Indexes for performance
CREATE INDEX idx_custom_roles_company ON custom_roles(company_id) WHERE company_id IS NOT NULL;
CREATE INDEX idx_custom_roles_slug ON custom_roles(company_id, role_slug);
CREATE INDEX idx_custom_roles_active ON custom_roles(company_id, is_active) WHERE is_active = true;

-- ============================================
-- TABLE: user_role_assignments
-- Assigns roles to users (many-to-many)
-- ============================================

CREATE TABLE IF NOT EXISTS user_role_assignments (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  role_id UUID NOT NULL REFERENCES custom_roles(id) ON DELETE CASCADE,
  company_id UUID NOT NULL REFERENCES companies(id) ON DELETE CASCADE,

  -- Optional Scope Limitation
  project_ids UUID[], -- NULL = all projects, array = specific projects only

  -- Temporary Assignments
  expires_at TIMESTAMPTZ, -- NULL = permanent, otherwise auto-expires

  -- Assignment Tracking
  assigned_by UUID REFERENCES auth.users(id),
  assigned_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  assignment_reason TEXT,

  -- Constraints
  UNIQUE(user_id, role_id, company_id),
  CHECK (project_ids IS NULL OR array_length(project_ids, 1) > 0) -- If set, must have at least 1 project
);

-- Indexes
CREATE INDEX idx_user_role_assignments_user ON user_role_assignments(user_id);
CREATE INDEX idx_user_role_assignments_role ON user_role_assignments(role_id);
CREATE INDEX idx_user_role_assignments_company ON user_role_assignments(company_id);
CREATE INDEX idx_user_role_assignments_expires ON user_role_assignments(expires_at)
  WHERE expires_at IS NOT NULL AND expires_at > NOW();

-- ============================================
-- TABLE: project_team_members
-- Project-specific role assignments with overrides
-- ============================================

CREATE TABLE IF NOT EXISTS project_team_members (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  project_id UUID NOT NULL REFERENCES projects(id) ON DELETE CASCADE,
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  company_id UUID NOT NULL REFERENCES companies(id) ON DELETE CASCADE,

  -- Project-Specific Role
  project_role TEXT, -- 'manager', 'superintendent', 'worker', 'observer'

  -- Optional Permission Overrides (overrides global role for this project)
  custom_permissions JSONB DEFAULT NULL, -- NULL = use role permissions

  -- Metadata
  added_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  added_by UUID REFERENCES auth.users(id),

  UNIQUE(project_id, user_id)
);

-- Indexes
CREATE INDEX idx_project_team_members_project ON project_team_members(project_id);
CREATE INDEX idx_project_team_members_user ON project_team_members(user_id);
CREATE INDEX idx_project_team_members_company ON project_team_members(company_id);

-- ============================================
-- TABLE: audit_logs
-- Immutable audit trail for compliance
-- ============================================

CREATE TABLE IF NOT EXISTS audit_logs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  company_id UUID NOT NULL REFERENCES companies(id) ON DELETE CASCADE,

  -- Who (Denormalized for historical record)
  user_id UUID NOT NULL REFERENCES auth.users(id),
  user_name VARCHAR(255) NOT NULL,
  user_email VARCHAR(255) NOT NULL,
  user_role VARCHAR(100), -- Role at time of action

  -- When
  timestamp TIMESTAMPTZ NOT NULL DEFAULT NOW(),

  -- What
  action TEXT NOT NULL, -- 'create', 'update', 'delete', 'view', 'export', 'approve'
  entity_type TEXT NOT NULL, -- 'project', 'task', 'expense', 'quote', 'user', 'role', etc.
  entity_id UUID,
  entity_name TEXT, -- Human-readable identifier

  -- Details
  old_values JSONB, -- State before change
  new_values JSONB, -- State after change
  changes JSONB, -- Computed diff (what actually changed)

  -- Context
  reason TEXT, -- Why was this change made?
  ip_address INET,
  user_agent TEXT,
  session_id UUID,
  request_id UUID, -- For tracing related actions

  -- Classification
  is_critical BOOLEAN DEFAULT false, -- Budget changes, deletions, permission changes
  requires_approval BOOLEAN DEFAULT false,
  approved_by UUID REFERENCES auth.users(id),
  approved_at TIMESTAMPTZ,
  approval_reason TEXT,

  -- Compliance
  retention_period INTERVAL DEFAULT INTERVAL '7 years',
  can_be_deleted BOOLEAN DEFAULT false, -- GDPR right to be forgotten exception

  -- Constraints
  CHECK (action IN ('create', 'update', 'delete', 'view', 'export', 'approve', 'reject')),
  CHECK (entity_type != ''),
  CHECK (requires_approval = false OR (approved_by IS NOT NULL AND approved_at IS NOT NULL) OR approved_by IS NULL)
);

-- Indexes for fast querying
CREATE INDEX idx_audit_logs_company_time ON audit_logs(company_id, timestamp DESC);
CREATE INDEX idx_audit_logs_user_time ON audit_logs(user_id, timestamp DESC);
CREATE INDEX idx_audit_logs_entity ON audit_logs(entity_type, entity_id, timestamp DESC);
CREATE INDEX idx_audit_logs_critical ON audit_logs(company_id, is_critical, timestamp DESC)
  WHERE is_critical = true;
CREATE INDEX idx_audit_logs_pending_approval ON audit_logs(company_id, requires_approval, timestamp DESC)
  WHERE requires_approval = true AND approved_by IS NULL;

-- ============================================
-- TABLE: team_invitations
-- Track pending team member invitations
-- ============================================

CREATE TABLE IF NOT EXISTS team_invitations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  company_id UUID NOT NULL REFERENCES companies(id) ON DELETE CASCADE,

  -- Invitee Info
  email VARCHAR(255) NOT NULL,
  name VARCHAR(255),

  -- Role Assignment
  role_id UUID NOT NULL REFERENCES custom_roles(id) ON DELETE CASCADE,
  project_ids UUID[], -- Assign to specific projects

  -- Invitation Details
  invitation_token VARCHAR(255) NOT NULL UNIQUE,
  invited_by UUID NOT NULL REFERENCES auth.users(id),
  invited_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  expires_at TIMESTAMPTZ NOT NULL DEFAULT (NOW() + INTERVAL '7 days'),

  -- Status
  status VARCHAR(20) NOT NULL DEFAULT 'pending', -- 'pending', 'accepted', 'expired', 'cancelled'
  accepted_at TIMESTAMPTZ,
  accepted_by UUID REFERENCES auth.users(id), -- User ID after signup

  -- Onboarding
  onboarding_completed BOOLEAN DEFAULT false,
  onboarding_buddy UUID REFERENCES auth.users(id),

  UNIQUE(company_id, email, status) -- One pending invitation per email per company
  -- Note: status filter prevents duplicate constraint from blocking re-invites after acceptance
);

-- Indexes
CREATE INDEX idx_team_invitations_company ON team_invitations(company_id);
CREATE INDEX idx_team_invitations_email ON team_invitations(email);
CREATE INDEX idx_team_invitations_token ON team_invitations(invitation_token);
CREATE INDEX idx_team_invitations_status ON team_invitations(company_id, status)
  WHERE status = 'pending';
CREATE INDEX idx_team_invitations_expires ON team_invitations(expires_at)
  WHERE status = 'pending' AND expires_at > NOW();

-- ============================================
-- FUNCTIONS: Permission Checking
-- ============================================

-- Function: Check if user has specific permission
CREATE OR REPLACE FUNCTION user_has_permission(
  p_user_id UUID,
  p_company_id UUID,
  p_permission_name TEXT
)
RETURNS BOOLEAN
LANGUAGE plpgsql
SECURITY DEFINER
STABLE
AS $$
DECLARE
  v_has_permission BOOLEAN;
BEGIN
  -- Check if user has this permission through any of their active, non-expired roles
  SELECT EXISTS(
    SELECT 1
    FROM user_role_assignments ura
    JOIN custom_roles cr ON cr.id = ura.role_id
    WHERE ura.user_id = p_user_id
    AND ura.company_id = p_company_id
    AND cr.is_active = true
    AND (ura.expires_at IS NULL OR ura.expires_at > NOW())
    AND (cr.permissions->>p_permission_name)::boolean = true
  ) INTO v_has_permission;

  RETURN v_has_permission;
END;
$$;

-- Function: Get user's highest role (for display purposes)
CREATE OR REPLACE FUNCTION get_user_highest_role(
  p_user_id UUID,
  p_company_id UUID DEFAULT NULL
)
RETURNS VARCHAR(100)
LANGUAGE plpgsql
SECURITY DEFINER
STABLE
AS $$
DECLARE
  v_role_name VARCHAR(100);
  v_company_id UUID;
BEGIN
  -- If company_id not provided, get user's company
  IF p_company_id IS NULL THEN
    SELECT company_id INTO v_company_id
    FROM user_profiles
    WHERE id = p_user_id
    LIMIT 1;
  ELSE
    v_company_id := p_company_id;
  END IF;

  -- Get highest priority role (using simple hierarchy)
  SELECT cr.role_name INTO v_role_name
  FROM user_role_assignments ura
  JOIN custom_roles cr ON cr.id = ura.role_id
  WHERE ura.user_id = p_user_id
  AND ura.company_id = v_company_id
  AND cr.is_active = true
  AND (ura.expires_at IS NULL OR ura.expires_at > NOW())
  ORDER BY
    CASE cr.role_slug
      WHEN 'admin' THEN 1
      WHEN 'project_manager' THEN 2
      WHEN 'superintendent' THEN 3
      WHEN 'accountant' THEN 4
      WHEN 'field_engineer' THEN 5
      WHEN 'subcontractor' THEN 6
      WHEN 'viewer' THEN 7
      ELSE 8
    END
  LIMIT 1;

  RETURN COALESCE(v_role_name, 'viewer');
END;
$$;

-- Function: Get user's effective permissions (merged from all roles)
CREATE OR REPLACE FUNCTION get_user_permissions(
  p_user_id UUID,
  p_company_id UUID
)
RETURNS JSONB
LANGUAGE plpgsql
SECURITY DEFINER
STABLE
AS $$
DECLARE
  v_permissions JSONB := '{}'::jsonb;
  v_role RECORD;
BEGIN
  -- Merge permissions from all user's active roles (OR logic)
  FOR v_role IN
    SELECT cr.permissions
    FROM user_role_assignments ura
    JOIN custom_roles cr ON cr.id = ura.role_id
    WHERE ura.user_id = p_user_id
    AND ura.company_id = p_company_id
    AND cr.is_active = true
    AND (ura.expires_at IS NULL OR ura.expires_at > NOW())
  LOOP
    -- Merge each permission using OR logic
    SELECT jsonb_object_agg(
      key,
      COALESCE((v_permissions->>key)::boolean, false) OR COALESCE((v_role.permissions->>key)::boolean, false)
    )
    INTO v_permissions
    FROM jsonb_object_keys(v_role.permissions) AS key;
  END LOOP;

  RETURN v_permissions;
END;
$$;

-- Function: Create audit log entry
CREATE OR REPLACE FUNCTION create_audit_log(
  p_user_id UUID,
  p_company_id UUID,
  p_action TEXT,
  p_entity_type TEXT,
  p_entity_id UUID,
  p_entity_name TEXT DEFAULT NULL,
  p_old_values JSONB DEFAULT NULL,
  p_new_values JSONB DEFAULT NULL,
  p_reason TEXT DEFAULT NULL,
  p_ip_address INET DEFAULT NULL,
  p_user_agent TEXT DEFAULT NULL
)
RETURNS UUID
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
  v_log_id UUID;
  v_user_info RECORD;
  v_changes JSONB;
  v_is_critical BOOLEAN := false;
BEGIN
  -- Get user info
  SELECT
    up.name,
    up.email,
    get_user_highest_role(up.id, p_company_id) AS role_name
  INTO v_user_info
  FROM user_profiles up
  WHERE up.id = p_user_id;

  -- Compute diff (changes only)
  IF p_old_values IS NOT NULL AND p_new_values IS NOT NULL THEN
    SELECT jsonb_object_agg(key, value)
    INTO v_changes
    FROM jsonb_each(p_new_values)
    WHERE value != COALESCE(p_old_values->key, 'null'::jsonb);
  END IF;

  -- Determine if action is critical
  v_is_critical := (
    p_action = 'delete'
    OR p_entity_type IN ('role', 'user', 'company_settings')
    OR (p_entity_type = 'project' AND p_action = 'update' AND p_changes ? 'estimated_budget')
    OR (p_entity_type = 'expense' AND (p_new_values->>'amount')::numeric > 5000)
  );

  -- Insert audit log
  INSERT INTO audit_logs (
    company_id,
    user_id,
    user_name,
    user_email,
    user_role,
    action,
    entity_type,
    entity_id,
    entity_name,
    old_values,
    new_values,
    changes,
    reason,
    ip_address,
    user_agent,
    is_critical
  )
  VALUES (
    p_company_id,
    p_user_id,
    COALESCE(v_user_info.name, 'Unknown'),
    COALESCE(v_user_info.email, 'unknown@example.com'),
    v_user_info.role_name,
    p_action,
    p_entity_type,
    p_entity_id,
    p_entity_name,
    p_old_values,
    p_new_values,
    v_changes,
    p_reason,
    p_ip_address,
    p_user_agent,
    v_is_critical
  )
  RETURNING id INTO v_log_id;

  RETURN v_log_id;
END;
$$;

-- Function: Get role member count
CREATE OR REPLACE FUNCTION get_role_member_count(
  p_role_id UUID
)
RETURNS INTEGER
LANGUAGE sql
SECURITY DEFINER
STABLE
AS $$
  SELECT COUNT(*)::integer
  FROM user_role_assignments
  WHERE role_id = p_role_id
  AND (expires_at IS NULL OR expires_at > NOW());
$$;

-- ============================================
-- TRIGGERS
-- ============================================

-- Trigger: Update updated_at timestamp
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER
LANGUAGE plpgsql
AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$;

CREATE TRIGGER update_custom_roles_updated_at
  BEFORE UPDATE ON custom_roles
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at_column();

-- Trigger: Auto-expire team invitations
CREATE OR REPLACE FUNCTION auto_expire_invitations()
RETURNS TRIGGER
LANGUAGE plpgsql
AS $$
BEGIN
  -- Update expired pending invitations
  UPDATE team_invitations
  SET status = 'expired'
  WHERE status = 'pending'
  AND expires_at < NOW();

  RETURN NULL;
END;
$$;

-- Run every hour to clean up expired invitations
-- Note: This trigger fires on INSERT to team_invitations as a convenient hook
-- In production, use pg_cron or external scheduler
CREATE TRIGGER trigger_auto_expire_invitations
  AFTER INSERT ON team_invitations
  FOR EACH STATEMENT
  EXECUTE FUNCTION auto_expire_invitations();

-- ============================================
-- ROW LEVEL SECURITY (RLS) POLICIES
-- ============================================

-- Enable RLS on all tables
ALTER TABLE custom_roles ENABLE ROW LEVEL SECURITY;
ALTER TABLE user_role_assignments ENABLE ROW LEVEL SECURITY;
ALTER TABLE project_team_members ENABLE ROW LEVEL SECURITY;
ALTER TABLE audit_logs ENABLE ROW LEVEL SECURITY;
ALTER TABLE team_invitations ENABLE ROW LEVEL SECURITY;

-- Policy: Users can view roles in their company
CREATE POLICY "Users can view company roles"
  ON custom_roles FOR SELECT
  TO authenticated
  USING (
    company_id IN (
      SELECT company_id FROM user_profiles WHERE id = auth.uid()
    )
    OR is_system_role = true -- Everyone can see system roles
    OR company_id IS NULL -- System roles have no company
  );

-- Policy: Only admins can create/edit/delete custom roles
CREATE POLICY "Admins can manage custom roles"
  ON custom_roles FOR ALL
  TO authenticated
  USING (
    user_has_permission(auth.uid(), company_id, 'canManageTeam') = true
  );

-- Policy: Users can view role assignments in their company
CREATE POLICY "Users can view role assignments"
  ON user_role_assignments FOR SELECT
  TO authenticated
  USING (
    company_id IN (
      SELECT company_id FROM user_profiles WHERE id = auth.uid()
    )
  );

-- Policy: Only admins can manage role assignments
CREATE POLICY "Admins can manage role assignments"
  ON user_role_assignments FOR ALL
  TO authenticated
  USING (
    user_has_permission(auth.uid(), company_id, 'canChangeRoles') = true
  );

-- Policy: Users can view project team members for accessible projects
CREATE POLICY "Users can view project team members"
  ON project_team_members FOR SELECT
  TO authenticated
  USING (
    project_id IN (
      SELECT id FROM projects WHERE
        company_id IN (SELECT company_id FROM user_profiles WHERE id = auth.uid())
        AND (
          user_has_permission(auth.uid(), company_id, 'canViewAllProjects') = true
          OR id IN (SELECT project_id FROM project_team_members WHERE user_id = auth.uid())
        )
    )
  );

-- Policy: Project managers can add/remove team members
CREATE POLICY "Project managers can manage team members"
  ON project_team_members FOR ALL
  TO authenticated
  USING (
    user_has_permission(auth.uid(), company_id, 'canManageTeam') = true
    OR project_id IN (
      SELECT project_id FROM project_team_members
      WHERE user_id = auth.uid()
      AND project_role = 'manager'
    )
  );

-- Policy: Users can view audit logs for their company (admins see all, others see own)
CREATE POLICY "Users can view company audit logs"
  ON audit_logs FOR SELECT
  TO authenticated
  USING (
    company_id IN (
      SELECT company_id FROM user_profiles WHERE id = auth.uid()
    )
    AND (
      user_has_permission(auth.uid(), company_id, 'canViewReports') = true
      OR user_id = auth.uid() -- Can always see own actions
    )
  );

-- Policy: Audit logs are immutable (cannot be updated)
CREATE POLICY "Audit logs are immutable"
  ON audit_logs FOR UPDATE
  TO authenticated
  USING (false);

-- Policy: Audit logs cannot be deleted (except GDPR compliance)
CREATE POLICY "Audit logs cannot be deleted"
  ON audit_logs FOR DELETE
  TO authenticated
  USING (
    can_be_deleted = true
    AND user_has_permission(auth.uid(), company_id, 'canManageCompanySettings') = true
  );

-- Policy: Users can view invitations for their company
CREATE POLICY "Users can view team invitations"
  ON team_invitations FOR SELECT
  TO authenticated
  USING (
    company_id IN (
      SELECT company_id FROM user_profiles WHERE id = auth.uid()
    )
  );

-- Policy: Only admins can manage invitations
CREATE POLICY "Admins can manage invitations"
  ON team_invitations FOR ALL
  TO authenticated
  USING (
    user_has_permission(auth.uid(), company_id, 'canInviteMembers') = true
  );

-- ============================================
-- SEED DATA: System Roles
-- ============================================

-- Insert 7 construction-specific system roles
INSERT INTO custom_roles (role_name, role_slug, description, color, icon, is_system_role, permissions) VALUES

-- 1. Admin (Owner)
('Admin', 'admin', 'Full system access - company owner', '#7C3AED', '', true, '{
  "canViewAllProjects": true,
  "canEditProjects": true,
  "canDeleteProjects": true,
  "canCreateProjects": true,
  "canManageTeam": true,
  "canInviteMembers": true,
  "canRemoveMembers": true,
  "canChangeRoles": true,
  "canViewAllPhotos": true,
  "canUploadPhotos": true,
  "canDeletePhotos": true,
  "canSharePhotos": true,
  "canEditPhotoMetadata": true,
  "canViewAnalytics": true,
  "canExportData": true,
  "canViewReports": true,
  "canManageAI": true,
  "canRunAIAnalysis": true,
  "canViewAIInsights": true,
  "canManageTasks": true,
  "canAssignTasks": true,
  "canViewAllTasks": true,
  "canManagePunchList": true,
  "canResolvePunchItems": true,
  "canViewPunchList": true,
  "canManageFinances": true,
  "canApproveExpenses": true,
  "canViewFinancials": true,
  "canUploadDocuments": true,
  "canDeleteDocuments": true,
  "canShareDocuments": true,
  "canManageCompanySettings": true,
  "canManageIntegrations": true
}'::jsonb),

-- 2. Superintendent
('Superintendent', 'superintendent', 'Oversee field operations and crews', '#1E40AF', '', true, '{
  "canViewAllProjects": false,
  "canEditProjects": false,
  "canDeleteProjects": false,
  "canCreateProjects": false,
  "canManageTeam": false,
  "canInviteMembers": false,
  "canRemoveMembers": false,
  "canChangeRoles": false,
  "canViewAllPhotos": true,
  "canUploadPhotos": true,
  "canDeletePhotos": false,
  "canSharePhotos": true,
  "canEditPhotoMetadata": true,
  "canViewAnalytics": false,
  "canExportData": false,
  "canViewReports": false,
  "canManageAI": false,
  "canRunAIAnalysis": false,
  "canViewAIInsights": false,
  "canManageTasks": true,
  "canAssignTasks": true,
  "canViewAllTasks": true,
  "canManagePunchList": true,
  "canResolvePunchItems": true,
  "canViewPunchList": true,
  "canManageFinances": false,
  "canApproveExpenses": false,
  "canViewFinancials": false,
  "canUploadDocuments": true,
  "canDeleteDocuments": false,
  "canShareDocuments": false,
  "canManageCompanySettings": false,
  "canManageIntegrations": false
}'::jsonb),

-- 3. Project Manager
('Project Manager', 'project_manager', 'Manage projects and budgets', '#047857', '', true, '{
  "canViewAllProjects": true,
  "canEditProjects": true,
  "canDeleteProjects": false,
  "canCreateProjects": true,
  "canManageTeam": false,
  "canInviteMembers": false,
  "canRemoveMembers": false,
  "canChangeRoles": false,
  "canViewAllPhotos": true,
  "canUploadPhotos": true,
  "canDeletePhotos": true,
  "canSharePhotos": true,
  "canEditPhotoMetadata": true,
  "canViewAnalytics": true,
  "canExportData": true,
  "canViewReports": true,
  "canManageAI": true,
  "canRunAIAnalysis": true,
  "canViewAIInsights": true,
  "canManageTasks": true,
  "canAssignTasks": true,
  "canViewAllTasks": true,
  "canManagePunchList": true,
  "canResolvePunchItems": true,
  "canViewPunchList": true,
  "canManageFinances": true,
  "canApproveExpenses": true,
  "canViewFinancials": true,
  "canUploadDocuments": true,
  "canDeleteDocuments": true,
  "canShareDocuments": true,
  "canManageCompanySettings": false,
  "canManageIntegrations": false
}'::jsonb),

-- 4. Field Engineer
('Field Engineer', 'field_engineer', 'Technical field work and coordination', '#C2410C', '', true, '{
  "canViewAllProjects": false,
  "canEditProjects": false,
  "canDeleteProjects": false,
  "canCreateProjects": false,
  "canManageTeam": false,
  "canInviteMembers": false,
  "canRemoveMembers": false,
  "canChangeRoles": false,
  "canViewAllPhotos": false,
  "canUploadPhotos": true,
  "canDeletePhotos": false,
  "canSharePhotos": false,
  "canEditPhotoMetadata": false,
  "canViewAnalytics": false,
  "canExportData": false,
  "canViewReports": false,
  "canManageAI": false,
  "canRunAIAnalysis": false,
  "canViewAIInsights": false,
  "canManageTasks": false,
  "canAssignTasks": false,
  "canViewAllTasks": false,
  "canManagePunchList": true,
  "canResolvePunchItems": false,
  "canViewPunchList": true,
  "canManageFinances": false,
  "canApproveExpenses": false,
  "canViewFinancials": false,
  "canUploadDocuments": true,
  "canDeleteDocuments": false,
  "canShareDocuments": false,
  "canManageCompanySettings": false,
  "canManageIntegrations": false
}'::jsonb),

-- 5. Viewer (Client)
('Viewer', 'viewer', 'View-only access for clients', '#4B5563', '', true, '{
  "canViewAllProjects": false,
  "canEditProjects": false,
  "canDeleteProjects": false,
  "canCreateProjects": false,
  "canManageTeam": false,
  "canInviteMembers": false,
  "canRemoveMembers": false,
  "canChangeRoles": false,
  "canViewAllPhotos": false,
  "canUploadPhotos": false,
  "canDeletePhotos": false,
  "canSharePhotos": false,
  "canEditPhotoMetadata": false,
  "canViewAnalytics": false,
  "canExportData": false,
  "canViewReports": false,
  "canManageAI": false,
  "canRunAIAnalysis": false,
  "canViewAIInsights": false,
  "canManageTasks": false,
  "canAssignTasks": false,
  "canViewAllTasks": false,
  "canManagePunchList": false,
  "canResolvePunchItems": false,
  "canViewPunchList": false,
  "canManageFinances": false,
  "canApproveExpenses": false,
  "canViewFinancials": false,
  "canUploadDocuments": false,
  "canDeleteDocuments": false,
  "canShareDocuments": false,
  "canManageCompanySettings": false,
  "canManageIntegrations": false
}'::jsonb),

-- 6. Accountant
('Accountant', 'accountant', 'Financial management and reporting', '#B45309', '', true, '{
  "canViewAllProjects": true,
  "canEditProjects": false,
  "canDeleteProjects": false,
  "canCreateProjects": false,
  "canManageTeam": false,
  "canInviteMembers": false,
  "canRemoveMembers": false,
  "canChangeRoles": false,
  "canViewAllPhotos": false,
  "canUploadPhotos": false,
  "canDeletePhotos": false,
  "canSharePhotos": false,
  "canEditPhotoMetadata": false,
  "canViewAnalytics": true,
  "canExportData": true,
  "canViewReports": true,
  "canManageAI": false,
  "canRunAIAnalysis": false,
  "canViewAIInsights": false,
  "canManageTasks": false,
  "canAssignTasks": false,
  "canViewAllTasks": false,
  "canManagePunchList": false,
  "canResolvePunchItems": false,
  "canViewPunchList": false,
  "canManageFinances": true,
  "canApproveExpenses": true,
  "canViewFinancials": true,
  "canUploadDocuments": true,
  "canDeleteDocuments": false,
  "canShareDocuments": true,
  "canManageCompanySettings": false,
  "canManageIntegrations": false
}'::jsonb),

-- 7. Subcontractor
('Subcontractor', 'subcontractor', 'External contractor - limited access', '#4338CA', '', true, '{
  "canViewAllProjects": false,
  "canEditProjects": false,
  "canDeleteProjects": false,
  "canCreateProjects": false,
  "canManageTeam": false,
  "canInviteMembers": false,
  "canRemoveMembers": false,
  "canChangeRoles": false,
  "canViewAllPhotos": false,
  "canUploadPhotos": true,
  "canDeletePhotos": false,
  "canSharePhotos": false,
  "canEditPhotoMetadata": false,
  "canViewAnalytics": false,
  "canExportData": false,
  "canViewReports": false,
  "canManageAI": false,
  "canRunAIAnalysis": false,
  "canViewAIInsights": false,
  "canManageTasks": false,
  "canAssignTasks": false,
  "canViewAllTasks": false,
  "canManagePunchList": true,
  "canResolvePunchItems": false,
  "canViewPunchList": true,
  "canManageFinances": false,
  "canApproveExpenses": false,
  "canViewFinancials": false,
  "canUploadDocuments": true,
  "canDeleteDocuments": false,
  "canShareDocuments": false,
  "canManageCompanySettings": false,
  "canManageIntegrations": false
}'::jsonb)

ON CONFLICT DO NOTHING;

-- ============================================
-- COMMENTS (Documentation)
-- ============================================

COMMENT ON TABLE custom_roles IS 'Stores both system roles and company-custom roles with granular permissions';
COMMENT ON TABLE user_role_assignments IS 'Assigns roles to users with optional project scope and expiration';
COMMENT ON TABLE project_team_members IS 'Project-specific role assignments with permission overrides';
COMMENT ON TABLE audit_logs IS 'Immutable audit trail for compliance and security';
COMMENT ON TABLE team_invitations IS 'Pending team member invitations with onboarding tracking';

COMMENT ON FUNCTION user_has_permission IS 'Check if user has a specific permission through their roles';
COMMENT ON FUNCTION get_user_highest_role IS 'Get user''s highest priority role for display';
COMMENT ON FUNCTION get_user_permissions IS 'Get user''s effective permissions merged from all roles';
COMMENT ON FUNCTION create_audit_log IS 'Create audit log entry with automatic criticality detection';
COMMENT ON FUNCTION get_role_member_count IS 'Count active members assigned to a role';

COMMIT;

-- ============================================
-- END OF MODULE 10 MIGRATION
-- ============================================
-- Next steps:
-- 1. Run this migration: psql -f 20260209_module10_teams_rbac.sql
-- 2. Test permission functions
-- 3. Implement API routes
-- 4. Build frontend components
-- ============================================


#20

==========================================================================
-- SIERRA SUITES - MASTER DATABASE SCHEMA
-- Complete Construction Management Platform
-- ============================================================================
-- Created: January 21, 2026
-- Purpose: Single source of truth for all database tables
-- Note: RLS policies will be added in Week 6 (security lockdown phase)
-- ============================================================================

-- ============================================================================
-- 1. ENABLE EXTENSIONS
-- ============================================================================

CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
CREATE EXTENSION IF NOT EXISTS "pgcrypto";

-- ============================================================================
-- 2. CORE TABLES
-- ============================================================================

-- ----------------------------------------------------------------------------
-- 2.1 Companies Table (Multi-tenant isolation)
-- ----------------------------------------------------------------------------
CREATE TABLE IF NOT EXISTS public.companies (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name TEXT NOT NULL,
  industry TEXT,
  size TEXT CHECK (size IN ('solo', 'small', 'medium', 'large')),
  website TEXT,
  address JSONB,
  phone TEXT,
  email TEXT,
  logo_url TEXT,
  subscription_tier TEXT CHECK (subscription_tier IN ('starter', 'professional', 'enterprise')) DEFAULT 'starter',
  subscription_status TEXT CHECK (subscription_status IN ('trial', 'active', 'past_due', 'canceled')) DEFAULT 'trial',
  trial_ends_at TIMESTAMPTZ,
  stripe_customer_id TEXT UNIQUE,
  stripe_subscription_id TEXT,
  settings JSONB DEFAULT '{}'::jsonb,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_companies_subscription ON public.companies(subscription_tier, subscription_status);
CREATE INDEX idx_companies_stripe ON public.companies(stripe_customer_id);

-- ----------------------------------------------------------------------------
-- 2.2 User Profiles Table (Extends auth.users)
-- ----------------------------------------------------------------------------
CREATE TABLE IF NOT EXISTS public.user_profiles (
  id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
  company_id UUID REFERENCES public.companies(id) ON DELETE CASCADE,
  email TEXT UNIQUE NOT NULL,
  full_name TEXT,
  avatar_url TEXT,
  phone TEXT,
  role TEXT CHECK (role IN ('owner', 'admin', 'project_manager', 'member', 'viewer')) DEFAULT 'member',

  -- Subscription (for backward compatibility with old schema)
  subscription_tier TEXT CHECK (subscription_tier IN ('starter', 'professional', 'enterprise')) DEFAULT 'starter',
  stripe_customer_id TEXT,

  -- Settings
  timezone TEXT DEFAULT 'America/New_York',
  language TEXT DEFAULT 'en',
  notification_preferences JSONB DEFAULT '{"email": true, "push": true, "sms": false}'::jsonb,

  -- Status
  is_active BOOLEAN DEFAULT true,
  last_seen_at TIMESTAMPTZ,

  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_user_profiles_company ON public.user_profiles(company_id);
CREATE INDEX idx_user_profiles_email ON public.user_profiles(email);
CREATE INDEX idx_user_profiles_role ON public.user_profiles(role);

-- ============================================================================
-- 3. PROJECT MANAGEMENT
-- ============================================================================

-- ----------------------------------------------------------------------------
-- 3.1 Projects Table
-- ----------------------------------------------------------------------------
CREATE TABLE IF NOT EXISTS public.projects (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  company_id UUID REFERENCES public.companies(id) ON DELETE CASCADE NOT NULL,
  created_by UUID REFERENCES auth.users(id) ON DELETE SET NULL,

  -- Basic Information
  name TEXT NOT NULL,
  description TEXT,
  project_number TEXT,

  -- Client Information
  client_name TEXT,
  client_email TEXT,
  client_phone TEXT,
  client_company TEXT,

  -- Location
  address TEXT,
  city TEXT,
  state TEXT,
  zip_code TEXT,
  country TEXT DEFAULT 'United States',
  gps_coordinates POINT,

  -- Project Type
  project_type TEXT CHECK (project_type IN ('residential', 'commercial', 'industrial', 'infrastructure', 'renovation', 'new_construction')),
  building_type TEXT,
  square_footage INTEGER,

  -- Status & Progress
  status TEXT CHECK (status IN ('planning', 'active', 'on-hold', 'completed', 'archived', 'canceled')) DEFAULT 'planning',
  progress INTEGER DEFAULT 0 CHECK (progress >= 0 AND progress <= 100),

  -- Timeline
  start_date DATE,
  due_date DATE,
  completion_date DATE,
  estimated_duration_days INTEGER,

  -- Budget & Financials
  budget DECIMAL(12,2),
  spent DECIMAL(12,2) DEFAULT 0,
  currency TEXT DEFAULT 'USD',

  -- Team
  project_manager_id UUID REFERENCES auth.users(id),

  -- Settings
  tags TEXT[] DEFAULT '{}',
  custom_fields JSONB DEFAULT '{}'::jsonb,
  notes TEXT,

  -- Metadata
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_projects_company ON public.projects(company_id);
CREATE INDEX idx_projects_status ON public.projects(status);
CREATE INDEX idx_projects_created_by ON public.projects(created_by);
CREATE INDEX idx_projects_manager ON public.projects(project_manager_id);
CREATE INDEX idx_projects_due_date ON public.projects(due_date);

-- ----------------------------------------------------------------------------
-- 3.2 Project Expenses Table
-- ----------------------------------------------------------------------------
CREATE TABLE IF NOT EXISTS public.project_expenses (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  project_id UUID REFERENCES public.projects(id) ON DELETE CASCADE NOT NULL,
  company_id UUID REFERENCES public.companies(id) ON DELETE CASCADE NOT NULL,
  created_by UUID REFERENCES auth.users(id),

  -- Expense Details
  description TEXT NOT NULL,
  category TEXT CHECK (category IN ('materials', 'labor', 'equipment', 'permits', 'subcontractor', 'overhead', 'other')),
  amount DECIMAL(10,2) NOT NULL,
  currency TEXT DEFAULT 'USD',

  -- Documentation
  receipt_url TEXT,
  invoice_number TEXT,
  vendor TEXT,

  -- Tracking
  date DATE NOT NULL,
  paid BOOLEAN DEFAULT false,
  payment_method TEXT,

  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_project_expenses_project ON public.project_expenses(project_id);
CREATE INDEX idx_project_expenses_company ON public.project_expenses(company_id);
CREATE INDEX idx_project_expenses_date ON public.project_expenses(date DESC);
CREATE INDEX idx_project_expenses_category ON public.project_expenses(category);

-- ============================================================================
-- 4. TASKFLOW (Task Management)
-- ============================================================================

-- ----------------------------------------------------------------------------
-- 4.1 Tasks Table
-- ----------------------------------------------------------------------------
CREATE TABLE IF NOT EXISTS public.tasks (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  project_id UUID REFERENCES public.projects(id) ON DELETE CASCADE,
  company_id UUID REFERENCES public.companies(id) ON DELETE CASCADE NOT NULL,
  created_by UUID REFERENCES auth.users(id),

  -- Basic Information
  title TEXT NOT NULL,
  description TEXT,

  -- Construction Categorization
  phase TEXT CHECK (phase IN ('preconstruction', 'foundation', 'framing', 'mep', 'finishes', 'closeout', 'warranty')),
  trade TEXT CHECK (trade IN ('general', 'concrete', 'electrical', 'plumbing', 'hvac', 'carpentry', 'masonry', 'roofing', 'other')),
  location TEXT,
  zone TEXT,
  floor_level TEXT,

  -- Status & Priority
  status TEXT CHECK (status IN ('todo', 'in-progress', 'blocked', 'under-review', 'completed')) DEFAULT 'todo',
  priority TEXT CHECK (priority IN ('low', 'medium', 'high', 'urgent')) DEFAULT 'medium',
  progress INTEGER DEFAULT 0 CHECK (progress >= 0 AND progress <= 100),

  -- Assignment
  assigned_to UUID REFERENCES auth.users(id),
  assigned_team UUID[],

  -- Time Tracking
  start_date DATE,
  due_date DATE,
  estimated_hours DECIMAL(5,2),
  actual_hours DECIMAL(5,2),

  -- Dependencies
  dependencies UUID[],
  blocks UUID[],

  -- Completion
  completed_at TIMESTAMPTZ,
  completed_by UUID REFERENCES auth.users(id),

  -- Metadata
  tags TEXT[] DEFAULT '{}',
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_tasks_company ON public.tasks(company_id);
CREATE INDEX idx_tasks_project ON public.tasks(project_id);
CREATE INDEX idx_tasks_status ON public.tasks(status);
CREATE INDEX idx_tasks_assigned_to ON public.tasks(assigned_to);
CREATE INDEX idx_tasks_due_date ON public.tasks(due_date);
CREATE INDEX idx_tasks_priority ON public.tasks(priority);

-- ----------------------------------------------------------------------------
-- 4.2 Task Comments Table
-- ----------------------------------------------------------------------------
CREATE TABLE IF NOT EXISTS public.task_comments (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  task_id UUID REFERENCES public.tasks(id) ON DELETE CASCADE NOT NULL,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
  content TEXT NOT NULL,
  mentions UUID[],
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_task_comments_task ON public.task_comments(task_id);
CREATE INDEX idx_task_comments_user ON public.task_comments(user_id);

-- ============================================================================
-- 5. FIELDSNAP (Photo/Media Management)
-- ============================================================================

-- ----------------------------------------------------------------------------
-- 5.1 Media Assets Table
-- ----------------------------------------------------------------------------
CREATE TABLE IF NOT EXISTS public.media_assets (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  company_id UUID REFERENCES public.companies(id) ON DELETE CASCADE NOT NULL,
  project_id UUID REFERENCES public.projects(id) ON DELETE CASCADE,
  task_id UUID REFERENCES public.tasks(id) ON DELETE SET NULL,
  uploaded_by UUID REFERENCES auth.users(id),

  -- File Information
  url TEXT NOT NULL,
  thumbnail_url TEXT,
  filename TEXT NOT NULL,
  file_size BIGINT NOT NULL,
  mime_type TEXT NOT NULL,
  width INTEGER,
  height INTEGER,

  -- Metadata
  caption TEXT,
  description TEXT,
  tags TEXT[] DEFAULT '{}',

  -- Location
  gps_latitude DECIMAL(10,8),
  gps_longitude DECIMAL(11,8),
  location_name TEXT,

  -- Timestamps
  captured_at TIMESTAMPTZ,
  uploaded_at TIMESTAMPTZ DEFAULT NOW(),

  -- Status
  status TEXT CHECK (status IN ('pending', 'approved', 'rejected')) DEFAULT 'pending',

  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_media_assets_company ON public.media_assets(company_id);
CREATE INDEX idx_media_assets_project ON public.media_assets(project_id);
CREATE INDEX idx_media_assets_uploaded_by ON public.media_assets(uploaded_by);
CREATE INDEX idx_media_assets_captured_at ON public.media_assets(captured_at DESC);

-- ----------------------------------------------------------------------------
-- 5.2 Photo Annotations Table
-- ----------------------------------------------------------------------------
CREATE TABLE IF NOT EXISTS public.photo_annotations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  media_asset_id UUID REFERENCES public.media_assets(id) ON DELETE CASCADE NOT NULL,
  user_id UUID REFERENCES auth.users(id),
  annotation_type TEXT CHECK (annotation_type IN ('point', 'rectangle', 'circle', 'polygon', 'arrow', 'text')),
  coordinates JSONB NOT NULL,
  content TEXT,
  category TEXT CHECK (category IN ('defect', 'safety', 'progress', 'note', 'issue')),
  severity TEXT CHECK (severity IN ('low', 'medium', 'high', 'critical')),
  resolved BOOLEAN DEFAULT false,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_photo_annotations_media ON public.photo_annotations(media_asset_id);

-- ============================================================================
-- 6. QUOTEHUB (Quote/Proposal Management)
-- ============================================================================

-- ----------------------------------------------------------------------------
-- 6.1 Quotes Table
-- ----------------------------------------------------------------------------
CREATE TABLE IF NOT EXISTS public.quotes (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  company_id UUID REFERENCES public.companies(id) ON DELETE CASCADE NOT NULL,
  project_id UUID REFERENCES public.projects(id) ON DELETE SET NULL,
  created_by UUID REFERENCES auth.users(id),

  -- Quote Details
  quote_number TEXT UNIQUE NOT NULL,
  title TEXT NOT NULL,
  description TEXT,

  -- Client Information
  client_name TEXT NOT NULL,
  client_email TEXT,
  client_phone TEXT,
  client_company TEXT,
  client_address JSONB,

  -- Status
  status TEXT CHECK (status IN ('draft', 'sent', 'viewed', 'accepted', 'rejected', 'expired')) DEFAULT 'draft',

  -- Pricing
  subtotal DECIMAL(12,2) DEFAULT 0,
  tax_rate DECIMAL(5,2) DEFAULT 0,
  tax_amount DECIMAL(12,2) DEFAULT 0,
  discount_amount DECIMAL(12,2) DEFAULT 0,
  total DECIMAL(12,2) DEFAULT 0,
  currency TEXT DEFAULT 'USD',

  -- Terms
  payment_terms TEXT,
  valid_until DATE,
  notes TEXT,
  terms_and_conditions TEXT,

  -- Tracking
  sent_at TIMESTAMPTZ,
  viewed_at TIMESTAMPTZ,
  accepted_at TIMESTAMPTZ,
  rejected_at TIMESTAMPTZ,

  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_quotes_company ON public.quotes(company_id);
CREATE INDEX idx_quotes_project ON public.quotes(project_id);
CREATE INDEX idx_quotes_status ON public.quotes(status);
CREATE INDEX idx_quotes_number ON public.quotes(quote_number);

-- ----------------------------------------------------------------------------
-- 6.2 Quote Line Items Table
-- ----------------------------------------------------------------------------
CREATE TABLE IF NOT EXISTS public.quote_line_items (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  quote_id UUID REFERENCES public.quotes(id) ON DELETE CASCADE NOT NULL,

  -- Item Details
  description TEXT NOT NULL,
  item_type TEXT CHECK (item_type IN ('labor', 'material', 'equipment', 'subcontractor', 'other')) DEFAULT 'other',
  category TEXT,

  -- Pricing
  quantity DECIMAL(10,2) DEFAULT 1,
  unit TEXT DEFAULT 'unit',
  unit_price DECIMAL(10,2) NOT NULL,
  total DECIMAL(10,2) GENERATED ALWAYS AS (quantity * unit_price) STORED,

  -- Order
  sort_order INTEGER DEFAULT 0,

  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_quote_line_items_quote ON public.quote_line_items(quote_id);

-- ============================================================================
-- 7. CRM (Customer Relationship Management)
-- ============================================================================

-- ----------------------------------------------------------------------------
-- 7.1 CRM Contacts Table
-- ----------------------------------------------------------------------------
CREATE TABLE IF NOT EXISTS public.crm_contacts (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  company_id UUID REFERENCES public.companies(id) ON DELETE CASCADE NOT NULL,
  created_by UUID REFERENCES auth.users(id),

  -- Contact Information
  first_name TEXT NOT NULL,
  last_name TEXT NOT NULL,
  full_name TEXT GENERATED ALWAYS AS (first_name || ' ' || last_name) STORED,
  email TEXT,
  phone TEXT,
  mobile TEXT,

  -- Company Information
  company TEXT,
  job_title TEXT,
  website TEXT,

  -- Address
  street_address TEXT,
  city TEXT,
  state TEXT,
  zip_code TEXT,
  country TEXT DEFAULT 'United States',

  -- Classification
  type TEXT CHECK (type IN ('lead', 'prospect', 'client', 'vendor', 'subcontractor')) DEFAULT 'lead',
  status TEXT CHECK (status IN ('active', 'inactive', 'do_not_contact')) DEFAULT 'active',
  lead_source TEXT,
  tags TEXT[] DEFAULT '{}',

  -- Metadata
  notes TEXT,
  custom_fields JSONB DEFAULT '{}'::jsonb,

  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_crm_contacts_company ON public.crm_contacts(company_id);
CREATE INDEX idx_crm_contacts_type ON public.crm_contacts(type);
CREATE INDEX idx_crm_contacts_email ON public.crm_contacts(email);

-- ----------------------------------------------------------------------------
-- 7.2 CRM Deals Table
-- ----------------------------------------------------------------------------
CREATE TABLE IF NOT EXISTS public.crm_deals (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  company_id UUID REFERENCES public.companies(id) ON DELETE CASCADE NOT NULL,
  contact_id UUID REFERENCES public.crm_contacts(id) ON DELETE CASCADE,
  created_by UUID REFERENCES auth.users(id),

  -- Deal Information
  title TEXT NOT NULL,
  description TEXT,

  -- Pipeline
  stage TEXT CHECK (stage IN ('lead', 'contacted', 'qualified', 'proposal', 'negotiation', 'won', 'lost')) DEFAULT 'lead',

  -- Value
  estimated_value DECIMAL(12,2),
  probability INTEGER CHECK (probability BETWEEN 0 AND 100) DEFAULT 50,

  -- Dates
  expected_close_date DATE,
  actual_close_date DATE,

  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_crm_deals_company ON public.crm_deals(company_id);
CREATE INDEX idx_crm_deals_contact ON public.crm_deals(contact_id);
CREATE INDEX idx_crm_deals_stage ON public.crm_deals(stage);

-- ============================================================================
-- 8. TEAMS & RBAC
-- ============================================================================

-- ----------------------------------------------------------------------------
-- 8.1 Teams Table
-- ----------------------------------------------------------------------------
CREATE TABLE IF NOT EXISTS public.teams (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  company_id UUID REFERENCES public.companies(id) ON DELETE CASCADE NOT NULL,
  name TEXT NOT NULL,
  description TEXT,
  created_by UUID REFERENCES auth.users(id),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_teams_company ON public.teams(company_id);

-- ----------------------------------------------------------------------------
-- 8.2 Team Members Table
-- ----------------------------------------------------------------------------
CREATE TABLE IF NOT EXISTS public.team_members (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  team_id UUID REFERENCES public.teams(id) ON DELETE CASCADE NOT NULL,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
  role TEXT CHECK (role IN ('lead', 'member')) DEFAULT 'member',
  added_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(team_id, user_id)
);

CREATE INDEX idx_team_members_team ON public.team_members(team_id);
CREATE INDEX idx_team_members_user ON public.team_members(user_id);

-- ----------------------------------------------------------------------------
-- 8.3 Team Invitations Table
-- ----------------------------------------------------------------------------
CREATE TABLE IF NOT EXISTS public.team_invitations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  company_id UUID REFERENCES public.companies(id) ON DELETE CASCADE NOT NULL,
  email TEXT NOT NULL,
  role TEXT CHECK (role IN ('owner', 'admin', 'project_manager', 'member', 'viewer')) DEFAULT 'member',
  invited_by UUID REFERENCES auth.users(id),
  invitation_token TEXT UNIQUE NOT NULL,
  expires_at TIMESTAMPTZ NOT NULL,
  accepted_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_team_invitations_company ON public.team_invitations(company_id);
CREATE INDEX idx_team_invitations_email ON public.team_invitations(email);
CREATE INDEX idx_team_invitations_token ON public.team_invitations(invitation_token);

-- ============================================================================
-- 9. PUNCH LISTS
-- ============================================================================

-- ----------------------------------------------------------------------------
-- 9.1 Punch List Items Table
-- ----------------------------------------------------------------------------
CREATE TABLE IF NOT EXISTS public.punch_list_items (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  project_id UUID REFERENCES public.projects(id) ON DELETE CASCADE NOT NULL,
  company_id UUID REFERENCES public.companies(id) ON DELETE CASCADE NOT NULL,
  created_by UUID REFERENCES auth.users(id),

  -- Item Details
  title TEXT NOT NULL,
  description TEXT,
  location TEXT,
  trade TEXT,

  -- Status
  status TEXT CHECK (status IN ('open', 'in-progress', 'completed', 'verified', 'closed')) DEFAULT 'open',
  priority TEXT CHECK (priority IN ('low', 'medium', 'high', 'critical')) DEFAULT 'medium',

  -- Assignment
  assigned_to UUID REFERENCES auth.users(id),

  -- Dates
  due_date DATE,
  completed_at TIMESTAMPTZ,

  -- Media
  photo_id UUID REFERENCES public.media_assets(id),

  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_punch_list_items_project ON public.punch_list_items(project_id);
CREATE INDEX idx_punch_list_items_company ON public.punch_list_items(company_id);
CREATE INDEX idx_punch_list_items_status ON public.punch_list_items(status);
CREATE INDEX idx_punch_list_items_assigned_to ON public.punch_list_items(assigned_to);

-- ============================================================================
-- 10. SUSTAINABILITY HUB
-- ============================================================================

-- ----------------------------------------------------------------------------
-- 10.1 Sustainability Metrics Table
-- ----------------------------------------------------------------------------
CREATE TABLE IF NOT EXISTS public.sustainability_metrics (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  project_id UUID REFERENCES public.projects(id) ON DELETE CASCADE NOT NULL,
  company_id UUID REFERENCES public.companies(id) ON DELETE CASCADE NOT NULL,

  -- Carbon Metrics
  carbon_emissions_kg DECIMAL(10,2),
  carbon_offset_kg DECIMAL(10,2),

  -- Waste Metrics
  waste_diverted_kg DECIMAL(10,2),
  waste_recycled_percent DECIMAL(5,2),

  -- Energy Metrics
  energy_saved_kwh DECIMAL(10,2),
  renewable_energy_percent DECIMAL(5,2),

  -- Water Metrics
  water_saved_gallons DECIMAL(10,2),

  -- Calculated Score
  sustainability_score INTEGER CHECK (sustainability_score BETWEEN 0 AND 100),

  -- Tracking
  recorded_date DATE NOT NULL,

  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_sustainability_metrics_project ON public.sustainability_metrics(project_id);
CREATE INDEX idx_sustainability_metrics_company ON public.sustainability_metrics(company_id);

-- ============================================================================
-- 11. REPORT CENTER
-- ============================================================================

-- ----------------------------------------------------------------------------
-- 11.1 Reports Table
-- ----------------------------------------------------------------------------
CREATE TABLE IF NOT EXISTS public.reports (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  company_id UUID REFERENCES public.companies(id) ON DELETE CASCADE NOT NULL,
  project_id UUID REFERENCES public.projects(id) ON DELETE CASCADE,
  created_by UUID REFERENCES auth.users(id),

  -- Report Details
  title TEXT NOT NULL,
  report_type TEXT CHECK (report_type IN ('project_summary', 'financial', 'progress', 'safety', 'custom')) NOT NULL,
  description TEXT,

  -- Data
  data JSONB NOT NULL,
  filters JSONB DEFAULT '{}'::jsonb,

  -- Format
  format TEXT CHECK (format IN ('pdf', 'excel', 'json')) DEFAULT 'pdf',
  file_url TEXT,

  -- Scheduling
  is_scheduled BOOLEAN DEFAULT false,
  schedule_frequency TEXT CHECK (schedule_frequency IN ('daily', 'weekly', 'monthly')),

  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_reports_company ON public.reports(company_id);
CREATE INDEX idx_reports_project ON public.reports(project_id);
CREATE INDEX idx_reports_type ON public.reports(report_type);

-- ============================================================================
-- 12. ACTIVITIES & NOTIFICATIONS
-- ============================================================================

-- ----------------------------------------------------------------------------
-- 12.1 Activities Table
-- ----------------------------------------------------------------------------
CREATE TABLE IF NOT EXISTS public.activities (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  company_id UUID REFERENCES public.companies(id) ON DELETE CASCADE NOT NULL,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,

  -- Activity Details
  type TEXT NOT NULL CHECK (type IN ('project_created', 'project_updated', 'task_completed', 'photo_uploaded', 'quote_sent', 'milestone_reached', 'comment_added')),
  title TEXT NOT NULL,
  description TEXT,

  -- Related Resources
  project_id UUID REFERENCES public.projects(id) ON DELETE CASCADE,
  task_id UUID REFERENCES public.tasks(id) ON DELETE CASCADE,
  metadata JSONB DEFAULT '{}'::jsonb,

  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_activities_company ON public.activities(company_id);
CREATE INDEX idx_activities_user ON public.activities(user_id);
CREATE INDEX idx_activities_created_at ON public.activities(created_at DESC);

-- ----------------------------------------------------------------------------
-- 12.2 Notifications Table
-- ----------------------------------------------------------------------------
CREATE TABLE IF NOT EXISTS public.notifications (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
  company_id UUID REFERENCES public.companies(id) ON DELETE CASCADE NOT NULL,

  -- Notification Content
  type TEXT CHECK (type IN ('info', 'success', 'warning', 'error', 'task_assignment', 'quote_update', 'comment_mention')) DEFAULT 'info',
  title TEXT NOT NULL,
  message TEXT NOT NULL,

  -- Action
  link TEXT,
  action_url TEXT,

  -- Status
  read BOOLEAN DEFAULT false,
  read_at TIMESTAMPTZ,

  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_notifications_user ON public.notifications(user_id);
CREATE INDEX idx_notifications_company ON public.notifications(company_id);
CREATE INDEX idx_notifications_read ON public.notifications(user_id, read) WHERE read = false;
CREATE INDEX idx_notifications_created_at ON public.notifications(created_at DESC);

-- ============================================================================
-- 13. STORAGE CONFIGURATION
-- ============================================================================

-- Storage buckets need to be created via Supabase Dashboard:
-- 1. photos - Private bucket for project photos
-- 2. avatars - Public bucket for user avatars
-- 3. documents - Private bucket for project documents
-- 4. media - Private bucket for general media assets

-- ============================================================================
-- 14. TRIGGERS & FUNCTIONS
-- ============================================================================

-- ----------------------------------------------------------------------------
-- 14.1 Updated At Trigger Function
-- ----------------------------------------------------------------------------
CREATE OR REPLACE FUNCTION public.update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Apply to all tables with updated_at column
CREATE TRIGGER update_companies_updated_at BEFORE UPDATE ON public.companies
  FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();

CREATE TRIGGER update_user_profiles_updated_at BEFORE UPDATE ON public.user_profiles
  FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();

CREATE TRIGGER update_projects_updated_at BEFORE UPDATE ON public.projects
  FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();

CREATE TRIGGER update_project_expenses_updated_at BEFORE UPDATE ON public.project_expenses
  FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();

CREATE TRIGGER update_tasks_updated_at BEFORE UPDATE ON public.tasks
  FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();

CREATE TRIGGER update_task_comments_updated_at BEFORE UPDATE ON public.task_comments
  FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();

CREATE TRIGGER update_media_assets_updated_at BEFORE UPDATE ON public.media_assets
  FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();

CREATE TRIGGER update_photo_annotations_updated_at BEFORE UPDATE ON public.photo_annotations
  FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();

CREATE TRIGGER update_quotes_updated_at BEFORE UPDATE ON public.quotes
  FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();

CREATE TRIGGER update_crm_contacts_updated_at BEFORE UPDATE ON public.crm_contacts
  FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();

CREATE TRIGGER update_crm_deals_updated_at BEFORE UPDATE ON public.crm_deals
  FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();

CREATE TRIGGER update_teams_updated_at BEFORE UPDATE ON public.teams
  FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();

CREATE TRIGGER update_punch_list_items_updated_at BEFORE UPDATE ON public.punch_list_items
  FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();

CREATE TRIGGER update_sustainability_metrics_updated_at BEFORE UPDATE ON public.sustainability_metrics
  FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();

CREATE TRIGGER update_reports_updated_at BEFORE UPDATE ON public.reports
  FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();

-- ----------------------------------------------------------------------------
-- 14.2 Auto-Create User Profile on Signup
-- ----------------------------------------------------------------------------
CREATE OR REPLACE FUNCTION public.handle_new_user()
RETURNS TRIGGER AS $$
DECLARE
  new_company_id UUID;
BEGIN
  -- Create a new company for the user (owner)
  INSERT INTO public.companies (name, subscription_tier, subscription_status)
  VALUES (
    COALESCE(NEW.raw_user_meta_data->>'company_name', 'My Company'),
    'starter',
    'trial'
  )
  RETURNING id INTO new_company_id;

  -- Create user profile linked to the new company
  INSERT INTO public.user_profiles (
    id,
    company_id,
    email,
    full_name,
    role,
    subscription_tier
  )
  VALUES (
    NEW.id,
    new_company_id,
    NEW.email,
    COALESCE(NEW.raw_user_meta_data->>'full_name', ''),
    'owner', -- First user is always owner
    'starter'
  );

  RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Trigger to create profile on signup
DROP TRIGGER IF EXISTS on_auth_user_created ON auth.users;
CREATE TRIGGER on_auth_user_created
  AFTER INSERT ON auth.users
  FOR EACH ROW EXECUTE FUNCTION public.handle_new_user();

-- ----------------------------------------------------------------------------
-- 14.3 Quote Number Generator
-- ----------------------------------------------------------------------------
CREATE OR REPLACE FUNCTION public.generate_quote_number()
RETURNS TRIGGER AS $$
DECLARE
  year TEXT;
  count INTEGER;
  new_number TEXT;
BEGIN
  year := TO_CHAR(NOW(), 'YYYY');

  SELECT COUNT(*) + 1 INTO count
  FROM public.quotes
  WHERE company_id = NEW.company_id
    AND EXTRACT(YEAR FROM created_at) = EXTRACT(YEAR FROM NOW());

  new_number := 'Q-' || year || '-' || LPAD(count::TEXT, 4, '0');
  NEW.quote_number := new_number;

  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER generate_quote_number_trigger
  BEFORE INSERT ON public.quotes
  FOR EACH ROW
  WHEN (NEW.quote_number IS NULL)
  EXECUTE FUNCTION public.generate_quote_number();

-- ============================================================================
-- 15. PERFORMANCE INDEXES (Additional)
-- ============================================================================

-- Composite indexes for common queries
CREATE INDEX idx_tasks_company_status ON public.tasks(company_id, status);
CREATE INDEX idx_tasks_project_status ON public.tasks(project_id, status);
CREATE INDEX idx_media_assets_company_project ON public.media_assets(company_id, project_id);
CREATE INDEX idx_quotes_company_status ON public.quotes(company_id, status);
CREATE INDEX idx_crm_contacts_company_type ON public.crm_contacts(company_id, type);

-- ============================================================================
-- SCHEMA DEPLOYMENT COMPLETE
-- ============================================================================

-- To verify deployment, run these queries:
-- SELECT tablename FROM pg_tables WHERE schemaname = 'public' ORDER BY tablename;
-- SELECT COUNT(*) as total_tables FROM pg_tables WHERE schemaname = 'public';


#21
-- ============================================================================
-- ADD MISSING COLUMNS TO EXISTING TABLES
-- ============================================================================
-- This migration adds any missing columns to existing tables
-- Safe to run multiple times - only adds columns that don't exist
-- ============================================================================

-- Add company_id to user_profiles if it doesn't exist
DO $$
BEGIN
  IF NOT EXISTS (
    SELECT 1 FROM information_schema.columns
    WHERE table_schema = 'public'
    AND table_name = 'user_profiles'
    AND column_name = 'company_id'
  ) THEN
    ALTER TABLE public.user_profiles ADD COLUMN company_id UUID REFERENCES public.companies(id) ON DELETE CASCADE;
    CREATE INDEX IF NOT EXISTS idx_user_profiles_company ON public.user_profiles(company_id);
  END IF;
END$$;

-- Add full_name if it doesn't exist
DO $$
BEGIN
  IF NOT EXISTS (
    SELECT 1 FROM information_schema.columns
    WHERE table_schema = 'public'
    AND table_name = 'user_profiles'
    AND column_name = 'full_name'
  ) THEN
    ALTER TABLE public.user_profiles ADD COLUMN full_name TEXT;
  END IF;
END$$;

-- Add name column to user_profiles if it doesn't exist (some code uses 'name' instead of 'full_name')
DO $$
BEGIN
  IF NOT EXISTS (
    SELECT 1 FROM information_schema.columns
    WHERE table_schema = 'public'
    AND table_name = 'user_profiles'
    AND column_name = 'name'
  ) THEN
    ALTER TABLE public.user_profiles ADD COLUMN name TEXT;
  END IF;
END$$;

-- Sync name and full_name columns if both exist
DO $$
BEGIN
  -- If both columns exist, copy name to full_name where full_name is null
  IF EXISTS (
    SELECT 1 FROM information_schema.columns
    WHERE table_schema = 'public'
    AND table_name = 'user_profiles'
    AND column_name = 'name'
  ) AND EXISTS (
    SELECT 1 FROM information_schema.columns
    WHERE table_schema = 'public'
    AND table_name = 'user_profiles'
    AND column_name = 'full_name'
  ) THEN
    UPDATE public.user_profiles
    SET full_name = name
    WHERE full_name IS NULL AND name IS NOT NULL;

    UPDATE public.user_profiles
    SET name = full_name
    WHERE name IS NULL AND full_name IS NOT NULL;
  END IF;
END$$;

-- Add is_active if it doesn't exist
DO $$
BEGIN
  IF NOT EXISTS (
    SELECT 1 FROM information_schema.columns
    WHERE table_schema = 'public'
    AND table_name = 'user_profiles'
    AND column_name = 'is_active'
  ) THEN
    ALTER TABLE public.user_profiles ADD COLUMN is_active BOOLEAN DEFAULT true;
  END IF;
END$$;

-- Verify the changes
SELECT
  column_name,
  data_type,
  is_nullable
FROM information_schema.columns
WHERE table_schema = 'public'
  AND table_name = 'user_profiles'
ORDER BY ordinal_position;


#23

==========================================================================
-- CREATE COMPANIES TABLE FIRST
-- ============================================================================
-- This must run BEFORE any other migrations
-- Creates the companies table that other tables depend on
-- ============================================================================

-- Create companies table
CREATE TABLE IF NOT EXISTS public.companies (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name TEXT NOT NULL,
  industry TEXT,
  size TEXT CHECK (size IN ('solo', 'small', 'medium', 'large')),
  website TEXT,
  address JSONB,
  phone TEXT,
  email TEXT,
  logo_url TEXT,
  subscription_tier TEXT CHECK (subscription_tier IN ('starter', 'professional', 'enterprise')) DEFAULT 'starter',
  subscription_status TEXT CHECK (subscription_status IN ('trial', 'active', 'past_due', 'canceled')) DEFAULT 'trial',
  trial_ends_at TIMESTAMPTZ,
  stripe_customer_id TEXT UNIQUE,
  stripe_subscription_id TEXT,
  settings JSONB DEFAULT '{}'::jsonb,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_companies_subscription ON public.companies(subscription_tier, subscription_status);
CREATE INDEX IF NOT EXISTS idx_companies_stripe ON public.companies(stripe_customer_id);

-- Create a default company if none exists
INSERT INTO public.companies (name, subscription_tier, subscription_status)
SELECT 'Default Company', 'starter', 'trial'
WHERE NOT EXISTS (SELECT 1 FROM public.companies LIMIT 1);

-- Show created company
SELECT id, name, subscription_tier, created_at FROM public.companies;


#24

=========================================
-- MODULE 10: TEAMS & RBAC - FINAL VERSION
-- ============================================
-- Created: February 9, 2026
-- Fixed: February 10, 2026 - Removed function calls from index predicates
-- ============================================

BEGIN;

-- ============================================
-- TABLES
-- ============================================

CREATE TABLE IF NOT EXISTS custom_roles (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  company_id UUID REFERENCES companies(id) ON DELETE CASCADE,
  role_name VARCHAR(100) NOT NULL,
  role_slug VARCHAR(100) NOT NULL,
  description TEXT,
  color VARCHAR(7) NOT NULL DEFAULT '#6B7280',
  icon VARCHAR(10) DEFAULT '',
  permissions JSONB NOT NULL DEFAULT '{}'::jsonb,
  is_active BOOLEAN DEFAULT true,
  is_system_role BOOLEAN DEFAULT false,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  created_by UUID REFERENCES auth.users(id),
  UNIQUE(company_id, role_slug),
  CHECK (role_name != ''),
  CHECK (LENGTH(color) = 7 AND color ~ '^#[0-9A-Fa-f]{6}$'),
  CHECK (is_system_role = false OR company_id IS NULL)
);

CREATE INDEX IF NOT EXISTS idx_custom_roles_company ON custom_roles(company_id);
CREATE INDEX IF NOT EXISTS idx_custom_roles_slug ON custom_roles(company_id, role_slug);
CREATE INDEX IF NOT EXISTS idx_custom_roles_active ON custom_roles(is_active);

CREATE TABLE IF NOT EXISTS user_role_assignments (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  role_id UUID NOT NULL REFERENCES custom_roles(id) ON DELETE CASCADE,
  company_id UUID NOT NULL REFERENCES companies(id) ON DELETE CASCADE,
  project_ids UUID[],
  expires_at TIMESTAMPTZ,
  assigned_by UUID REFERENCES auth.users(id),
  assigned_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  assignment_reason TEXT,
  UNIQUE(user_id, role_id, company_id)
);

CREATE INDEX IF NOT EXISTS idx_user_role_assignments_user ON user_role_assignments(user_id);
CREATE INDEX IF NOT EXISTS idx_user_role_assignments_role ON user_role_assignments(role_id);
CREATE INDEX IF NOT EXISTS idx_user_role_assignments_company ON user_role_assignments(company_id);
CREATE INDEX IF NOT EXISTS idx_user_role_assignments_expires ON user_role_assignments(expires_at);

CREATE TABLE IF NOT EXISTS project_team_members (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  project_id UUID NOT NULL REFERENCES projects(id) ON DELETE CASCADE,
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  company_id UUID NOT NULL REFERENCES companies(id) ON DELETE CASCADE,
  project_role TEXT,
  custom_permissions JSONB DEFAULT NULL,
  added_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  added_by UUID REFERENCES auth.users(id),
  UNIQUE(project_id, user_id)
);

CREATE INDEX IF NOT EXISTS idx_project_team_members_project ON project_team_members(project_id);
CREATE INDEX IF NOT EXISTS idx_project_team_members_user ON project_team_members(user_id);
CREATE INDEX IF NOT EXISTS idx_project_team_members_company ON project_team_members(company_id);

CREATE TABLE IF NOT EXISTS audit_logs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  company_id UUID NOT NULL REFERENCES companies(id) ON DELETE CASCADE,
  user_id UUID NOT NULL REFERENCES auth.users(id),
  user_name VARCHAR(255) NOT NULL,
  user_email VARCHAR(255) NOT NULL,
  user_role VARCHAR(100),
  timestamp TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  action TEXT NOT NULL,
  entity_type TEXT NOT NULL,
  entity_id UUID,
  entity_name TEXT,
  old_values JSONB,
  new_values JSONB,
  changes JSONB,
  reason TEXT,
  ip_address INET,
  user_agent TEXT,
  session_id UUID,
  request_id UUID,
  is_critical BOOLEAN DEFAULT false,
  requires_approval BOOLEAN DEFAULT false,
  approved_by UUID REFERENCES auth.users(id),
  approved_at TIMESTAMPTZ,
  approval_reason TEXT,
  retention_period INTERVAL DEFAULT INTERVAL '7 years',
  can_be_deleted BOOLEAN DEFAULT false,
  CHECK (action IN ('create', 'update', 'delete', 'view', 'export', 'approve', 'reject')),
  CHECK (entity_type != '')
);

CREATE INDEX IF NOT EXISTS idx_audit_logs_company_time ON audit_logs(company_id, timestamp DESC);
CREATE INDEX IF NOT EXISTS idx_audit_logs_user_time ON audit_logs(user_id, timestamp DESC);
CREATE INDEX IF NOT EXISTS idx_audit_logs_entity ON audit_logs(entity_type, entity_id, timestamp DESC);
CREATE INDEX IF NOT EXISTS idx_audit_logs_critical ON audit_logs(company_id, is_critical, timestamp DESC);

CREATE TABLE IF NOT EXISTS team_invitations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  company_id UUID NOT NULL REFERENCES companies(id) ON DELETE CASCADE,
  email VARCHAR(255) NOT NULL,
  name VARCHAR(255),
  role_id UUID NOT NULL REFERENCES custom_roles(id) ON DELETE CASCADE,
  project_ids UUID[],
  invitation_token VARCHAR(255) NOT NULL UNIQUE,
  invited_by UUID NOT NULL REFERENCES auth.users(id),
  invited_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  expires_at TIMESTAMPTZ NOT NULL DEFAULT (NOW() + INTERVAL '7 days'),
  status VARCHAR(20) NOT NULL DEFAULT 'pending',
  accepted_at TIMESTAMPTZ,
  accepted_by UUID REFERENCES auth.users(id),
  onboarding_completed BOOLEAN DEFAULT false,
  onboarding_buddy UUID REFERENCES auth.users(id),
  UNIQUE(company_id, email, status)
);

CREATE INDEX IF NOT EXISTS idx_team_invitations_company ON team_invitations(company_id);
CREATE INDEX IF NOT EXISTS idx_team_invitations_email ON team_invitations(email);
CREATE INDEX IF NOT EXISTS idx_team_invitations_token ON team_invitations(invitation_token);
CREATE INDEX IF NOT EXISTS idx_team_invitations_status ON team_invitations(company_id, status);
CREATE INDEX IF NOT EXISTS idx_team_invitations_expires ON team_invitations(expires_at);

-- ============================================
-- FUNCTIONS
-- ============================================

CREATE OR REPLACE FUNCTION user_has_permission(
  p_user_id UUID,
  p_company_id UUID,
  p_permission_name TEXT
)
RETURNS BOOLEAN
LANGUAGE plpgsql
SECURITY DEFINER
STABLE
AS $$
DECLARE
  v_has_permission BOOLEAN;
BEGIN
  SELECT EXISTS(
    SELECT 1
    FROM user_role_assignments ura
    JOIN custom_roles cr ON cr.id = ura.role_id
    WHERE ura.user_id = p_user_id
    AND ura.company_id = p_company_id
    AND cr.is_active = true
    AND (ura.expires_at IS NULL OR ura.expires_at > NOW())
    AND (cr.permissions->>p_permission_name)::boolean = true
  ) INTO v_has_permission;

  RETURN v_has_permission;
END;
$$;

CREATE OR REPLACE FUNCTION get_user_highest_role(
  p_user_id UUID,
  p_company_id UUID DEFAULT NULL
)
RETURNS VARCHAR(100)
LANGUAGE plpgsql
SECURITY DEFINER
STABLE
AS $$
DECLARE
  v_role_name VARCHAR(100);
  v_company_id UUID;
BEGIN
  IF p_company_id IS NULL THEN
    SELECT company_id INTO v_company_id
    FROM user_profiles
    WHERE id = p_user_id
    LIMIT 1;
  ELSE
    v_company_id := p_company_id;
  END IF;

  SELECT cr.role_name INTO v_role_name
  FROM user_role_assignments ura
  JOIN custom_roles cr ON cr.id = ura.role_id
  WHERE ura.user_id = p_user_id
  AND ura.company_id = v_company_id
  AND cr.is_active = true
  AND (ura.expires_at IS NULL OR ura.expires_at > NOW())
  ORDER BY
    CASE cr.role_slug
      WHEN 'admin' THEN 1
      WHEN 'project_manager' THEN 2
      WHEN 'superintendent' THEN 3
      WHEN 'accountant' THEN 4
      WHEN 'field_engineer' THEN 5
      WHEN 'subcontractor' THEN 6
      WHEN 'viewer' THEN 7
      ELSE 8
    END
  LIMIT 1;

  RETURN COALESCE(v_role_name, 'viewer');
END;
$$;

CREATE OR REPLACE FUNCTION get_user_permissions(
  p_user_id UUID,
  p_company_id UUID
)
RETURNS JSONB
LANGUAGE plpgsql
SECURITY DEFINER
STABLE
AS $$
DECLARE
  v_permissions JSONB := '{}'::jsonb;
  v_role RECORD;
BEGIN
  FOR v_role IN
    SELECT cr.permissions
    FROM user_role_assignments ura
    JOIN custom_roles cr ON cr.id = ura.role_id
    WHERE ura.user_id = p_user_id
    AND ura.company_id = p_company_id
    AND cr.is_active = true
    AND (ura.expires_at IS NULL OR ura.expires_at > NOW())
  LOOP
    SELECT jsonb_object_agg(
      key,
      COALESCE((v_permissions->>key)::boolean, false) OR COALESCE((v_role.permissions->>key)::boolean, false)
    )
    INTO v_permissions
    FROM jsonb_object_keys(v_role.permissions) AS key;
  END LOOP;

  RETURN v_permissions;
END;
$$;

CREATE OR REPLACE FUNCTION create_audit_log(
  p_user_id UUID,
  p_company_id UUID,
  p_action TEXT,
  p_entity_type TEXT,
  p_entity_id UUID,
  p_entity_name TEXT DEFAULT NULL,
  p_old_values JSONB DEFAULT NULL,
  p_new_values JSONB DEFAULT NULL,
  p_reason TEXT DEFAULT NULL,
  p_ip_address INET DEFAULT NULL,
  p_user_agent TEXT DEFAULT NULL
)
RETURNS UUID
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
  v_log_id UUID;
  v_user_info RECORD;
  v_changes JSONB;
  v_is_critical BOOLEAN := false;
BEGIN
  SELECT
    COALESCE(up.name, up.full_name) as name,
    up.email,
    get_user_highest_role(up.id, p_company_id) AS role_name
  INTO v_user_info
  FROM user_profiles up
  WHERE up.id = p_user_id;

  IF p_old_values IS NOT NULL AND p_new_values IS NOT NULL THEN
    SELECT jsonb_object_agg(key, value)
    INTO v_changes
    FROM jsonb_each(p_new_values)
    WHERE value != COALESCE(p_old_values->key, 'null'::jsonb);
  END IF;

  v_is_critical := (
    p_action = 'delete'
    OR p_entity_type IN ('role', 'user', 'company_settings')
  );

  INSERT INTO audit_logs (
    company_id, user_id, user_name, user_email, user_role,
    action, entity_type, entity_id, entity_name,
    old_values, new_values, changes, reason,
    ip_address, user_agent, is_critical
  )
  VALUES (
    p_company_id, p_user_id,
    COALESCE(v_user_info.name, 'Unknown'),
    COALESCE(v_user_info.email, 'unknown@example.com'),
    v_user_info.role_name,
    p_action, p_entity_type, p_entity_id, p_entity_name,
    p_old_values, p_new_values, v_changes, p_reason,
    p_ip_address, p_user_agent, v_is_critical
  )
  RETURNING id INTO v_log_id;

  RETURN v_log_id;
END;
$$;

CREATE OR REPLACE FUNCTION get_role_member_count(
  p_role_id UUID
)
RETURNS INTEGER
LANGUAGE sql
SECURITY DEFINER
STABLE
AS $$
  SELECT COUNT(*)::integer
  FROM user_role_assignments
  WHERE role_id = p_role_id
  AND (expires_at IS NULL OR expires_at > NOW());
$$;

-- ============================================
-- TRIGGERS
-- ============================================

DO $$
BEGIN
  IF NOT EXISTS (SELECT 1 FROM pg_trigger WHERE tgname = 'update_custom_roles_updated_at') THEN
    CREATE TRIGGER update_custom_roles_updated_at
      BEFORE UPDATE ON custom_roles
      FOR EACH ROW
      EXECUTE FUNCTION update_updated_at_column();
  END IF;
END$$;

-- ============================================
-- ROW LEVEL SECURITY
-- ============================================

ALTER TABLE custom_roles ENABLE ROW LEVEL SECURITY;
ALTER TABLE user_role_assignments ENABLE ROW LEVEL SECURITY;
ALTER TABLE project_team_members ENABLE ROW LEVEL SECURITY;
ALTER TABLE audit_logs ENABLE ROW LEVEL SECURITY;
ALTER TABLE team_invitations ENABLE ROW LEVEL SECURITY;

DROP POLICY IF EXISTS "Users can view company roles" ON custom_roles;
CREATE POLICY "Users can view company roles"
  ON custom_roles FOR SELECT
  TO authenticated
  USING (
    is_system_role = true
    OR company_id IS NULL
    OR company_id IN (SELECT company_id FROM user_profiles WHERE id = auth.uid())
  );

DROP POLICY IF EXISTS "Admins can manage custom roles" ON custom_roles;
CREATE POLICY "Admins can manage custom roles"
  ON custom_roles FOR ALL
  TO authenticated
  USING (
    company_id IN (SELECT company_id FROM user_profiles WHERE id = auth.uid())
  );

DROP POLICY IF EXISTS "Users can view role assignments" ON user_role_assignments;
CREATE POLICY "Users can view role assignments"
  ON user_role_assignments FOR SELECT
  TO authenticated
  USING (
    company_id IN (SELECT company_id FROM user_profiles WHERE id = auth.uid())
  );

DROP POLICY IF EXISTS "Admins can manage role assignments" ON user_role_assignments;
CREATE POLICY "Admins can manage role assignments"
  ON user_role_assignments FOR ALL
  TO authenticated
  USING (
    company_id IN (SELECT company_id FROM user_profiles WHERE id = auth.uid())
  );

DROP POLICY IF EXISTS "Users can view project team members" ON project_team_members;
CREATE POLICY "Users can view project team members"
  ON project_team_members FOR SELECT
  TO authenticated
  USING (
    company_id IN (SELECT company_id FROM user_profiles WHERE id = auth.uid())
  );

DROP POLICY IF EXISTS "Project managers can manage team members" ON project_team_members;
CREATE POLICY "Project managers can manage team members"
  ON project_team_members FOR ALL
  TO authenticated
  USING (
    company_id IN (SELECT company_id FROM user_profiles WHERE id = auth.uid())
  );

DROP POLICY IF EXISTS "Users can view company audit logs" ON audit_logs;
CREATE POLICY "Users can view company audit logs"
  ON audit_logs FOR SELECT
  TO authenticated
  USING (
    company_id IN (SELECT company_id FROM user_profiles WHERE id = auth.uid())
  );

DROP POLICY IF EXISTS "Audit logs are immutable" ON audit_logs;
CREATE POLICY "Audit logs are immutable"
  ON audit_logs FOR UPDATE
  TO authenticated
  USING (false);

DROP POLICY IF EXISTS "Audit logs cannot be deleted" ON audit_logs;
CREATE POLICY "Audit logs cannot be deleted"
  ON audit_logs FOR DELETE
  TO authenticated
  USING (false);

DROP POLICY IF EXISTS "Users can view team invitations" ON team_invitations;
CREATE POLICY "Users can view team invitations"
  ON team_invitations FOR SELECT
  TO authenticated
  USING (
    company_id IN (SELECT company_id FROM user_profiles WHERE id = auth.uid())
  );

DROP POLICY IF EXISTS "Admins can manage invitations" ON team_invitations;
CREATE POLICY "Admins can manage invitations"
  ON team_invitations FOR ALL
  TO authenticated
  USING (
    company_id IN (SELECT company_id FROM user_profiles WHERE id = auth.uid())
  );

-- ============================================
-- SEED DATA: 7 System Roles
-- ============================================

INSERT INTO custom_roles (role_name, role_slug, description, color, icon, is_system_role, permissions) VALUES
('Admin', 'admin', 'Full system access - company owner', '#7C3AED', '', true, '{"canViewAllProjects":true,"canEditProjects":true,"canDeleteProjects":true,"canCreateProjects":true,"canManageTeam":true,"canInviteMembers":true,"canRemoveMembers":true,"canChangeRoles":true,"canViewAllPhotos":true,"canUploadPhotos":true,"canDeletePhotos":true,"canSharePhotos":true,"canEditPhotoMetadata":true,"canViewAnalytics":true,"canExportData":true,"canViewReports":true,"canManageAI":true,"canRunAIAnalysis":true,"canViewAIInsights":true,"canManageTasks":true,"canAssignTasks":true,"canViewAllTasks":true,"canManagePunchList":true,"canResolvePunchItems":true,"canViewPunchList":true,"canManageFinances":true,"canApproveExpenses":true,"canViewFinancials":true,"canUploadDocuments":true,"canDeleteDocuments":true,"canShareDocuments":true,"canManageCompanySettings":true,"canManageIntegrations":true}'::jsonb),
('Superintendent', 'superintendent', 'Oversee field operations and crews', '#1E40AF', '', true, '{"canViewAllProjects":false,"canEditProjects":false,"canDeleteProjects":false,"canCreateProjects":false,"canManageTeam":false,"canInviteMembers":false,"canRemoveMembers":false,"canChangeRoles":false,"canViewAllPhotos":true,"canUploadPhotos":true,"canDeletePhotos":false,"canSharePhotos":true,"canEditPhotoMetadata":true,"canViewAnalytics":false,"canExportData":false,"canViewReports":false,"canManageAI":false,"canRunAIAnalysis":false,"canViewAIInsights":false,"canManageTasks":true,"canAssignTasks":true,"canViewAllTasks":true,"canManagePunchList":true,"canResolvePunchItems":true,"canViewPunchList":true,"canManageFinances":false,"canApproveExpenses":false,"canViewFinancials":false,"canUploadDocuments":true,"canDeleteDocuments":false,"canShareDocuments":false,"canManageCompanySettings":false,"canManageIntegrations":false}'::jsonb),
('Project Manager', 'project_manager', 'Manage projects and budgets', '#047857', '', true, '{"canViewAllProjects":true,"canEditProjects":true,"canDeleteProjects":false,"canCreateProjects":true,"canManageTeam":false,"canInviteMembers":false,"canRemoveMembers":false,"canChangeRoles":false,"canViewAllPhotos":true,"canUploadPhotos":true,"canDeletePhotos":true,"canSharePhotos":true,"canEditPhotoMetadata":true,"canViewAnalytics":true,"canExportData":true,"canViewReports":true,"canManageAI":true,"canRunAIAnalysis":true,"canViewAIInsights":true,"canManageTasks":true,"canAssignTasks":true,"canViewAllTasks":true,"canManagePunchList":true,"canResolvePunchItems":true,"canViewPunchList":true,"canManageFinances":true,"canApproveExpenses":true,"canViewFinancials":true,"canUploadDocuments":true,"canDeleteDocuments":true,"canShareDocuments":true,"canManageCompanySettings":false,"canManageIntegrations":false}'::jsonb),
('Field Engineer', 'field_engineer', 'Technical field work and coordination', '#C2410C', '', true, '{"canViewAllProjects":false,"canEditProjects":false,"canDeleteProjects":false,"canCreateProjects":false,"canManageTeam":false,"canInviteMembers":false,"canRemoveMembers":false,"canChangeRoles":false,"canViewAllPhotos":false,"canUploadPhotos":true,"canDeletePhotos":false,"canSharePhotos":false,"canEditPhotoMetadata":false,"canViewAnalytics":false,"canExportData":false,"canViewReports":false,"canManageAI":false,"canRunAIAnalysis":false,"canViewAIInsights":false,"canManageTasks":false,"canAssignTasks":false,"canViewAllTasks":false,"canManagePunchList":true,"canResolvePunchItems":false,"canViewPunchList":true,"canManageFinances":false,"canApproveExpenses":false,"canViewFinancials":false,"canUploadDocuments":true,"canDeleteDocuments":false,"canShareDocuments":false,"canManageCompanySettings":false,"canManageIntegrations":false}'::jsonb),
('Viewer', 'viewer', 'View-only access for clients', '#4B5563', '', true, '{"canViewAllProjects":false,"canEditProjects":false,"canDeleteProjects":false,"canCreateProjects":false,"canManageTeam":false,"canInviteMembers":false,"canRemoveMembers":false,"canChangeRoles":false,"canViewAllPhotos":false,"canUploadPhotos":false,"canDeletePhotos":false,"canSharePhotos":false,"canEditPhotoMetadata":false,"canViewAnalytics":false,"canExportData":false,"canViewReports":false,"canManageAI":false,"canRunAIAnalysis":false,"canViewAIInsights":false,"canManageTasks":false,"canAssignTasks":false,"canViewAllTasks":false,"canManagePunchList":false,"canResolvePunchItems":false,"canViewPunchList":false,"canManageFinances":false,"canApproveExpenses":false,"canViewFinancials":false,"canUploadDocuments":false,"canDeleteDocuments":false,"canShareDocuments":false,"canManageCompanySettings":false,"canManageIntegrations":false}'::jsonb),
('Accountant', 'accountant', 'Financial management and reporting', '#B45309', '', true, '{"canViewAllProjects":true,"canEditProjects":false,"canDeleteProjects":false,"canCreateProjects":false,"canManageTeam":false,"canInviteMembers":false,"canRemoveMembers":false,"canChangeRoles":false,"canViewAllPhotos":false,"canUploadPhotos":false,"canDeletePhotos":false,"canSharePhotos":false,"canEditPhotoMetadata":false,"canViewAnalytics":true,"canExportData":true,"canViewReports":true,"canManageAI":false,"canRunAIAnalysis":false,"canViewAIInsights":false,"canManageTasks":false,"canAssignTasks":false,"canViewAllTasks":false,"canManagePunchList":false,"canResolvePunchItems":false,"canViewPunchList":false,"canManageFinances":true,"canApproveExpenses":true,"canViewFinancials":true,"canUploadDocuments":true,"canDeleteDocuments":false,"canShareDocuments":true,"canManageCompanySettings":false,"canManageIntegrations":false}'::jsonb),
('Subcontractor', 'subcontractor', 'External contractor - limited access', '#4338CA', '', true, '{"canViewAllProjects":false,"canEditProjects":false,"canDeleteProjects":false,"canCreateProjects":false,"canManageTeam":false,"canInviteMembers":false,"canRemoveMembers":false,"canChangeRoles":false,"canViewAllPhotos":false,"canUploadPhotos":true,"canDeletePhotos":false,"canSharePhotos":false,"canEditPhotoMetadata":false,"canViewAnalytics":false,"canExportData":false,"canViewReports":false,"canManageAI":false,"canRunAIAnalysis":false,"canViewAIInsights":false,"canManageTasks":false,"canAssignTasks":false,"canViewAllTasks":false,"canManagePunchList":true,"canResolvePunchItems":false,"canViewPunchList":true,"canManageFinances":false,"canApproveExpenses":false,"canViewFinancials":false,"canUploadDocuments":true,"canDeleteDocuments":false,"canShareDocuments":false,"canManageCompanySettings":false,"canManageIntegrations":false}'::jsonb)
ON CONFLICT DO NOTHING;

COMMIT;

-- ============================================
-- SUCCESS!
-- ============================================
SELECT 'Module 10 deployed successfully!' as message,
       COUNT(*) as roles_created
FROM custom_roles
WHERE is_system_role = true;
